@page "/settings"
@rendermode InteractiveServer
@using YouTubeShortsWebApp
@using YouTubeShortsWebApp.Services
@inject UserSettingsService UserSettings

<PageTitle>ì„¤ì •</PageTitle>

<h1>âš™ï¸ ì„¤ì •</h1>

<div class="container">
    <div class="row">
        <div class="col-md-8">

            <!-- Replicate API ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>ğŸ¤– Replicate API ì„¤ì •</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>API í‚¤:</strong></label>
                        <div class="input-group">
                            <input type="@(showApiKey ? "text" : "password")" class="form-control" @bind="replicateApiKey" placeholder="r8_..." />
                            <button type="button" class="btn btn-outline-secondary" @onclick="ToggleApiKeyVisibility">
                                @(showApiKey ? "ìˆ¨ê¸°ê¸°" : "ë³´ê¸°")
                            </button>
                        </div>
                        <div class="form-text">
                            <a href="https://replicate.com/account/api-tokens" target="_blank">Replicate.com</a>ì—ì„œ API í† í°ì„ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.
                        </div>
                    </div>
                </div>
            </div>

            <!-- ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>ğŸ“ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì„¤ì •</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>ê¸°ë³¸ í”„ë¡¬í”„íŠ¸:</strong></label>
                        <textarea class="form-control" rows="4" @bind="basePrompt"
                                  placeholder="ëª¨ë“  ì˜ìƒ ìƒì„±ì— ê¸°ë³¸ì ìœ¼ë¡œ í¬í•¨ë  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <div class="form-text">
                            ì˜ˆ: "8k uhd, professional cinematic lighting, high quality" ë“±ì˜ í™”ì§ˆ/ìŠ¤íƒ€ì¼ ê´€ë ¨ ë‚´ìš©
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(basePrompt))
                    {
                        <div class="alert alert-info">
                            <strong>ë¯¸ë¦¬ë³´ê¸°:</strong> "@basePrompt"
                        </div>
                    }
                </div>
            </div>

            <!-- YouTube API ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>ğŸ“º YouTube API ì„¤ì •</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>í´ë¼ì´ì–¸íŠ¸ ID:</strong></label>
                        <input type="text" class="form-control" @bind="youtubeClientId" placeholder="Google Cloud Consoleì—ì„œ ë°œê¸‰ë°›ì€ í´ë¼ì´ì–¸íŠ¸ ID" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿:</strong></label>
                        <input type="password" class="form-control" @bind="youtubeClientSecret" placeholder="Google Cloud Consoleì—ì„œ ë°œê¸‰ë°›ì€ í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿" />
                    </div>
                    <div class="form-text">
                        <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a>ì—ì„œ YouTube Data API v3ë¥¼ í™œì„±í™”í•˜ê³  OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ IDë¥¼ ìƒì„±í•˜ì„¸ìš”.
                    </div>
                </div>
            </div>

            <!-- êµ¬ë¶„ì„  -->
            <div class="mt-4 mb-3">
                <hr />
            </div>

            <!-- FFmpeg ì‹œìŠ¤í…œ í™•ì¸ ì„¹ì…˜ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>ğŸ› ï¸ ì‹œìŠ¤í…œ í™•ì¸</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>FFmpeg ìƒíƒœ (ì˜ìƒ í›„ì²˜ë¦¬ìš©):</strong></label>
                        <div class="d-flex align-items-center">
                            <button type="button" class="btn btn-outline-primary me-3" @onclick="TestFFmpeg" disabled="@isTestingFFmpeg">
                                @if (isTestingFFmpeg)
                                {
                                    <span>í…ŒìŠ¤íŠ¸ ì¤‘...</span>
                                }
                                else
                                {
                                    <span>FFmpeg í…ŒìŠ¤íŠ¸</span>
                                }
                            </button>
                            <span class="@ffmpegStatusClass">@ffmpegStatusMessage</span>
                        </div>
                        <div class="form-text mt-2">
                            FFmpegê°€ í•„ìš”í•œ ê¸°ëŠ¥: ìº¡ì…˜ ì¶”ê°€, ë°°ê²½ìŒì•… ì¶”ê°€
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì €ì¥ ë²„íŠ¼ -->
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-success btn-lg" @onclick="SaveSettings" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span>ì €ì¥ ì¤‘...</span>
                    }
                    else
                    {
                        <span>ì„¤ì • ì €ì¥</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(saveMessage))
            {
                <div class="mt-3 alert @saveMessageClass">
                    @saveMessage
                </div>
            }

        </div>
    </div>
</div>

@code {
    // API ì„¤ì •
    private string replicateApiKey = "";
    private string youtubeClientId = "";
    private string youtubeClientSecret = "";
    private string basePrompt = "";

    // UI ìƒíƒœ
    private bool showApiKey = false;
    private bool isSaving = false;
    private string saveMessage = "";
    private string saveMessageClass = "";

    // FFmpeg í…ŒìŠ¤íŠ¸ ê´€ë ¨
    private bool isTestingFFmpeg = false;
    private string ffmpegStatusMessage = "í…ŒìŠ¤íŠ¸í•˜ì§€ ì•ŠìŒ";
    private string ffmpegStatusClass = "text-muted";

    protected override async Task OnInitializedAsync()
    {
        // ğŸ†• UserSettingsService ì´ˆê¸°í™”
        await UserSettings.InitializeAsync();
        LoadCurrentSettings();
    }

    private void LoadCurrentSettings()
    {
        try
        {
            // ğŸ†• ì‚¬ìš©ìë³„ ì„¤ì • ë¡œë“œ
            replicateApiKey = UserSettings.GetReplicateApiKey();
            basePrompt = UserSettings.GetBasePrompt();
            
            // YouTube ì„¤ì •ì€ ì „ì—­ (ConfigManager ê·¸ëŒ€ë¡œ)
            var config = ConfigManager.GetConfig();
            youtubeClientId = config.YouTubeClientId ?? "";
            youtubeClientSecret = config.YouTubeClientSecret ?? "";
        }
        catch (Exception ex)
        {
            saveMessage = $"ì„¤ì • ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
            saveMessageClass = "alert-danger";
        }
    }

    private void ToggleApiKeyVisibility()
    {
        showApiKey = !showApiKey;
    }

    private async Task SaveSettings()
    {
        isSaving = true;
        saveMessage = "";

        try
        {
            // ğŸ†• ì‚¬ìš©ìë³„ Replicate API í‚¤ ì €ì¥
            UserSettings.SetReplicateApiKey(replicateApiKey.Trim());

            // ğŸ†• ì‚¬ìš©ìë³„ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì €ì¥
            UserSettings.SetBasePrompt(basePrompt.Trim());

            // YouTube API ì„¤ì •ì€ ì „ì—­ ì €ì¥ (ConfigManager ê·¸ëŒ€ë¡œ)
            if (!string.IsNullOrWhiteSpace(youtubeClientId) && !string.IsNullOrWhiteSpace(youtubeClientSecret))
            {
                ConfigManager.SetYouTubeCredentials(youtubeClientId.Trim(), youtubeClientSecret.Trim());
            }

            saveMessage = "âœ… ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!";
            saveMessageClass = "alert-success";
        }
        catch (Exception ex)
        {
            saveMessage = $"âŒ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
            saveMessageClass = "alert-danger";
        }
        finally
        {
            isSaving = false;
        }
    }


    private async Task TestFFmpeg()
    {
        isTestingFFmpeg = true;
        ffmpegStatusMessage = "í…ŒìŠ¤íŠ¸ ì¤‘...";
        ffmpegStatusClass = "text-info";
        StateHasChanged();

        try
        {
            // ê²½ë¡œ ì •ë³´ ìˆ˜ì§‘
            string baseDir = AppDomain.CurrentDomain.BaseDirectory;
            string ffmpegPath = Path.Combine(baseDir, "ffmpeg.exe");
            bool fileExists = File.Exists(ffmpegPath);

            // ê¸°ë³¸ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
            bool isAvailable = await VideoPostProcessor.IsFFmpegAvailableAsync();

            if (isAvailable)
            {
                // ê°„ë‹¨í•œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
                bool simpleTest = await VideoPostProcessor.TestSimpleFFmpegAsync();

                if (simpleTest)
                {
                    ffmpegStatusMessage = $"âœ… FFmpeg ì‚¬ìš© ê°€ëŠ¥\nê²½ë¡œ: {ffmpegPath}\níŒŒì¼ ì¡´ì¬: {fileExists}";
                    ffmpegStatusClass = "text-success";
                }
                else
                {
                    ffmpegStatusMessage = $"âš ï¸ FFmpeg ì„¤ì¹˜ë¨ but ì‹¤í–‰ì— ë¬¸ì œê°€ ìˆìŒ\nê²½ë¡œ: {ffmpegPath}\níŒŒì¼ ì¡´ì¬: {fileExists}";
                    ffmpegStatusClass = "text-warning";
                }
            }
            else
            {
                ffmpegStatusMessage = $"âŒ FFmpegë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ\nì°¾ëŠ” ê²½ë¡œ: {ffmpegPath}\níŒŒì¼ ì¡´ì¬: {fileExists}\nê¸°ë³¸ ë””ë ‰í† ë¦¬: {baseDir}";
                ffmpegStatusClass = "text-danger";
            }
        }
        catch (Exception ex)
        {
            ffmpegStatusMessage = $"âŒ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: {ex.Message}";
            ffmpegStatusClass = "text-danger";
        }
        finally
        {
            isTestingFFmpeg = false;
            StateHasChanged();
        }
    }
}
