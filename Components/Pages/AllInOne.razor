@page "/all-in-one"
@rendermode InteractiveServer
@implements IDisposable
@using YouTubeShortsWebApp
@using YouTubeShortsWebApp.Services
@using System.Text
@inject IJSRuntime JSRuntime
@inject ScheduledUploadService ScheduledUploadService
@inject VideoGenerationService VideoGenService
@inject YouTubeUploadService YouTubeService
@using System.Web

<PageTitle>All-in-One ìë™í™”</PageTitle>

<h1>All-in-One ìë™ ì˜ìƒ ìƒì„± & ì—…ë¡œë“œ</h1>
<p class="text-muted">ì˜ìƒ ìƒì„±ë¶€í„° YouTube ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œê¹Œì§€ í•œ ë²ˆì— ì„¤ì •í•˜ê³  ì‹¤í–‰í•˜ì„¸ìš”.</p>

<div class="container">
    <div class="row">
        <div class="col-md-10">

            <!-- 1. ì˜ìƒ ìƒì„± ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4>1. ì˜ìƒ ìƒì„± ì„¤ì •</h4>
                </div>
                <div class="card-body">
                    @if (genOptions.IsGenerateVideo && string.IsNullOrEmpty(ConfigManager.GetConfig().ReplicateApiKey))
                    {
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <strong>âš ï¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</strong>
                            <p class="mb-2 mt-2">AI ì˜ìƒ ìƒì„±ì„ ì‚¬ìš©í•˜ë ¤ë©´ Replicate API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                            <div class="d-flex gap-2">
                                <a href="/settings" class="btn btn-sm btn-warning">âš™ï¸ ì„¤ì •í•˜ëŸ¬ ê°€ê¸°</a>
                                <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => genOptions.IsGenerateVideo = false">
                                    ğŸ“ ë¡œì»¬ íŒŒì¼ ëª¨ë“œë¡œ ì „í™˜
                                </button>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    <!-- ì˜ìƒ ì†ŒìŠ¤ ì„ íƒ -->
                    <div class="mb-4">
                        <label class="form-label"><strong>ì˜ìƒ ì†ŒìŠ¤:</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoSource" id="generateVideo"
                                   @onchange="() => genOptions.IsGenerateVideo = true" checked="@genOptions.IsGenerateVideo" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="generateVideo">
                                <strong>ìƒˆë¡œ ìƒì„±</strong> - AIë¡œ ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoSource" id="useLocalVideo"
                                   @onchange="() => genOptions.IsGenerateVideo = false" checked="@(!genOptions.IsGenerateVideo)" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="useLocalVideo">
                                <strong>ë¡œì»¬ íŒŒì¼ ì‚¬ìš©</strong> - ê¸°ì¡´ì— ìˆëŠ” ì˜ìƒ íŒŒì¼ë“¤ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤
                            </label>
                        </div>
                    </div>

                    @if (genOptions.IsGenerateVideo)
                    {
                        <!-- AI ì˜ìƒ ìƒì„± ì˜µì…˜ë“¤ -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label"><strong>ìƒì„±í•  ì˜ìƒ ê°œìˆ˜: @genOptions.VideoCount ê°œ</strong></label>
                                <input type="range" class="form-range" min="1" max="70" step="1" value="@genOptions.VideoCount" @oninput="OnVideoCountInput" disabled="@(isRunning || hasActiveSchedule)" />
                                    <small class="text-muted">1~10: 1ê°œ ë‹¨ìœ„, 11~70: 5ê°œ ë‹¨ìœ„</small>
                                <div class="text-primary">ì´ ì˜ˆìƒ ë¹„ìš©: $@totalCost</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><strong>ì˜ìƒ ê¸¸ì´:</strong></label>
                                <div>
                                    <button type="button" class="btn @GetDurationClass(5)" @onclick="@(() => genOptions.SelectedDuration = 5)" disabled="@(isRunning || hasActiveSchedule)">5ì´ˆ</button>
                                    <button type="button" class="btn @GetDurationClass(10)" @onclick="@(() => genOptions.SelectedDuration = 10)" disabled="@(isRunning || hasActiveSchedule)">10ì´ˆ</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><strong>í™”ë©´ ë¹„ìœ¨:</strong></label>
                                <div>
                                    <button type="button" class="btn @GetAspectClass("9:16")" @onclick="@(() => genOptions.SelectedAspectRatio = "9:16")" disabled="@(isRunning || hasActiveSchedule)">9:16</button>
                                    <button type="button" class="btn @GetAspectClass("16:9")" @onclick="@(() => genOptions.SelectedAspectRatio = "16:9")" disabled="@(isRunning || hasActiveSchedule)">16:9</button>
                                    <button type="button" class="btn @GetAspectClass("1:1")" @onclick="@(() => genOptions.SelectedAspectRatio = "1:1")" disabled="@(isRunning || hasActiveSchedule)">1:1</button>
                                </div>
                            </div>
                        </div>

                        <!-- CSV íŒŒì¼ ì—…ë¡œë“œ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ëœë¤ í”„ë¡¬í”„íŠ¸ CSV íŒŒì¼:</strong></label>
                            <InputFile OnChange="HandleCsvFileSelection" accept=".csv" class="form-control" disabled="@(isRunning || hasActiveSchedule)" />
                            <div class="form-text">CSV íŒŒì¼ í˜•ì‹: ì²« ë²ˆì§¸ ì—´ì€ ë²ˆí˜¸, ë‘ ë²ˆì§¸ ì—´ì€ í”„ë¡¬í”„íŠ¸ ë‚´ìš©</div>

                            @if (genOptions.CsvPrompts.Count > 0)
                            {
                                <div class="mt-2 alert alert-success">
                                    <strong>ë¡œë“œëœ í”„ë¡¬í”„íŠ¸:</strong> @genOptions.CsvPrompts.Count ê°œ
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="ShowCsvPreview" disabled="@(isRunning || hasActiveSchedule)">
                                        ë¯¸ë¦¬ë³´ê¸°
                                    </button>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- ë¡œì»¬ íŒŒì¼ ì„ íƒ ì˜µì…˜ë“¤ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ë¡œì»¬ ì˜ìƒ íŒŒì¼ë“¤:</strong></label>
                            <InputFile OnChange="HandleLocalVideoSelection" accept="video/*" multiple class="form-control" disabled="@(isRunning || hasActiveSchedule)" />
                            <div class="form-text">í•˜ë‚˜ ë˜ëŠ” ì—¬ëŸ¬ ê°œì˜ ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (ê°ê° ìµœëŒ€ 2GB)</div>

                            @if (genOptions.LocalVideoFiles.Count > 0)
                            {
                                <div class="mt-2 alert alert-success">
                                    <strong>ì„ íƒëœ íŒŒì¼:</strong> @genOptions.LocalVideoFiles.Count ê°œ
                                    <ul class="mb-0 mt-2">
                                        @foreach (var file in genOptions.LocalVideoFiles.Take(5))
                                        {
                                            <li>@file.Name (@VideoGenerationService.FormatFileSize(file.Size))</li>
                                        }
                                        @if (genOptions.LocalVideoFiles.Count > 5)
                                        {
                                            <li>... ì™¸ @(genOptions.LocalVideoFiles.Count - 5)ê°œ ë”</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- 2. í›„ì²˜ë¦¬ ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h4>2. í›„ì²˜ë¦¬ ì„¤ì •</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="postOptions.EnablePostProcessing" id="enablePostProcessing" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="enablePostProcessing">
                                <strong>ì˜ìƒ í›„ì²˜ë¦¬ ì‚¬ìš©</strong>
                            </label>
                        </div>
                    </div>

                    @if (postOptions.EnablePostProcessing)
                    {
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" @bind="postOptions.AddCaption" id="addCaption" disabled="@(isRunning || hasActiveSchedule)">
                                                <label class="form-check-label" for="addCaption">
                                                    <strong>ìº¡ì…˜ ì¶”ê°€</strong>
                                                </label>
                                            </div>
                                            @if (postOptions.AddCaption)
                                            {
                                                <div class="mt-2">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" @bind="postOptions.UseRandomCaption" @bind:after="OnRandomCaptionChanged" id="useRandomCaptionAllinone" disabled="@(isRunning || hasActiveSchedule)">
                                                        <label class="form-check-label" for="useRandomCaptionAllinone">
                                                            <strong>ëœë¤ ìº¡ì…˜ (CSV íŒŒì¼)</strong>
                                                        </label>
                                                    </div>
                                            
                                                    @if (postOptions.UseRandomCaption)
                                                    {
                                                        <div class="mb-2">
                                                            <label class="form-label form-label-sm">ìº¡ì…˜ CSV íŒŒì¼:</label>
                                                            <InputFile OnChange="HandleCaptionCsvSelection" accept=".csv" class="form-control form-control-sm" disabled="@(isRunning || hasActiveSchedule)" />
                                                            <div class="form-text">CSV í˜•ì‹: ì²« ë²ˆì§¸ ì—´ì€ ë²ˆí˜¸, ë‘ ë²ˆì§¸ ì—´ì€ ìº¡ì…˜ í…ìŠ¤íŠ¸</div>
                                                            
                                                            @if (postOptions.CaptionCsvList.Count > 0)
                                                            {
                                                                <div class="mt-1 alert alert-success py-1 px-2 small">
                                                                    âœ“ @postOptions.CaptionCsvList.Count ê°œ ìº¡ì…˜ ë¡œë“œë¨
                                                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="ShowCaptionCsvPreview" disabled="@(isRunning || hasActiveSchedule)">
                                                                        ë¯¸ë¦¬ë³´ê¸°
                                                                    </button>
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <input type="text" class="form-control form-control-sm mb-2" @bind="postOptions.CaptionText" placeholder="ìº¡ì…˜ í…ìŠ¤íŠ¸" disabled="@(isRunning || hasActiveSchedule)" />
                                                    }
                                            
                                                    <div class="row mt-2">
                                                        <div class="col-4">
                                                            <select class="form-select form-select-sm" @bind="postOptions.CaptionPosition" disabled="@(isRunning || hasActiveSchedule)">
                                                                <option value="top">ìƒë‹¨</option>
                                                                <option value="center">ì¤‘ì•™</option>
                                                                <option value="bottom">í•˜ë‹¨</option>
                                                                <option value="random">ëœë¤</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-4">
                                                            <select class="form-select form-select-sm" @bind="postOptions.CaptionSize" disabled="@(isRunning || hasActiveSchedule)">
                                                                <option value="60">ì‘ê²Œ</option>
                                                                <option value="80">ë³´í†µ</option>
                                                                <option value="120">í¬ê²Œ</option>
                                                                <option value="random">ëœë¤</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-4">
                                                            <select class="form-select form-select-sm" @bind="postOptions.CaptionColor" disabled="@(isRunning || hasActiveSchedule)">
                                                                <option value="white">í°ìƒ‰</option>
                                                                <option value="yellow">ë…¸ë€ìƒ‰</option>
                                                                <option value="red">ë¹¨ê°„ìƒ‰</option>
                                                                <option value="black">ê²€ì •ìƒ‰</option>
                                                                <option value="random">ëœë¤</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                    
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" @bind="postOptions.AddBackgroundMusic" id="addBackgroundMusic" disabled="@(isRunning || hasActiveSchedule)">
                                                <label class="form-check-label" for="addBackgroundMusic">
                                                    <strong>ë°°ê²½ìŒì•… ì¶”ê°€</strong>
                                                </label>
                                            </div>
                                            @if (postOptions.AddBackgroundMusic)
                                            {
                                                <div class="mt-2">
                                                    <div class="mb-2">
                                                        <label class="form-label form-label-sm">ë°°ê²½ìŒì•… íŒŒì¼ë“¤:</label>
                                                        <InputFile OnChange="HandleMusicFileSelection" accept="audio/*" multiple class="form-control form-control-sm" disabled="@(isRunning || hasActiveSchedule)" />
                                                        <div class="form-text">ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥. ì§€ì› í˜•ì‹: MP3, WAV, M4A, AAC (ê° ìµœëŒ€ 10MB)</div>
                                                        
                                                        @if (postOptions.SelectedMusicFiles.Count > 0)
                                                        {
                                                            <div class="mt-1 alert alert-success py-1 px-2 small">
                                                                âœ“ @postOptions.SelectedMusicFiles.Count ê°œ íŒŒì¼ ì„ íƒë¨
                                                                <ul class="mb-0 mt-1">
                                                                    @foreach (var file in postOptions.SelectedMusicFiles.Take(3))
                                                                    {
                                                                        <li>@file.Name (@VideoGenerationService.FormatFileSize(file.Size))</li>
                                                                    }
                                                                    @if (postOptions.SelectedMusicFiles.Count > 3)
                                                                    {
                                                                        <li>... ì™¸ @(postOptions.SelectedMusicFiles.Count - 3)ê°œ ë”</li>
                                                                    }
                                                                </ul>
                                                            </div>
                                                        }
                                                    </div>
                                                    <label class="form-label form-label-sm">ìŒëŸ‰: @postOptions.MusicVolume</label>
                                                    <input type="range" class="form-range" min="0.1" max="1.0" step="0.1" @bind="postOptions.MusicVolume" disabled="@(isRunning || hasActiveSchedule)" />
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- 3. YouTube ì—…ë¡œë“œ ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h4>3. YouTube ì—…ë¡œë“œ ì„¤ì •</h4>
                </div>
                <div class="card-body">
                    <!-- YouTube ê³„ì • ìƒíƒœ -->
                    <div class="mb-3">
                        @if (YouTubeService.CurrentAccount == null)
                        {
                            <div class="alert alert-warning">
                                <strong>YouTube ê³„ì • ì—°ë™ í•„ìš”</strong>
                                <button type="button" class="btn btn-danger btn-sm ms-2" @onclick="AuthenticateYouTube" disabled="@(isAuthenticating || isRunning)">
                                    @if (isAuthenticating)
                                    {
                                        <span>ì¸ì¦ ì¤‘...</span>
                                    }
                                    else
                                    {
                                        <span>ê³„ì • ì—°ë™</span>
                                    }
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-success">
                                <strong>ì—°ë™ëœ ê³„ì •:</strong> @YouTubeService.CurrentAccount.ChannelTitle
                                <small class="text-muted ms-2">êµ¬ë…ì: @YouTubeUploadService.FormatSubscriberCount(YouTubeService.CurrentAccount.SubscriberCount)ëª…</small>
                                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" @onclick="SwitchYouTubeAccount" disabled="@(isRunning || hasActiveSchedule)">
                                    ê³„ì • ì „í™˜
                                </button>
                            </div>
                        }
                    </div>
            
                    <!-- ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì‚¬ìš© ì²´í¬ë°•ìŠ¤ -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="useRandomUploadInfo" @bind:after="OnRandomUploadInfoChanged" id="useRandomUploadInfo" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="useRandomUploadInfo">
                                <strong>ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì‚¬ìš© (CSV íŒŒì¼)</strong>
                            </label>
                        </div>
                        <div class="form-text">ì œëª©, ì„¤ëª…, íƒœê·¸ë¥¼ CSV íŒŒì¼ì—ì„œ ëœë¤ìœ¼ë¡œ ì„ íƒí•©ë‹ˆë‹¤.</div>
                    </div>
            
                    @if (useRandomUploadInfo)
                    {
                        <!-- CSV íŒŒì¼ ì—…ë¡œë“œ -->
                        <div class="mb-4">
                            <label class="form-label"><strong>ì—…ë¡œë“œ ì •ë³´ CSV íŒŒì¼:</strong></label>
                            <InputFile OnChange="HandleUploadInfoCsvSelection" accept=".csv" class="form-control" disabled="@(isRunning || hasActiveSchedule)" />
                            <div class="form-text">
                                CSV íŒŒì¼ í˜•ì‹: 1ì—´(ë²ˆí˜¸), 2ì—´(ì œëª©), 3ì—´(ì„¤ëª…), 4ì—´(íƒœê·¸)
                                <br />
                                ì˜ˆì‹œ: 1, "ì œëª© ì˜ˆì‹œ", "ì„¤ëª… ì˜ˆì‹œ", "#íƒœê·¸1, #íƒœê·¸2, #íƒœê·¸3"
                            </div>
                            
                            <!-- ì‰¼í‘œ ì‚¬ìš© ê¸ˆì§€ ê²½ê³  -->
                            <div class="alert alert-secondary mt-2 py-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>ì¤‘ìš”:</strong> <span class="text-danger fw-bold">ì‰¼í‘œ(,) ì‚¬ìš©ì„ ê¸ˆì§€</span>í•©ë‹ˆë‹¤. 
                                <br />
                                ì‰¼í‘œ ëŒ€ì‹  <span class="text-primary">ë§ˆì¹¨í‘œ(.), ìŠ¬ë˜ì‰¬(/), ì„¸ë¯¸ì½œë¡ (;), ë˜ëŠ” ì¤„í‘œ(-)</span>ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
                            </div>
                        
                            @if (uploadInfoCsvList.Count > 0)
                            {
                                <div class="mt-2 alert alert-success">
                                    <strong>ë¡œë“œëœ ì—…ë¡œë“œ ì •ë³´:</strong> @uploadInfoCsvList.Count ê°œ
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="ShowUploadInfoCsvPreview" disabled="@(isRunning || hasActiveSchedule)">
                                        ë¯¸ë¦¬ë³´ê¸°
                                    </button>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ì œëª© í…œí”Œë¦¿:</strong></label>
                            <input type="text" class="form-control" @bind="uploadOptions.TitleTemplate" placeholder="ì˜ˆ: Runmoa #NUMBER" disabled="@(isRunning || hasActiveSchedule)" />
                            <div class="form-text">#NUMBERëŠ” ìë™ìœ¼ë¡œ #1, #2, #3... ìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>ì„¤ëª…:</strong></label>
                            <textarea class="form-control" rows="3" @bind="uploadOptions.Description" placeholder="ì˜ìƒ ì„¤ëª…" disabled="@(isRunning || hasActiveSchedule)"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>íƒœê·¸:</strong></label>
                            <input type="text" class="form-control" @bind="uploadOptions.Tags" placeholder="íƒœê·¸1, íƒœê·¸2, íƒœê·¸3" disabled="@(isRunning || hasActiveSchedule)" />
                        </div>
                    }
            
                    <!-- ê³µê°œ ì„¤ì • (í•­ìƒ í‘œì‹œ) -->
                    <div class="mb-3">
                        <label class="form-label"><strong>ê³µê°œ ì„¤ì •:</strong></label>
                        <select class="form-select" @bind="uploadOptions.PrivacySetting" disabled="@(isRunning || hasActiveSchedule)">
                            <option value="ë¹„ê³µê°œ">ë¹„ê³µê°œ</option>
                            <option value="ê³µê°œ">ê³µê°œ</option>
                            <option value="ë§í¬ ê³µìœ ">ë§í¬ ê³µìœ </option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 4. ì—…ë¡œë“œ ë°©ì‹ ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h4>4. ì—…ë¡œë“œ ë°©ì‹ ì„¤ì •</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="uploadMode" id="immediateUpload"
                                   @onchange="() => isScheduleUpload = false" checked="@(!isScheduleUpload)" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="immediateUpload">
                                <strong>ì¦‰ì‹œ ì—…ë¡œë“œ</strong> - ì˜ìƒ ìƒì„± ì™„ë£Œ í›„ ë°”ë¡œ ìˆœì°¨ ì—…ë¡œë“œ
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="uploadMode" id="scheduleUpload"
                                   @onchange="() => isScheduleUpload = true" checked="@isScheduleUpload" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="scheduleUpload">
                                <strong>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ</strong> - ì§€ì •ëœ ì‹œê°„ì— ëœë¤í•˜ê²Œ ìë™ ì—…ë¡œë“œ
                            </label>
                        </div>
                    </div>

                    @if (isScheduleUpload)
                    {
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">ì—…ë¡œë“œ ê¸°ê°„: @FormatScheduleHours(scheduleHours)</label>
                                <input type="range" class="form-range" min="0.5" max="480" step="0.5" 
                                       value="@scheduleHours" @oninput="OnScheduleHoursInput" disabled="@(isRunning || hasActiveSchedule)" />
                                <div class="form-text">@FormatScheduleHours(scheduleHours) ë™ì•ˆ ì—…ë¡œë“œë¥¼ ë¶„ì‚°</div>
                                <small class="text-muted">0.5~24ì‹œê°„: 0.5ì‹œê°„ ë‹¨ìœ„, 24~480ì‹œê°„: 12ì‹œê°„ ë‹¨ìœ„</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ìµœì†Œ ê°„ê²©: @FormatMinInterval(minIntervalMinutes)</label>
                                <input type="range" class="form-range" min="7" max="360" step="1" 
                                       value="@minIntervalMinutes" @oninput="OnMinIntervalInput" disabled="@(isRunning || hasActiveSchedule)" />
                                <div class="form-text">ì—…ë¡œë“œ ê°„ ìµœì†Œ @FormatMinInterval(minIntervalMinutes) ê°„ê²©</div>
                                <small class="text-muted">7~180ë¶„: 1ë¶„ ë‹¨ìœ„, 180~360ë¶„: 15ë¶„ ë‹¨ìœ„</small>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" @bind="randomizeOrder" @bind:after="UpdateSchedulePreview" id="randomizeOrder" disabled="@(isRunning || hasActiveSchedule)">
                                    <label class="form-check-label" for="randomizeOrder">
                                        ì—…ë¡œë“œ ìˆœì„œ ëœë¤í™”
                                    </label>
                                </div>
                            </div>
                        </div>

                        @if (schedulePreviewList.Count > 0)
                        {
                            <div class="mt-3 alert alert-info">
                                <h6>ì˜ˆìƒ ì—…ë¡œë“œ ìŠ¤ì¼€ì¤„:</h6>
                                <ul class="mb-0">
                                @if (schedulePreviewList.Count <= 5)
                                {
                                    @foreach (var item in schedulePreviewList)
                                    {
                                        <li>ì˜ìƒ #@item.Index -> @item.ScheduledTime.ToString("MM/dd HH:mm")</li>
                                    }
                                }
                                else
                                {
                                    @* ì²˜ìŒ 3ê°œ *@
                                    @foreach (var item in schedulePreviewList.Take(3))
                                    {
                                        <li>ì˜ìƒ #@item.Index -> @item.ScheduledTime.ToString("MM/dd HH:mm")</li>
                                    }
                                    <li class="text-muted">... ì¤‘ê°„ @(schedulePreviewList.Count - 4)ê°œ ìƒëµ ...</li>
                                    @* ë§ˆì§€ë§‰ 1ê°œ *@
                                    <li>ì˜ìƒ #@schedulePreviewList.Last().Index -> @schedulePreviewList.Last().ScheduledTime.ToString("MM/dd HH:mm")</li>
                                }
                            </ul>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" @onclick="UpdateSchedulePreview" disabled="@(isRunning || hasActiveSchedule)">
                                    ìŠ¤ì¼€ì¤„ ë‹¤ì‹œ ê³„ì‚°
                                </button>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- 5. ì‹¤í–‰ ë²„íŠ¼ -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-success btn-lg px-5" @onclick="StartAllInOne"
                            disabled="@(!CanStart || isRunning)">
                        @if (isRunning)
                        {
                            <span>ì‹¤í–‰ ì¤‘...</span>
                        }
                        else if (hasActiveSchedule)
                        {
                            <span>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì§„í–‰ ì¤‘...</span>
                        }
                        else
                        {
                            <span>ğŸš€ All-in-One ì‹œì‘</span>
                        }
                    </button>

                    @if (isRunning)
                    {
                        <button type="button" class="btn btn-outline-danger btn-lg px-3 ms-3" @onclick="StopAllInOne">
                            ì¤‘ì§€
                        </button>
                    }
                </div>
            </div>

            <!-- ì§„í–‰ë¥  í‘œì‹œ -->
            @if (isRunning)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>ì§„í–‰ ìƒí™©</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 style="width: @(currentProgress)%"></div>
                        </div>
                        <div class="text-info">@statusMessage</div>
                        @if (!string.IsNullOrEmpty(currentPromptUsed))
                        {
                            <div class="text-muted small mt-1">í˜„ì¬ í”„ë¡¬í”„íŠ¸: @currentPromptUsed</div>
                        }

                        @if (generatedVideos.Count > 0)
                        {
                            <div class="mt-3">
                                <h6>ìƒì„±ëœ ì˜ìƒ:</h6>
                                <ul class="list-group">
                                    @foreach (var video in generatedVideos)
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>@video.FileName</span>
                                            <span class="badge bg-@(video.IsScheduled ? "success" : "secondary")">
                                                @(video.IsScheduled ? "ìŠ¤ì¼€ì¤„ ë“±ë¡ë¨" : "ì²˜ë¦¬ ì¤‘")
                                            </span>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- ìŠ¤ì¼€ì¤„ ì§„í–‰ë¥  í‘œì‹œ -->
            @if (hasActiveSchedule && !isRunning)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì§„í–‰ ì¤‘</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100%"></div>
                        </div>
                        <div class="text-info">@statusMessage</div>
                        <div class="text-muted small">ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œí•˜ì§€ ë§ˆì„¸ìš”. ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ ì—…ë¡œë“œê°€ ì§„í–‰ë©ë‹ˆë‹¤.</div>

                        @if (!string.IsNullOrEmpty(nextUploadInfo))
                        {
                            <div class="mt-2 alert alert-info">
                                <small><strong>ë‹¤ìŒ ì—…ë¡œë“œ:</strong> @nextUploadInfo</small>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- ì™„ë£Œ ê²°ê³¼ -->
            @if (!string.IsNullOrEmpty(resultMessage))
            {
                <div class="alert @GetResultAlertClass()">
                    <h5>@GetResultTitle()</h5>
                    <p>@resultMessage</p>
                </div>
            }

        </div>
    </div>
</div>

<!-- CSV ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
@if (showCsvPreview)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h5>
                    <button type="button" class="btn-close" @onclick="() => showCsvPreview = false" disabled="@(isRunning || hasActiveSchedule)"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ì´ @genOptions.CsvPrompts.Count ê°œì˜ í”„ë¡¬í”„íŠ¸ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        @for (int i = 0; i < Math.Min(10, genOptions.CsvPrompts.Count); i++)
                        {
                            <div class="mb-2">
                                <strong>@(i + 1).</strong> @genOptions.CsvPrompts[i]
                            </div>
                        }
                        @if (genOptions.CsvPrompts.Count > 10)
                        {
                            <div class="text-muted">... ì™¸ @(genOptions.CsvPrompts.Count - 10) ê°œ ë”</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showCsvPreview = false" disabled="@(isRunning || hasActiveSchedule)">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- ìº¡ì…˜ CSV ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
@if (showCaptionCsvPreview)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ìº¡ì…˜ ë¯¸ë¦¬ë³´ê¸°</h5>
                    <button type="button" class="btn-close" @onclick="() => showCaptionCsvPreview = false" disabled="@(isRunning || hasActiveSchedule)"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ì´ @postOptions.CaptionCsvList.Count ê°œì˜ ìº¡ì…˜ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        @for (int i = 0; i < Math.Min(10, postOptions.CaptionCsvList.Count); i++)
                        {
                            <div class="mb-2">
                                <strong>@(i + 1).</strong> @postOptions.CaptionCsvList[i]
                            </div>
                        }
                        @if (postOptions.CaptionCsvList.Count > 10)
                        {
                            <div class="text-muted">... ì™¸ @(postOptions.CaptionCsvList.Count - 10) ê°œ ë”</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showCaptionCsvPreview = false" disabled="@(isRunning || hasActiveSchedule)">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
}
<!-- ì—…ë¡œë“œ ì •ë³´ CSV ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
@if (showUploadInfoCsvPreview)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ì—…ë¡œë“œ ì •ë³´ ë¯¸ë¦¬ë³´ê¸°</h5>
                    <button type="button" class="btn-close" @onclick="() => showUploadInfoCsvPreview = false" disabled="@(isRunning || hasActiveSchedule)"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ì´ @uploadInfoCsvList.Count ê°œì˜ ì—…ë¡œë“œ ì •ë³´ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                    <div style="max-height: 400px; overflow-y: auto;">
                        @for (int i = 0; i < Math.Min(5, uploadInfoCsvList.Count); i++)
                        {
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6 class="card-title">@(i + 1). @uploadInfoCsvList[i].Title</h6>
                                    <p class="card-text small mb-1"><strong>ì„¤ëª…:</strong> @uploadInfoCsvList[i].Description</p>
                                    <p class="card-text small mb-0"><strong>íƒœê·¸:</strong> @uploadInfoCsvList[i].Tags</p>
                                </div>
                            </div>
                        }
                        @if (uploadInfoCsvList.Count > 5)
                        {
                            <div class="text-muted text-center">... ì™¸ @(uploadInfoCsvList.Count - 5) ê°œ ë”</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showUploadInfoCsvPreview = false" disabled="@(isRunning || hasActiveSchedule)">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
}


<!-- ----------------------code ------------------------ -->

@code {
    // ğŸ”¥ ì„œë¹„ìŠ¤ì˜ Options í´ë˜ìŠ¤ ì‚¬ìš©
    private VideoGenerationService.VideoGenerationOptions genOptions = new();
    private VideoGenerationService.PostProcessingOptions postOptions = new();
    private YouTubeUploadService.UploadOptions uploadOptions = new();

    private bool CanStart
    {
        get
        {
            // í™œì„± ìŠ¤ì¼€ì¤„ ì²´í¬
            if (hasActiveSchedule) return false;
            
            // YouTube ì¸ì¦ ì²´í¬
            if (!YouTubeService.IsAuthenticated) return false;
            
            // ğŸ”¥ ì œëª© ì²´í¬: ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì‚¬ìš© ì‹œì—ëŠ” ì²´í¬ ì•ˆ í•¨
            if (!useRandomUploadInfo && string.IsNullOrWhiteSpace(uploadOptions.TitleTemplate))
                return false;
            
            // ğŸ”¥ ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì‚¬ìš© ì‹œ CSV ì²´í¬
            if (useRandomUploadInfo && uploadInfoCsvList.Count == 0)
                return false;
            
            // ì˜ìƒ ì†ŒìŠ¤ ì²´í¬
            if (genOptions.IsGenerateVideo && genOptions.CsvPrompts.Count == 0)
                return false;
            
            if (!genOptions.IsGenerateVideo && genOptions.LocalVideoFiles.Count == 0)
                return false;
            
            return true;
        }
    }

    // UI ìƒíƒœ
    private bool showCsvPreview = false;
    private bool showCaptionCsvPreview = false;

    // YouTube ì¸ì¦
    private bool isAuthenticating = false;

    // ì—…ë¡œë“œ ë°©ì‹ ì„¤ì •
    private bool isScheduleUpload = true;
    private List<SchedulePreviewItem> schedulePreviewList = new List<SchedulePreviewItem>();
    private Dictionary<int, DateTime> savedScheduleTimes = new Dictionary<int, DateTime>(); // ğŸ”¥ ì¶”ê°€

    public class SchedulePreviewItem
    {
        public int Index { get; set; }
        public DateTime ScheduledTime { get; set; }
    }

    // ìŠ¤ì¼€ì¤„ ì„¤ì •
    private float scheduleHours = 2.0f;
    private int minIntervalMinutes = 7;
    private bool randomizeOrder = true;

    // ëœë¤ ì—…ë¡œë“œ ì •ë³´ ê´€ë ¨
    private bool useRandomUploadInfo = false;
    private List<UploadInfoItem> uploadInfoCsvList = new List<UploadInfoItem>();
    private bool showUploadInfoCsvPreview = false;

    // ì‹¤í–‰ ìƒíƒœ
    private bool isRunning = false;
    private bool isCancelled = false;
    private int currentProgress = 0;
    private string statusMessage = "";
    private string currentPromptUsed = "";
    private string resultMessage = "";
    private bool isResultError = false;
    private List<GeneratedVideo> generatedVideos = new List<GeneratedVideo>();
    

    // ìŠ¤ì¼€ì¤„ ìƒíƒœ ì¶”ì 
    private bool hasActiveSchedule = false;
    private System.Timers.Timer? scheduleStatusTimer;
    private string nextUploadInfo = "";



    public class GeneratedVideo
    {
        public string FileName { get; set; } = "";
        public string FilePath { get; set; } = "";
        public bool IsScheduled { get; set; } = false;
    }

    private string totalCost => (genOptions.VideoCount * (genOptions.SelectedDuration == 5 ? 0.75m : 1.5m)).ToString("F2");

    private string GetDurationClass(int duration)
    {
        return genOptions.SelectedDuration == duration ? "btn-primary" : "btn-outline-primary";
    }

    private string GetAspectClass(string ratio)
    {
        return genOptions.SelectedAspectRatio == ratio ? "btn-success" : "btn-outline-success";
    }

    // ğŸ”¥ ìŠ¤ëƒ… ë¡œì§ì´ ì ìš©ëœ ì…ë ¥ í•¸ë“¤ëŸ¬ë“¤
    private void OnVideoCountInput(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            // 10 ì´ìƒì´ë©´ 5 ë‹¨ìœ„ë¡œ ìŠ¤ëƒ…
            if (value > 10)
            {
                value = (int)Math.Round(value / 5.0) * 5;
                value = Math.Max(10, Math.Min(70, value));
            }
            else
            {
                value = Math.Max(1, Math.Min(10, value));
            }
            
            genOptions.VideoCount = value;
            OnVideoCountChanged();
        }
    }
    
    private void OnScheduleHoursInput(ChangeEventArgs e)
    {
        if (float.TryParse(e.Value?.ToString(), out float value))
        {
            // 24 ì´ìƒì´ë©´ 12 ë‹¨ìœ„ë¡œ ìŠ¤ëƒ…
            if (value >= 24)
            {
                value = (float)Math.Round(value / 12.0) * 12;
                value = Math.Max(24, Math.Min(480, value));
            }
            else
            {
                // 0.5 ë‹¨ìœ„ë¡œ ìŠ¤ëƒ…
                value = (float)Math.Round(value * 2) / 2;
                value = Math.Max(0.5f, Math.Min(24, value));
            }
            
            scheduleHours = value;
            UpdateSchedulePreview();
        }
    }
    
    private void OnMinIntervalInput(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            // 180 ì´ìƒì´ë©´ 15 ë‹¨ìœ„ë¡œ ìŠ¤ëƒ…
            if (value >= 180)
            {
                value = (int)Math.Round(value / 15.0) * 15;
                value = Math.Max(180, Math.Min(360, value));
            }
            else
            {
                value = Math.Max(7, Math.Min(180, value));
            }
            
            minIntervalMinutes = value;
            UpdateSchedulePreview();
        }
    }
    
    // ğŸ”¥ í¬ë§·íŒ… ë©”ì„œë“œë“¤
    private string FormatScheduleHours(float hours)
    {
        if (hours >= 24)
        {
            float days = hours / 24;
            return $"{days:F1} days";
        }
        return $"{hours:F1} ì‹œê°„";
    }
    
    private string FormatMinInterval(int minutes)
    {
        if (minutes >= 180)
        {
            float hours = minutes / 60f;
            return $"{hours:F1} ì‹œê°„";
        }
        return $"{minutes} ë¶„";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var uri = new Uri(await JSRuntime.InvokeAsync<string>("eval", "window.location.href"));
                var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
                
                if (query["auth"] == "success")
                {
                    try
                    {
                        bool authCheck = await YouTubeService.CheckExistingAuthAsync();
                        if (authCheck)
                        {
                            await JSRuntime.InvokeVoidAsync("alert", "YouTube ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                            StateHasChanged();
                        }
                    }
                    catch (Exception ex)
                    {
                        await JSRuntime.InvokeVoidAsync("alert", $"ì¸ì¦ ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
                    }
                }
                else if (query["auth"] == "failed")
                {
                    await JSRuntime.InvokeVoidAsync("alert", "YouTube ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                else if (query["auth"] == "error")
                {
                    string errorMsg = query["message"] ?? "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
                    await JSRuntime.InvokeVoidAsync("alert", $"ì¸ì¦ ì˜¤ë¥˜: {errorMsg}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
            }
        }
    }

    private void OnVideoCountChanged()
    {
        if (isScheduleUpload)
        {
            UpdateSchedulePreview();
        }
        StateHasChanged();
    }

    private async Task HandleCsvFileSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        try
        {
            const long maxSize = 5 * 1024 * 1024;
            if (file.Size > maxSize)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            using var stream = file.OpenReadStream(maxSize);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            genOptions.CsvPrompts = VideoGenService.ParseCsvContent(content);

            if (genOptions.CsvPrompts.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì—ì„œ ìœ íš¨í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            else
            {
                OnVideoCountChanged();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {ex.Message}");
            genOptions.CsvPrompts.Clear();
        }
    }

    private async Task HandleLocalVideoSelection(InputFileChangeEventArgs e)
    {
        genOptions.LocalVideoFiles.Clear();
        genOptions.LocalVideoFiles.AddRange(e.GetMultipleFiles(20));

        const long maxSizePerFile = 2L * 1024 * 1024 * 1024;
        var invalidFiles = genOptions.LocalVideoFiles.Where(f => f.Size > maxSizePerFile).ToList();

        if (invalidFiles.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert",
                $"ë‹¤ìŒ íŒŒì¼ë“¤ì´ 2GBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤:\n{string.Join("\n", invalidFiles.Select(f => f.Name))}");

            genOptions.LocalVideoFiles = genOptions.LocalVideoFiles.Where(f => f.Size <= maxSizePerFile).ToList();
        }

        if (!genOptions.IsGenerateVideo)
        {
            genOptions.VideoCount = genOptions.LocalVideoFiles.Count;
        }

        OnVideoCountChanged();
        StateHasChanged();
    }

    private async Task HandleMusicFileSelection(InputFileChangeEventArgs e)
    {
        postOptions.SelectedMusicFiles.Clear();
        
        var files = e.GetMultipleFiles(10);
        
        try
        {
            const long maxSize = 10 * 1024 * 1024;
            
            foreach (var file in files)
            {
                if (file.Size > maxSize)
                {
                    await JSRuntime.InvokeVoidAsync("alert", $"{file.Name}ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    continue;
                }
    
                string[] supportedTypes = { "audio/mpeg", "audio/mp3", "audio/wav", "audio/mp4", "audio/aac" };
                if (!supportedTypes.Contains(file.ContentType.ToLower()) && 
                    !file.Name.ToLower().EndsWith(".mp3") && 
                    !file.Name.ToLower().EndsWith(".wav") && 
                    !file.Name.ToLower().EndsWith(".m4a") && 
                    !file.Name.ToLower().EndsWith(".aac"))
                {
                    await JSRuntime.InvokeVoidAsync("alert", $"{file.Name}ì€ ì§€ì›ë˜ì§€ ì•ŠëŠ” í˜•ì‹ì…ë‹ˆë‹¤.");
                    continue;
                }
                
                postOptions.SelectedMusicFiles.Add(file);
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ìŒì•… íŒŒì¼ ì„ íƒ ì˜¤ë¥˜: {ex.Message}");
            postOptions.SelectedMusicFiles.Clear();
        }
    
        StateHasChanged();
    }

    private void ShowCsvPreview()
    {
        showCsvPreview = true;
    }

    private void OnRandomCaptionChanged()
    {
        if (!postOptions.UseRandomCaption)
        {
            postOptions.CaptionCsvList.Clear();
        }
    }
    
    private async Task HandleCaptionCsvSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
    
        try
        {
            const long maxSize = 5 * 1024 * 1024;
            if (file.Size > maxSize)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
    
            using var stream = file.OpenReadStream(maxSize);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();
    
            postOptions.CaptionCsvList = VideoGenService.ParseCsvContent(content);
    
            if (postOptions.CaptionCsvList.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì—ì„œ ìœ íš¨í•œ ìº¡ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {ex.Message}");
            postOptions.CaptionCsvList.Clear();
        }
    }
    
    private void ShowCaptionCsvPreview()
    {
        showCaptionCsvPreview = true;
    }

    private async Task AuthenticateYouTube()
    {
        isAuthenticating = true;
    
        try
        {
            string authUrl = await YouTubeService.GetAuthorizationUrlAsync(JSRuntime, "all-in-one");
            await JSRuntime.InvokeVoidAsync("eval", $"window.location.href = '{authUrl}'");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ì¸ì¦ ì˜¤ë¥˜: {ex.Message}");
        }
        finally
        {
            isAuthenticating = false;
        }
    }

    private async Task SwitchYouTubeAccount()
    {
        try
        {
            bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", 
                "í˜„ì¬ ê³„ì • ì—°ë™ì„ í•´ì œí•˜ê³  ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            
            if (!confirm) return;
            
            await YouTubeService.SwitchAccountAsync();
            StateHasChanged();
            
            await AuthenticateYouTube();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ê³„ì • ì „í™˜ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    public class UploadInfoItem
    {
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Tags { get; set; } = "";
    }
    
    private void OnRandomUploadInfoChanged()
    {
        if (!useRandomUploadInfo)
        {
            uploadInfoCsvList.Clear();
        }
    }
    
    private async Task HandleUploadInfoCsvSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
    
        try
        {
            const long maxSize = 5 * 1024 * 1024;
            if (file.Size > maxSize)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
    
            using var stream = file.OpenReadStream(maxSize);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();
    
            Console.WriteLine("========================================");
            Console.WriteLine("=== CSV ì›ë³¸ ë‚´ìš© (ì²˜ìŒ 500ì) ===");
            Console.WriteLine(content.Substring(0, Math.Min(500, content.Length)));
            Console.WriteLine("========================================");
    
            uploadInfoCsvList = ParseUploadInfoCsv(content);
    
            if (uploadInfoCsvList.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì—ì„œ ìœ íš¨í•œ ì—…ë¡œë“œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            else
            {
                Console.WriteLine($"=== âœ… {uploadInfoCsvList.Count}ê°œ ì—…ë¡œë“œ ì •ë³´ ë¡œë“œë¨");
                
                // ì²˜ìŒ 3ê°œ ì¶œë ¥
                for (int i = 0; i < Math.Min(3, uploadInfoCsvList.Count); i++)
                {
                    Console.WriteLine($"\n=== í•­ëª© {i + 1} ===");
                    Console.WriteLine($"ì œëª©: {uploadInfoCsvList[i].Title}");
                    Console.WriteLine($"ì„¤ëª…: {uploadInfoCsvList[i].Description.Substring(0, Math.Min(50, uploadInfoCsvList[i].Description.Length))}...");
                    Console.WriteLine($"íƒœê·¸: {uploadInfoCsvList[i].Tags}");
                }
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {ex.Message}");
            uploadInfoCsvList.Clear();
        }
    }
    
    // ========================================
    // AllInOne.razor - ë©€í‹°ë¼ì¸ CSV ì§€ì› ë²„ì „
    // ê¸°ì¡´ ParseUploadInfoCsvë¥¼ ì´ê²ƒìœ¼ë¡œ êµì²´
    // ========================================
    
    private List<UploadInfoItem> ParseUploadInfoCsv(string content)
    {
        var items = new List<UploadInfoItem>();
        
        try
        {
            // ê°„ë‹¨í•œ CSV íŒŒì„œ êµ¬í˜„
            var lines = new List<string>();
            var currentLine = new StringBuilder();
            bool inQuotes = false;
            
            // ë¬¸ìë³„ë¡œ ì½ì–´ì„œ ë”°ì˜´í‘œ ë‚´ë¶€ì˜ ê°œí–‰ ì²˜ë¦¬
            for (int i = 0; i < content.Length; i++)
            {
                char c = content[i];
                
                if (c == '"')
                {
                    // ì—°ì†ëœ ë”°ì˜´í‘œ ì²˜ë¦¬ ("" -> ")
                    if (i + 1 < content.Length && content[i + 1] == '"')
                    {
                        currentLine.Append('"');
                        i++; // ë‹¤ìŒ ë”°ì˜´í‘œ ìŠ¤í‚µ
                    }
                    else
                    {
                        inQuotes = !inQuotes;
                    }
                }
                else if ((c == '\r' || c == '\n') && !inQuotes)
                {
                    // ë”°ì˜´í‘œ ë°–ì˜ ê°œí–‰ì€ ë¼ì¸ êµ¬ë¶„ì
                    if (currentLine.Length > 0)
                    {
                        lines.Add(currentLine.ToString());
                        currentLine.Clear();
                    }
                    
                    // \r\n ì²˜ë¦¬
                    if (c == '\r' && i + 1 < content.Length && content[i + 1] == '\n')
                    {
                        i++; // \n ìŠ¤í‚µ
                    }
                }
                else
                {
                    // ë”°ì˜´í‘œ ë‚´ë¶€ì˜ ê°œí–‰ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë˜ ê³µë°±ìœ¼ë¡œ ë³€í™˜
                    if ((c == '\r' || c == '\n') && inQuotes)
                    {
                        currentLine.Append(' ');
                    }
                    else
                    {
                        currentLine.Append(c);
                    }
                }
            }
            
            // ë§ˆì§€ë§‰ ë¼ì¸ ì¶”ê°€
            if (currentLine.Length > 0)
            {
                lines.Add(currentLine.ToString());
            }
            
            Console.WriteLine($"ì´ {lines.Count}ê°œ ë¼ì¸ íŒŒì‹±ë¨");
            
            // í—¤ë” ìŠ¤í‚µ (ì²« ë²ˆì§¸ ë¼ì¸)
            for (int lineIndex = 1; lineIndex < lines.Count; lineIndex++)
            {
                string line = lines[lineIndex].Trim();
                if (string.IsNullOrEmpty(line)) continue;
                
                try
                {
                    var fields = ParseCsvLine(line);
                    
                    if (fields.Length >= 4)
                    {
                        string title = fields[1].Trim('"').Trim();
                        string description = fields[2].Trim('"').Trim();
                        string tags = fields[3].Trim();
                        
                        if (!string.IsNullOrEmpty(title))
                        {
                            items.Add(new UploadInfoItem
                            {
                                Title = title,
                                Description = description,
                                Tags = tags
                            });
                            
                            Console.WriteLine($"í•­ëª© {items.Count}: {title.Substring(0, Math.Min(30, title.Length))}...");
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"ë¼ì¸ {lineIndex} íŒŒì‹± ì˜¤ë¥˜: {ex.Message}");
                    Console.WriteLine($"ë¬¸ì œ ë¼ì¸: {line.Substring(0, Math.Min(100, line.Length))}...");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"CSV íŒŒì‹± ì „ì²´ ì˜¤ë¥˜: {ex.Message}");
        }
        
        Console.WriteLine($"ìµœì¢… íŒŒì‹± ê²°ê³¼: {items.Count}ê°œ í•­ëª©");
        return items;
    }    


    // CSV ë¼ì¸ì„ í•„ë“œë³„ë¡œ ë¶„ë¦¬í•˜ëŠ” í—¬í¼ ë©”ì„œë“œ
    private string[] ParseCsvLine(string line)
    {
        var fields = new List<string>();
        var currentField = new StringBuilder();
        bool inQuotes = false;
        
        for (int i = 0; i < line.Length; i++)
        {
            char c = line[i];
            
            if (c == '"')
            {
                if (inQuotes && i + 1 < line.Length && line[i + 1] == '"')
                {
                    // ì—°ì†ëœ ë”°ì˜´í‘œëŠ” í•˜ë‚˜ì˜ ë”°ì˜´í‘œë¡œ ì²˜ë¦¬
                    currentField.Append('"');
                    i++; // ë‹¤ìŒ ë”°ì˜´í‘œ ìŠ¤í‚µ
                }
                else
                {
                    inQuotes = !inQuotes;
                }
            }
            else if (c == ',' && !inQuotes)
            {
                // ì‰¼í‘œê°€ ë”°ì˜´í‘œ ë°–ì— ìˆìœ¼ë©´ í•„ë“œ êµ¬ë¶„ì
                fields.Add(currentField.ToString());
                currentField.Clear();
            }
            else
            {
                currentField.Append(c);
            }
        }
        
        // ë§ˆì§€ë§‰ í•„ë“œ ì¶”ê°€
        fields.Add(currentField.ToString());
        
        return fields.ToArray();
    }


    // ëœë¤ìœ¼ë¡œ í•˜ë‚˜ ë½‘ê¸°
    private UploadInfoItem GetRandomUploadInfo(string csvContent)
    {
        var allItems = GetAllUploadInfo(csvContent);
        
        if (allItems.Count == 0)
        {
            Console.WriteLine("âŒ íŒŒì‹±ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
            return null;
        }
        
        var random = new Random();
        var randomItem = allItems[random.Next(allItems.Count)];
        
        Console.WriteLine($"\nğŸ² ëœë¤ ì„ íƒ ê²°ê³¼:");
        Console.WriteLine($"ì œëª©: {randomItem.Title}");
        Console.WriteLine($"ì„¤ëª…: {randomItem.Description.Substring(0, Math.Min(50, randomItem.Description.Length))}...");
        Console.WriteLine($"íƒœê·¸: {randomItem.Tags}");
        
        return randomItem;
    }

    // ğŸ”¥ CSV ì „ì²´ë¥¼ íŒŒì‹±í•œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì €ì¥í•  í•„ë“œ (í´ë˜ìŠ¤ ë ˆë²¨)
    private List<UploadInfoItem> _uploadInfoCache = null;

    // CSVë¥¼ í•œ ë²ˆë§Œ íŒŒì‹±í•˜ê³  ìºì‹œì— ì €ì¥
    private List<UploadInfoItem> GetAllUploadInfo(string csvContent)
    {
        if (_uploadInfoCache == null)
        {
            _uploadInfoCache = ParseUploadInfoCsv(csvContent);
            Console.WriteLine($"âœ… CSV ìºì‹± ì™„ë£Œ: {_uploadInfoCache.Count}ê°œ í•­ëª©");
        }
        return _uploadInfoCache;
    }

    private int FindClosingQuote(string text, int startIndex)
    {
        for (int i = startIndex; i < text.Length; i++)
        {
            if (text[i] == '"')
            {
                if (i + 1 < text.Length && text[i + 1] == '"')
                {
                    i++;
                    continue;
                }
                return i;
            }
        }
        return -1;
    }
    
    
    
    private void ShowUploadInfoCsvPreview()
    {
        showUploadInfoCsvPreview = true;
    }

    private void UpdateSchedulePreview()
    {
        if (!isScheduleUpload) return;
    
        schedulePreviewList.Clear();
        savedScheduleTimes.Clear();
        
        DateTime startTime = DateTime.Now.AddMinutes(5);
        DateTime endTime = startTime.AddHours(scheduleHours);
    
        int totalVideos = genOptions.IsGenerateVideo ? genOptions.VideoCount : genOptions.LocalVideoFiles.Count;
    
        var random = new Random();
        
        for (int i = 0; i < totalVideos; i++)
        {
            double totalMinutes = (endTime - startTime).TotalMinutes;
            double segmentMinutes = totalMinutes / totalVideos; // âœ… ìˆ˜ì •
    
            double segmentStart = i * segmentMinutes;
            double segmentEnd = Math.Min((i + 1) * segmentMinutes, totalMinutes);
    
            double randomMinutes = segmentStart + (random.NextDouble() * (segmentEnd - segmentStart));
    
            if (i > 0 && totalMinutes > (totalVideos * minIntervalMinutes))
            {
                var previousTime = startTime.AddMinutes(segmentStart);
                var proposedTime = startTime.AddMinutes(randomMinutes);
    
                if ((proposedTime - previousTime).TotalMinutes < minIntervalMinutes)
                {
                    randomMinutes = segmentStart + minIntervalMinutes;
                }
            }
    
            randomMinutes = Math.Min(randomMinutes, totalMinutes);
            DateTime scheduledTime = startTime.AddMinutes(randomMinutes);
            
            schedulePreviewList.Add(new SchedulePreviewItem
            {
                Index = i + 1,
                ScheduledTime = scheduledTime
            });
            
            savedScheduleTimes[i] = scheduledTime;
        }
    
        schedulePreviewList = schedulePreviewList.OrderBy(x => x.ScheduledTime).ToList();
        StateHasChanged();
    }
    
    // ğŸ”¥ YouTubeUploadServiceì™€ ë™ì¼í•œ ì‹œê°„ ê³„ì‚° ë¡œì§
    private DateTime CalculateScheduleTime(DateTime startTime, DateTime endTime, int index, int totalCount, int minIntervalMinutes)
    {
        var random = new Random(); // ê°™ì€ ì¸ë±ìŠ¤ë©´ ê°™ì€ ì‹œê°„ ìƒì„±
        double totalMinutes = (endTime - startTime).TotalMinutes;
        double segmentMinutes = totalMinutes / totalCount;
    
        double segmentStart = index * segmentMinutes;
        double segmentEnd = Math.Min((index + 1) * segmentMinutes, totalMinutes);
    
        double randomMinutes = segmentStart + (random.NextDouble() * (segmentEnd - segmentStart));
    
        if (index > 0 && totalMinutes > (totalCount * minIntervalMinutes))
        {
            var previousTime = startTime.AddMinutes(segmentStart);
            var proposedTime = startTime.AddMinutes(randomMinutes);
    
            if ((proposedTime - previousTime).TotalMinutes < minIntervalMinutes)
            {
                randomMinutes = segmentStart + minIntervalMinutes;
            }
        }
    
        randomMinutes = Math.Min(randomMinutes, totalMinutes);
        return startTime.AddMinutes(randomMinutes);
    }
    
    private async Task StartAllInOne()
    {
        if (!CanStart) return;
    
        // ğŸ”¥ API í‚¤ ê²€ì¦ ê°œì„ 
        if (genOptions.IsGenerateVideo)
        {
            var config = ConfigManager.GetConfig();
            if (string.IsNullOrEmpty(config.ReplicateApiKey))
            {
                bool useLocal = await JSRuntime.InvokeAsync<bool>("confirm",
                    "âš ï¸ Replicate API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n" +
                    "AI ì˜ìƒ ìƒì„±ì„ í•˜ë ¤ë©´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n" +
                    "ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”:\n\n" +
                    "â€¢ [í™•ì¸] â†’ ë¡œì»¬ íŒŒì¼ ì‚¬ìš© ëª¨ë“œë¡œ ì „í™˜\n" +
                    "â€¢ [ì·¨ì†Œ] â†’ ê¸°ë³¸ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™\n\n" +
                    "ë¡œì»¬ íŒŒì¼ ëª¨ë“œë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                
                if (useLocal)
                {
                    // ë¡œì»¬ íŒŒì¼ ëª¨ë“œë¡œ ì „í™˜
                    genOptions.IsGenerateVideo = false;
                    StateHasChanged();
                    await JSRuntime.InvokeVoidAsync("alert", 
                        "ğŸ“ ë¡œì»¬ íŒŒì¼ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                        "ì´ì œ ì²˜ë¦¬í•  ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                else
                {
                    // ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™
                    await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/settings'");
                    return;
                }
            }
    
            if (genOptions.CsvPrompts.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", 
                    "ğŸ“„ CSV íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!\n\n" +
                    "AI ì˜ìƒì„ ìƒì„±í•˜ë ¤ë©´ í”„ë¡¬í”„íŠ¸ê°€ ë‹´ê¸´ CSV íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }
        }
        else
        {
            if (genOptions.LocalVideoFiles.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", 
                    "ğŸ“ ì²˜ë¦¬í•  ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!\n\n" +
                    "ë¡œì»¬ íŒŒì¼ ì‚¬ìš© ëª¨ë“œì—ì„œëŠ” ì§ì ‘ ì˜ìƒ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
        }
    
        // YouTube ì¸ì¦ í™•ì¸ ê°œì„ 
        if (!YouTubeService.IsAuthenticated)
        {
            bool goToSettings = await JSRuntime.InvokeAsync<bool>("confirm",
                "âš ï¸ YouTube ê³„ì •ì´ ì—°ë™ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n" +
                "ì—…ë¡œë“œë¥¼ í•˜ë ¤ë©´ YouTube ê³„ì • ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\n" +
                "â€¢ [í™•ì¸] â†’ ì§€ê¸ˆ ê³„ì • ì—°ë™í•˜ê¸°\n" +
                "â€¢ [ì·¨ì†Œ] â†’ ì·¨ì†Œ\n\n" +
                "ê³„ì •ì„ ì—°ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            
            if (goToSettings)
            {
                await AuthenticateYouTube();
            }
            return;
        }
    
        // ğŸ”¥ ì¦‰ì‹œ ì—…ë¡œë“œ + í›„ì²˜ë¦¬ ì‹œ ê²½ê³  ë° ì„ íƒ ì¶”ê°€
        if (!isScheduleUpload && postOptions.EnablePostProcessing)
        {
            bool proceed = await JSRuntime.InvokeAsync<bool>("confirm",
                "âš ï¸ ì¦‰ì‹œ ì—…ë¡œë“œ + í›„ì²˜ë¦¬ëŠ” ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë ¤ ì—°ê²°ì´ ëŠì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n" +
                "ì„ íƒí•´ì£¼ì„¸ìš”:\n\n" +
                "â€¢ [í™•ì¸] â†’ í›„ì²˜ë¦¬ ì—†ì´ ì¦‰ì‹œ ì—…ë¡œë“œ (ë¹ ë¦„)\n" +
                "â€¢ [ì·¨ì†Œ] â†’ ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œë¡œ ë³€ê²½ (ì•ˆì „)\n\n" +
                "í›„ì²˜ë¦¬ ì—†ì´ ì¦‰ì‹œ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            
            if (proceed)
            {
                // í›„ì²˜ë¦¬ ë¹„í™œì„±í™”
                postOptions.EnablePostProcessing = false;
                StateHasChanged();
                
                await JSRuntime.InvokeVoidAsync("alert", 
                    "âœ… í›„ì²˜ë¦¬ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                    "ë¹ ë¥¸ ì—…ë¡œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤!");
            }
            else
            {
                // ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œë¡œ ë³€ê²½
                isScheduleUpload = true;
                UpdateSchedulePreview(); // ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                StateHasChanged();
                
                await JSRuntime.InvokeVoidAsync("alert", 
                    "âœ… ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                    "í›„ì²˜ë¦¬ í¬í•¨í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì—…ë¡œë“œë©ë‹ˆë‹¤!");
                return;
            }
        }
    
        if (postOptions.EnablePostProcessing)
        {
            if (postOptions.AddCaption && postOptions.UseRandomCaption && postOptions.CaptionCsvList.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "ëœë¤ ìº¡ì…˜ì„ ì‚¬ìš©í•˜ë ¤ë©´ ìº¡ì…˜ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            if (postOptions.AddCaption && !postOptions.UseRandomCaption && string.IsNullOrWhiteSpace(postOptions.CaptionText))
            {
                await JSRuntime.InvokeVoidAsync("alert", "ìº¡ì…˜ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
    
            bool ffmpegAvailable = await VideoPostProcessor.IsFFmpegAvailableAsync();
            if (!ffmpegAvailable)
            {
                bool proceed = await JSRuntime.InvokeAsync<bool>("confirm",
                    "FFmpegë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ í›„ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní›„ì²˜ë¦¬ ì—†ì´ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    
                if (!proceed)
                {
                    return;
                }
                postOptions.EnablePostProcessing = false;
            }
        }
    
        isRunning = true;
        isCancelled = false;
        currentProgress = 0;
        generatedVideos.Clear();
        resultMessage = "";
        isResultError = false;
    
        try
        {
            int totalVideos = genOptions.IsGenerateVideo ? genOptions.VideoCount : genOptions.LocalVideoFiles.Count;
            
            // ğŸ”¥ AI ìƒì„± ëª¨ë“œ + ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ
            if (genOptions.IsGenerateVideo && isScheduleUpload)
            {
                statusMessage = "ìŠ¤ì¼€ì¤„ ì¤€ë¹„ ì¤‘...";
                currentProgress = 50;
                StateHasChanged();
    
                // âœ… ì˜ìƒì„ ë¯¸ë¦¬ ìƒì„±í•˜ì§€ ì•Šê³ , ìƒì„± ì •ë³´ë§Œ ìŠ¤ì¼€ì¤„ì— ë“±ë¡
                await RegisterToSchedule();
    
                currentProgress = 100;
                statusMessage = "ìŠ¤ì¼€ì¤„ ë“±ë¡ ì™„ë£Œ";
                hasActiveSchedule = true;
                StartScheduleStatusTracking();
            }
            // ğŸ”¥ AI ìƒì„± ëª¨ë“œ + ì¦‰ì‹œ ì—…ë¡œë“œ
            else if (genOptions.IsGenerateVideo && !isScheduleUpload)
            {
                statusMessage = "ì˜ìƒ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...";
                StateHasChanged();
    
                // ì¦‰ì‹œ ì—…ë¡œë“œëŠ” ë¯¸ë¦¬ ìƒì„±í•´ì•¼ í•¨
                for (int i = 0; i < totalVideos; i++)
                {
                    if (isCancelled) break;
    
                    currentProgress = (i * 80 / totalVideos);
                    statusMessage = $"ì˜ìƒ {i + 1}/{totalVideos} ìƒì„± ì¤‘...";
                    StateHasChanged();
    
                    var result = await VideoGenService.GenerateOrProcessVideoAsync(
                        i + 1,
                        genOptions,
                        postOptions,
                        (status) => {
                            statusMessage = status;
                            currentPromptUsed = status;
                            StateHasChanged();
                        }
                    );
    
                    if (result.Success)
                    {
                        var generatedVideo = new GeneratedVideo
                        {
                            FileName = result.FileName,
                            FilePath = result.VideoPath,
                            IsScheduled = false
                        };
                        generatedVideos.Add(generatedVideo);
                        
                        var historyItem = VideoGenService.CreateHistoryItem(result, genOptions, "All-in-One");
                        VideoHistoryManager.AddHistoryItem(historyItem);
                    }
    
                    StateHasChanged();
                }
    
                if (!isCancelled && generatedVideos.Count > 0)
                {
                    currentProgress = 85;
                    statusMessage = "ì¦‰ì‹œ ì—…ë¡œë“œ ì‹œì‘...";
                    StateHasChanged();
    
                    await RegisterToSchedule();
    
                    currentProgress = 100;
                    statusMessage = "ì—…ë¡œë“œ ì§„í–‰ ì¤‘...";
                }
            }
            // ğŸ”¥ ë¡œì»¬ íŒŒì¼ ëª¨ë“œ
            else
            {
                statusMessage = "ë¡œì»¬ íŒŒì¼ ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...";
                StateHasChanged();
    
                for (int i = 0; i < totalVideos; i++)
                {
                    if (isCancelled) break;
    
                    currentProgress = (i * 80 / totalVideos);
                    statusMessage = $"íŒŒì¼ {i + 1}/{totalVideos} ì²˜ë¦¬ ì¤‘...";
                    StateHasChanged();
    
                    var result = await VideoGenService.GenerateOrProcessVideoAsync(
                        i + 1,
                        genOptions,
                        postOptions,
                        (status) => {
                            statusMessage = status;
                            StateHasChanged();
                        }
                    );
    
                    if (result.Success)
                    {
                        var generatedVideo = new GeneratedVideo
                        {
                            FileName = result.FileName,
                            FilePath = result.VideoPath,
                            IsScheduled = false
                        };
                        generatedVideos.Add(generatedVideo);
                        
                        var historyItem = VideoGenService.CreateHistoryItem(result, genOptions, "All-in-One");
                        VideoHistoryManager.AddHistoryItem(historyItem);
                    }
    
                    StateHasChanged();
                }
    
                if (!isCancelled && generatedVideos.Count > 0)
                {
                    currentProgress = 85;
                    statusMessage = isScheduleUpload ? "YouTube ìŠ¤ì¼€ì¤„ì— ë“±ë¡ ì¤‘..." : "ì¦‰ì‹œ ì—…ë¡œë“œ ì‹œì‘...";
                    StateHasChanged();
    
                    await RegisterToSchedule();
    
                    currentProgress = 100;
                    statusMessage = isScheduleUpload ? "ìŠ¤ì¼€ì¤„ ë“±ë¡ ì™„ë£Œ" : "ì—…ë¡œë“œ ì§„í–‰ ì¤‘...";
    
                    if (isScheduleUpload)
                    {
                        hasActiveSchedule = true;
                        StartScheduleStatusTracking();
                    }
                }
            }
    
            if (isCancelled)
            {
                statusMessage = "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                resultMessage = "ì‚¬ìš©ìì— ì˜í•´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
            else if (!genOptions.IsGenerateVideo && generatedVideos.Count == 0)
            {
                statusMessage = "ì²˜ë¦¬ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
                resultMessage = "ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì˜ìƒì´ ì—†ì—ˆìŠµë‹ˆë‹¤.";
                isResultError = true;
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"All-in-One ì‹¤í–‰ ì˜¤ë¥˜: {ex.Message}");
            statusMessage = $"ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
            resultMessage = $"ì˜¤ë¥˜ë¡œ ì¸í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤: {ex.Message}";
            isResultError = true;
        }
        finally
        {
            isRunning = false;
            StateHasChanged();
        }
    }

    private string GetResultAlertClass()
    {
        return isResultError ? "alert-danger" : "alert-success";
    }

    private string GetResultTitle()
    {
        return isResultError ? "ì˜¤ë¥˜ ë°œìƒ" : "All-in-One ì™„ë£Œ!";
    }

    private void StopAllInOne()
    {
        isCancelled = true;
        statusMessage = "ì¤‘ì§€ ì¤‘...";
    }

    private async Task RegisterToSchedule()
    {
        if (isScheduleUpload)
        {
            DateTime startTime = DateTime.Now.AddMinutes(5);
            
            // ğŸ”¥ AI ìƒì„± ëª¨ë“œ: ìƒì„± ì •ë³´ë§Œ ì „ë‹¬
            if (genOptions.IsGenerateVideo)
            {
                var videoInfoList = new List<YouTubeUploadService.VideoGenerationInfo>();
                var random = new Random();
                
                for (int i = 0; i < genOptions.VideoCount; i++)
                {
                    string prompt = genOptions.CsvPrompts[random.Next(genOptions.CsvPrompts.Count)];
                    string? captionText = null;
                    
                    if (postOptions.EnablePostProcessing && postOptions.AddCaption)
                    {
                        if (postOptions.UseRandomCaption && postOptions.CaptionCsvList.Count > 0)
                        {
                            captionText = postOptions.CaptionCsvList[random.Next(postOptions.CaptionCsvList.Count)];
                        }
                        else
                        {
                            captionText = postOptions.CaptionText;
                        }
                    }
                    
                    string? musicPath = null;
                    if (postOptions.EnablePostProcessing && postOptions.AddBackgroundMusic && postOptions.SelectedMusicFiles.Count > 0)
                    {
                        var musicFile = postOptions.SelectedMusicFiles[random.Next(postOptions.SelectedMusicFiles.Count)];
                        string tempDir = Path.Combine(Path.GetTempPath(), "BackgroundMusic");
                        Directory.CreateDirectory(tempDir);
                        musicPath = Path.Combine(tempDir, musicFile.Name);
                        
                        using (var stream = musicFile.OpenReadStream(10 * 1024 * 1024))
                        using (var fileStream = File.Create(musicPath))
                        {
                            await stream.CopyToAsync(fileStream);
                        }
                    }
                    
                    videoInfoList.Add(new YouTubeUploadService.VideoGenerationInfo
                    {
                        Prompt = prompt,
                        Duration = genOptions.SelectedDuration,
                        AspectRatio = genOptions.SelectedAspectRatio,
                        EnablePostProcessing = postOptions.EnablePostProcessing,
                        CaptionText = captionText,
                        CaptionPosition = postOptions.CaptionPosition,
                        CaptionSize = postOptions.CaptionSize,
                        CaptionColor = postOptions.CaptionColor,
                        AddBackgroundMusic = postOptions.AddBackgroundMusic,
                        MusicFilePath = musicPath,
                        MusicVolume = postOptions.MusicVolume
                    });
                }
                
                if (useRandomUploadInfo && uploadInfoCsvList.Count > 0)
                {
                    uploadOptions.UseRandomInfo = true;
                    uploadOptions.RandomTitles = uploadInfoCsvList.Select(item => item.Title).ToList();
                    uploadOptions.RandomDescriptions = uploadInfoCsvList.Select(item => item.Description).ToList();
                    uploadOptions.RandomTags = uploadInfoCsvList.Select(item => item.Tags).ToList();
                }
                
                // ğŸ”¥ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì €ì¥ëœ ì‹œê°„ ì‚¬ìš©
                YouTubeService.RegisterScheduledUploadsWithGeneration(
                    videoInfoList,
                    uploadOptions,
                    savedScheduleTimes, // ğŸ”¥ ì €ì¥ëœ ì‹œê°„ ì „ë‹¬
                    randomizeOrder,
                    ScheduledUploadService
                );
                
                Console.WriteLine($"=== âœ… {videoInfoList.Count}ê°œ ì˜ìƒ ìƒì„± ì •ë³´ ë“±ë¡ ì™„ë£Œ");
                Console.WriteLine($"=== â° ê° ì˜ìƒì€ ì—…ë¡œë“œ 5ë¶„ ì „ì— ìë™ ìƒì„±ë©ë‹ˆë‹¤");
            }
            // ğŸ”¥ ë¡œì»¬ íŒŒì¼ ëª¨ë“œ: ê¸°ì¡´ ë°©ì‹ ìœ ì§€
            else
            {
                var filePaths = generatedVideos.Select(v => v.FilePath).ToList();
                
                if (useRandomUploadInfo && uploadInfoCsvList.Count > 0)
                {
                    uploadOptions.UseRandomInfo = true;
                    uploadOptions.RandomTitles = uploadInfoCsvList.Select(item => item.Title).ToList();
                    uploadOptions.RandomDescriptions = uploadInfoCsvList.Select(item => item.Description).ToList();
                    uploadOptions.RandomTags = uploadInfoCsvList.Select(item => item.Tags).ToList();
                }
                
                YouTubeService.RegisterScheduledUploads(
                    filePaths,
                    uploadOptions,
                    savedScheduleTimes, // ğŸ”¥ ì €ì¥ëœ ì‹œê°„ ì „ë‹¬
                    randomizeOrder,
                    ScheduledUploadService
                );
            }
            
            hasActiveSchedule = true;
            StartScheduleStatusTracking();
        }
        else
        {
            await StartImmediateUpload();
        }
    }
    
    private async Task StartImmediateUpload()
    {
        statusMessage = "ì¦‰ì‹œ ì—…ë¡œë“œ ì‹œì‘...";
    
        try
        {
            var filePaths = generatedVideos.Select(v => v.FilePath).ToList();
            
            // ğŸ”¥ ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì„¤ì •
            if (useRandomUploadInfo && uploadInfoCsvList.Count > 0)
            {
                uploadOptions.UseRandomInfo = true;
                
                // ê°ê° ë…ë¦½ì ì¸ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
                uploadOptions.UseRandomInfo = true;
                uploadOptions.RandomTitles = uploadInfoCsvList.Select(item => item.Title).ToList();
                uploadOptions.RandomDescriptions = uploadInfoCsvList.Select(item => item.Description).ToList();
                uploadOptions.RandomTags = uploadInfoCsvList.Select(item => item.Tags).ToList();
                
                Console.WriteLine($"=== ëœë¤ ì—…ë¡œë“œ ì •ë³´ í™œì„±í™”");
                Console.WriteLine($"    ì œëª©: {uploadOptions.RandomTitles.Count}ê°œ");
                Console.WriteLine($"    ì„¤ëª…: {uploadOptions.RandomDescriptions.Count}ê°œ");
                Console.WriteLine($"    íƒœê·¸: {uploadOptions.RandomTags.Count}ê°œ");
            }
            else
            {
                uploadOptions.UseRandomInfo = false;
                uploadOptions.RandomTitles = null;
                uploadOptions.RandomDescriptions = null;
                uploadOptions.RandomTags = null;
            }
            
            // ğŸ”¥ ì„œë¹„ìŠ¤ ì‚¬ìš©
            await YouTubeService.UploadMultipleVideosAsync(
                filePaths,
                uploadOptions,
                (current, total, title) => {
                    InvokeAsync(() => {
                        statusMessage = $"ì—…ë¡œë“œ ì¤‘... ({current}/{total}) {title}";
                        currentProgress = 85 + (current * 15 / total);
                        StateHasChanged();
                    });
                }
            );
    
            foreach (var video in generatedVideos)
            {
                video.IsScheduled = true;
            }
    
            statusMessage = $"ì¦‰ì‹œ ì—…ë¡œë“œ ì™„ë£Œ!";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ì¦‰ì‹œ ì—…ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"ì—…ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private void StartScheduleStatusTracking()
    {
        scheduleStatusTimer = new System.Timers.Timer(30000);
        scheduleStatusTimer.Elapsed += CheckScheduleStatus;
        scheduleStatusTimer.AutoReset = true;
        scheduleStatusTimer.Start();
    }

    private void CheckScheduleStatus(object sender, System.Timers.ElapsedEventArgs e)
    {
        try
        {
            int queueCount = ScheduledUploadService.GetQueueCount();
            var allItems = ScheduledUploadService.GetAllScheduledItems();
    
            InvokeAsync(() =>
            {
                if (queueCount == 0 && hasActiveSchedule)
                {
                    hasActiveSchedule = false;
                    scheduleStatusTimer?.Stop();
                    scheduleStatusTimer?.Dispose();
                    scheduleStatusTimer = null;
    
                    statusMessage = "ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ëŒ€ê¸° ì¤‘...";  // âœ… ìˆ˜ì •
                    // resultMessageëŠ” ì—¬ê¸°ì„œ ì„¤ì •í•˜ì§€ ì•ŠìŒ - HandleAllUploadsCompletedì—ì„œ ì²˜ë¦¬
                    nextUploadInfo = "";
                }
                else if (hasActiveSchedule)
                {
                    statusMessage = $"ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì§„í–‰ ì¤‘... (ëŒ€ê¸°: {queueCount}ê°œ)";
    
                    var nextUpload = allItems
                        .Where(x => x.Status == "ëŒ€ê¸° ì¤‘" || x.Status == "ìƒì„± ì™„ë£Œ")  // âœ… "ìƒì„± ì™„ë£Œ"ë„ í¬í•¨
                        .OrderBy(x => x.ScheduledTime)
                        .FirstOrDefault();
    
                    if (nextUpload != null)
                    {
                        var timeUntil = nextUpload.ScheduledTime - DateTime.Now;
                        if (timeUntil.TotalMinutes > 0)
                        {
                            string fileName = nextUpload.FileName.Length > 30 
                                ? nextUpload.FileName.Substring(0, 27) + "..."
                                : nextUpload.FileName;
    
                            if (timeUntil.TotalHours >= 1)
                            {
                                nextUploadInfo = $"{fileName} - {nextUpload.ScheduledTime:MM/dd HH:mm} ({timeUntil.Hours}ì‹œê°„ {timeUntil.Minutes}ë¶„ í›„)";
                            }
                            else
                            {
                                nextUploadInfo = $"{fileName} - {nextUpload.ScheduledTime:MM/dd HH:mm} ({(int)timeUntil.TotalMinutes}ë¶„ í›„)";
                            }
                        }
                        else
                        {
                            nextUploadInfo = $"{nextUpload.FileName} - ê³§ ì—…ë¡œë“œ ì˜ˆì •";
                        }
                    }
                    else
                    {
                        nextUploadInfo = "";
                    }
                }
    
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ìŠ¤ì¼€ì¤„ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜: {ex.Message}");
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸ êµ¬ë…
        ScheduledUploadService.OnAllUploadsCompleted += HandleAllUploadsCompleted;
    }

    private async void HandleAllUploadsCompleted(int successCount, int totalCount, List<ScheduledUploadItem> completedItems)
    {
        await InvokeAsync(async () =>
        {
            Console.WriteLine($"[All-in-One] ì „ì²´ ì—…ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹  - {successCount}/{totalCount} ì„±ê³µ");
            
            // ğŸ”¥ ì´ì œ ì—¬ê¸°ì„œ resultMessage ì„¤ì •!
            isResultError = (successCount < totalCount);
            
            resultMessage = $"ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" +
                           $"âœ… ì„±ê³µ: {successCount}ê°œ\n" +
                           $"âŒ ì‹¤íŒ¨: {totalCount - successCount}ê°œ\n" +
                           $"ğŸ“Š ì „ì²´: {totalCount}ê°œ";
            
            // ì•Œë¦¼ ë©”ì‹œì§€
            string alertMessage = $"ğŸ‰ All-in-One ì™„ë£Œ!\n\n" +
                                 $"âœ… ì„±ê³µ: {successCount}ê°œ\n" +
                                 $"âŒ ì‹¤íŒ¨: {totalCount - successCount}ê°œ\n" +
                                 $"ğŸ“Š ì „ì²´: {totalCount}ê°œ\n\n";
            
            // ì„±ê³µí•œ í•­ëª©ë“¤ì˜ URL í‘œì‹œ (ìµœëŒ€ 3ê°œ)
            var successfulItems = completedItems.Where(x => x.Status == "ì™„ë£Œ" && !string.IsNullOrEmpty(x.UploadedUrl)).Take(3).ToList();
            if (successfulItems.Any())
            {
                alertMessage += "ì—…ë¡œë“œëœ ì˜ìƒ:\n";
                foreach (var item in successfulItems)
                {
                    alertMessage += $"â€¢ {item.Title}\n";
                }
            }
            
            await JSRuntime.InvokeVoidAsync("alert", alertMessage);
            
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        // ì´ë²¤íŠ¸ êµ¬ë… í•´ì œ
        ScheduledUploadService.OnAllUploadsCompleted -= HandleAllUploadsCompleted;
        
        // scheduleInfoTimer â†’ scheduleStatusTimerë¡œ ìˆ˜ì •
        scheduleStatusTimer?.Stop();
        scheduleStatusTimer?.Dispose();
    }
}
