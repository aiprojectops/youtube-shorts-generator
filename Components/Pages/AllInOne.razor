@page "/all-in-one"
@rendermode InteractiveServer
@using YouTubeShortsWebApp
@inject IJSRuntime JSRuntime
@inject ScheduledUploadService ScheduledUploadService
@using System.Web

<PageTitle>All-in-One ìë™í™”</PageTitle>

<h1>All-in-One ìë™ ì˜ìƒ ìƒì„± & ì—…ë¡œë“œ</h1>
<p class="text-muted">ì˜ìƒ ìƒì„±ë¶€í„° YouTube ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œê¹Œì§€ í•œ ë²ˆì— ì„¤ì •í•˜ê³  ì‹¤í–‰í•˜ì„¸ìš”.</p>

<div class="container">
    <div class="row">
        <div class="col-md-10">

            <!-- 1. ì˜ìƒ ìƒì„± ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4>1. ì˜ìƒ ìƒì„± ì„¤ì •</h4>
                </div>
                <div class="card-body">
                    <!-- ì˜ìƒ ì†ŒìŠ¤ ì„ íƒ -->
                    <div class="mb-4">
                        <label class="form-label"><strong>ì˜ìƒ ì†ŒìŠ¤:</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoSource" id="generateVideo"
                                   @onchange="() => SetVideoSource(true)" checked="@isGenerateVideo" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="generateVideo">
                                <strong>ìƒˆë¡œ ìƒì„±</strong> - AIë¡œ ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoSource" id="useLocalVideo"
                                   @onchange="() => SetVideoSource(false)" checked="@(!isGenerateVideo)" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="useLocalVideo">
                                <strong>ë¡œì»¬ íŒŒì¼ ì‚¬ìš©</strong> - ê¸°ì¡´ì— ìˆëŠ” ì˜ìƒ íŒŒì¼ë“¤ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤
                            </label>
                        </div>
                    </div>

                    @if (isGenerateVideo)
                    {
                        <!-- AI ì˜ìƒ ìƒì„± ì˜µì…˜ë“¤ -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label"><strong>ìƒì„±í•  ì˜ìƒ ê°œìˆ˜: @videoCount ê°œ</strong></label>
                                <input type="range" class="form-range" min="1" max="10" @bind="videoCount" @bind:after="OnVideoCountChanged" disabled="@(isRunning || hasActiveSchedule)" />
                                <div class="text-primary">ì´ ì˜ˆìƒ ë¹„ìš©: $@totalCost</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><strong>ì˜ìƒ ê¸¸ì´:</strong></label>
                                <div>
                                    <button type="button" class="btn @GetDurationClass(5)" @onclick="@(() => selectedDuration = 5)" disabled="@(isRunning || hasActiveSchedule)">5ì´ˆ</button>
                                    <button type="button" class="btn @GetDurationClass(10)" @onclick="@(() => selectedDuration = 10)" disabled="@(isRunning || hasActiveSchedule)">10ì´ˆ</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><strong>í™”ë©´ ë¹„ìœ¨:</strong></label>
                                <div>
                                    <button type="button" class="btn @GetAspectClass("9:16")" @onclick="@(() => selectedAspectRatio = "9:16")" disabled="@(isRunning || hasActiveSchedule)">9:16</button>
                                    <button type="button" class="btn @GetAspectClass("16:9")" @onclick="@(() => selectedAspectRatio = "16:9")" disabled="@(isRunning || hasActiveSchedule)">16:9</button>
                                    <button type="button" class="btn @GetAspectClass("1:1")" @onclick="@(() => selectedAspectRatio = "1:1")" disabled="@(isRunning || hasActiveSchedule)">1:1</button>
                                </div>
                            </div>
                        </div>

                        <!-- CSV íŒŒì¼ ì—…ë¡œë“œ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ëœë¤ í”„ë¡¬í”„íŠ¸ CSV íŒŒì¼:</strong></label>
                            <InputFile OnChange="HandleCsvFileSelection" accept=".csv" class="form-control" disabled="@(isRunning || hasActiveSchedule)" />
                            <div class="form-text">CSV íŒŒì¼ í˜•ì‹: ì²« ë²ˆì§¸ ì—´ì€ ë²ˆí˜¸, ë‘ ë²ˆì§¸ ì—´ì€ í”„ë¡¬í”„íŠ¸ ë‚´ìš©</div>

                            @if (csvPrompts.Count > 0)
                            {
                                <div class="mt-2 alert alert-success">
                                    <strong>ë¡œë“œëœ í”„ë¡¬í”„íŠ¸:</strong> @csvPrompts.Count ê°œ
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="ShowCsvPreview" disabled="@(isRunning || hasActiveSchedule)">
                                        ë¯¸ë¦¬ë³´ê¸°
                                    </button>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- ë¡œì»¬ íŒŒì¼ ì„ íƒ ì˜µì…˜ë“¤ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ë¡œì»¬ ì˜ìƒ íŒŒì¼ë“¤:</strong></label>
                            <InputFile OnChange="HandleLocalVideoSelection" accept="video/*" multiple class="form-control" disabled="@(isRunning || hasActiveSchedule)" />
                            <div class="form-text">í•˜ë‚˜ ë˜ëŠ” ì—¬ëŸ¬ ê°œì˜ ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (ê°ê° ìµœëŒ€ 2GB)</div>

                            @if (localVideoFiles.Count > 0)
                            {
                                <div class="mt-2 alert alert-success">
                                    <strong>ì„ íƒëœ íŒŒì¼:</strong> @localVideoFiles.Count ê°œ
                                    <ul class="mb-0 mt-2">
                                        @foreach (var file in localVideoFiles.Take(5))
                                        {
                                            <li>@file.Name (@FormatFileSize(file.Size))</li>
                                        }
                                        @if (localVideoFiles.Count > 5)
                                        {
                                            <li>... ì™¸ @(localVideoFiles.Count - 5)ê°œ ë”</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- 2. í›„ì²˜ë¦¬ ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h4>2. í›„ì²˜ë¦¬ ì„¤ì •</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="enablePostProcessing" id="enablePostProcessing" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="enablePostProcessing">
                                <strong>ì˜ìƒ í›„ì²˜ë¦¬ ì‚¬ìš©</strong>
                            </label>
                        </div>
                    </div>

                    @if (enablePostProcessing)
                    {
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" @bind="addCaption" id="addCaption" disabled="@(isRunning || hasActiveSchedule)">
                                                <label class="form-check-label" for="addCaption">
                                                    <strong>ìº¡ì…˜ ì¶”ê°€</strong>
                                                </label>
                                            </div>
                                            @if (addCaption)
                                            {
                                                <div class="mt-2">
                                                    <input type="text" class="form-control form-control-sm" @bind="captionText" placeholder="ìº¡ì…˜ í…ìŠ¤íŠ¸" disabled="@(isRunning || hasActiveSchedule)" />
                                                    <div class="row mt-2">
                                                        <div class="col-4">
                                                            <select class="form-select form-select-sm" @bind="captionPosition" disabled="@(isRunning || hasActiveSchedule)">
                                                                <option value="top">ìƒë‹¨</option>
                                                                <option value="center">ì¤‘ì•™</option>
                                                                <option value="bottom">í•˜ë‹¨</option>
                                                                <option value="random">ëœë¤</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-4">
                                                            <select class="form-select form-select-sm" @bind="captionSize" disabled="@(isRunning || hasActiveSchedule)">
                                                                <option value="60">ì‘ê²Œ</option>
                                                                <option value="80">ë³´í†µ</option>
                                                                <option value="120">í¬ê²Œ</option>
                                                                <option value="random">ëœë¤</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-4">
                                                            <select class="form-select form-select-sm" @bind="captionColor" disabled="@(isRunning || hasActiveSchedule)">
                                                                <option value="white">í°ìƒ‰</option>
                                                                <option value="yellow">ë…¸ë€ìƒ‰</option>
                                                                <option value="red">ë¹¨ê°„ìƒ‰</option>
                                                                <option value="black">ê²€ì •ìƒ‰</option>
                                                                <option value="random">ëœë¤</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" @bind="addBackgroundMusic" id="addBackgroundMusic" disabled="@(isRunning || hasActiveSchedule)">
                                                <label class="form-check-label" for="addBackgroundMusic">
                                                    <strong>ë°°ê²½ìŒì•… ì¶”ê°€</strong>
                                                </label>
                                            </div>
                                            @if (addBackgroundMusic)
                                            {
                                                <div class="mt-2">
                                                    <!-- ìŒì•… íŒŒì¼ ì—…ë¡œë“œ ì¶”ê°€ -->
                                                    <div class="mb-2">
                                                        <label class="form-label form-label-sm">ë°°ê²½ìŒì•… íŒŒì¼:</label>
                                                        <InputFile OnChange="HandleMusicFileSelection" accept="audio/*" class="form-control form-control-sm" disabled="@(isRunning || hasActiveSchedule)" />
                                                        <div class="form-text">ì§€ì› í˜•ì‹: MP3, WAV, M4A, AAC (ìµœëŒ€ 10MB)</div>
                                                        
                                                        @if (selectedMusicFile != null)
                                                        {
                                                            <div class="mt-1 text-success small">
                                                                ì„ íƒëœ íŒŒì¼: @selectedMusicFile.Name (@FormatFileSize(selectedMusicFile.Size))
                                                            </div>
                                                        }
                                                    </div>
                                                    <label class="form-label form-label-sm">ìŒëŸ‰: @musicVolume</label>
                                                    <input type="range" class="form-range" min="0.1" max="1.0" step="0.1" @bind="musicVolume" disabled="@(isRunning || hasActiveSchedule)" />
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- 3. YouTube ì—…ë¡œë“œ ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h4>3. YouTube ì—…ë¡œë“œ ì„¤ì •</h4>
                </div>
                <div class="card-body">
                    <!-- YouTube ê³„ì • ìƒíƒœ -->
                    <div class="mb-3">
                        @if (currentYouTubeAccount == null)
                        {
                            <div class="alert alert-warning">
                                <strong>YouTube ê³„ì • ì—°ë™ í•„ìš”</strong>
                                <button type="button" class="btn btn-danger btn-sm ms-2" @onclick="AuthenticateYouTube" disabled="@(isAuthenticating || isRunning)">
                                    @if (isAuthenticating)
                                    {
                                        <span>ì¸ì¦ ì¤‘...</span>
                                    }
                                    else
                                    {
                                        <span>ê³„ì • ì—°ë™</span>
                                    }
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-success">
                                <strong>ì—°ë™ëœ ê³„ì •:</strong> @currentYouTubeAccount.ChannelTitle
                                <small class="text-muted ms-2">êµ¬ë…ì: @FormatSubscriberCount(currentYouTubeAccount.SubscriberCount)ëª…</small>
                                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" @onclick="SwitchYouTubeAccount" disabled="@(isRunning || hasActiveSchedule)">
                                    ê³„ì • ì „í™˜
                                </button>
                            </div>
                        }
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><strong>ì œëª© í…œí”Œë¦¿:</strong></label>
                                <input type="text" class="form-control" @bind="titleTemplate" placeholder="ì˜ˆ: Runmoa #NUMBER" disabled="@(isRunning || hasActiveSchedule)" />
                                <div class="form-text">#NUMBERëŠ” ìë™ìœ¼ë¡œ #1, #2, #3... ìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label"><strong>ì„¤ëª…:</strong></label>
                                <textarea class="form-control" rows="3" @bind="youtubeDescription" placeholder="ì˜ìƒ ì„¤ëª…" disabled="@(isRunning || hasActiveSchedule)"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><strong>ê³µê°œ ì„¤ì •:</strong></label>
                                <select class="form-select" @bind="youtubePrivacy" disabled="@(isRunning || hasActiveSchedule)">
                                    <option value="ë¹„ê³µê°œ">ë¹„ê³µê°œ</option>
                                    <option value="ê³µê°œ">ê³µê°œ</option>
                                    <option value="ë§í¬ ê³µìœ ">ë§í¬ ê³µìœ </option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label"><strong>íƒœê·¸:</strong></label>
                                <input type="text" class="form-control" @bind="youtubeTags" placeholder="íƒœê·¸1, íƒœê·¸2, íƒœê·¸3" disabled="@(isRunning || hasActiveSchedule)" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. ì—…ë¡œë“œ ë°©ì‹ ì„¤ì • -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h4>4. ì—…ë¡œë“œ ë°©ì‹ ì„¤ì •</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="uploadMode" id="immediateUpload"
                                   @onchange="() => SetUploadMode(false)" checked="@(!isScheduleUpload)" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="immediateUpload">
                                <strong>ì¦‰ì‹œ ì—…ë¡œë“œ</strong> - ì˜ìƒ ìƒì„± ì™„ë£Œ í›„ ë°”ë¡œ ìˆœì°¨ ì—…ë¡œë“œ
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="uploadMode" id="scheduleUpload"
                                   @onchange="() => SetUploadMode(true)" checked="@isScheduleUpload" disabled="@(isRunning || hasActiveSchedule)">
                            <label class="form-check-label" for="scheduleUpload">
                                <strong>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ</strong> - ì§€ì •ëœ ì‹œê°„ì— ëœë¤í•˜ê²Œ ìë™ ì—…ë¡œë“œ
                            </label>
                        </div>
                    </div>

                    @if (isScheduleUpload)
                    {
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">ì—…ë¡œë“œ ê¸°ê°„: @scheduleHours ì‹œê°„</label>
                                <input type="range" class="form-range" min="0.5" max="24" step="0.5" @bind="scheduleHours" @bind:after="UpdateSchedulePreview" disabled="@(isRunning || hasActiveSchedule)" />
                                <div class="form-text">@scheduleHours ì‹œê°„ ë™ì•ˆ ì—…ë¡œë“œë¥¼ ë¶„ì‚°</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ìµœì†Œ ê°„ê²©: @minIntervalMinutes ë¶„</label>
                                <input type="range" class="form-range" min="2" max="180" @bind="minIntervalMinutes" @bind:after="UpdateSchedulePreview" disabled="@(isRunning || hasActiveSchedule)" />
                                <div class="form-text">ì—…ë¡œë“œ ê°„ ìµœì†Œ @minIntervalMinutes ë¶„ ê°„ê²©</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" @bind="randomizeOrder" @bind:after="UpdateSchedulePreview" id="randomizeOrder" disabled="@(isRunning || hasActiveSchedule)">
                                    <label class="form-check-label" for="randomizeOrder">
                                        ì—…ë¡œë“œ ìˆœì„œ ëœë¤í™”
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸° -->
                        @if (schedulePreviewList.Count > 0)
                        {
                            <div class="mt-3 alert alert-info">
                                <h6>ì˜ˆìƒ ì—…ë¡œë“œ ìŠ¤ì¼€ì¤„:</h6>
                                <ul class="mb-0">
                                    @foreach (var item in schedulePreviewList.Take(5))
                                    {
                                        <li>ì˜ìƒ #@item.Index -> @item.ScheduledTime.ToString("MM/dd HH:mm")</li>
                                    }
                                    @if (schedulePreviewList.Count > 5)
                                    {
                                        <li>... ì´ @schedulePreviewList.Count ê°œ</li>
                                    }
                                </ul>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" @onclick="UpdateSchedulePreview" disabled="@(isRunning || hasActiveSchedule)">
                                    ìŠ¤ì¼€ì¤„ ë‹¤ì‹œ ê³„ì‚°
                                </button>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- 5. ì‹¤í–‰ ë²„íŠ¼ -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <button type="button" class="btn btn-success btn-lg px-5" @onclick="StartAllInOne"
                            disabled="@(!CanStart || isRunning)">
                        @if (isRunning)
                        {
                            <span>ì‹¤í–‰ ì¤‘...</span>
                        }
                        else if (hasActiveSchedule)
                        {
                            <span>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì§„í–‰ ì¤‘...</span>
                        }
                        else
                        {
                            <span>ğŸš€ All-in-One ì‹œì‘</span>
                        }
                    </button>

                    @if (isRunning)
                    {
                        <button type="button" class="btn btn-outline-danger btn-lg px-3 ms-3" @onclick="StopAllInOne">
                            ì¤‘ì§€
                        </button>
                    }
                </div>
            </div>

            <!-- ì§„í–‰ë¥  í‘œì‹œ -->
            @if (isRunning)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>ì§„í–‰ ìƒí™©</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 style="width: @(currentProgress)%"></div>
                        </div>
                        <div class="text-info">@statusMessage</div>
                        @if (!string.IsNullOrEmpty(currentPromptUsed))
                        {
                            <div class="text-muted small mt-1">í˜„ì¬ í”„ë¡¬í”„íŠ¸: @currentPromptUsed</div>
                        }

                        <!-- ìƒì„±ëœ ì˜ìƒ ëª©ë¡ -->
                        @if (generatedVideos.Count > 0)
                        {
                            <div class="mt-3">
                                <h6>ìƒì„±ëœ ì˜ìƒ:</h6>
                                <ul class="list-group">
                                    @foreach (var video in generatedVideos)
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>@video.FileName</span>
                                            <span class="badge bg-@(video.IsScheduled ? "success" : "secondary")">
                                                @(video.IsScheduled ? "ìŠ¤ì¼€ì¤„ ë“±ë¡ë¨" : "ì²˜ë¦¬ ì¤‘")
                                            </span>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- ìŠ¤ì¼€ì¤„ ì§„í–‰ë¥  í‘œì‹œ -->
            @if (hasActiveSchedule && !isRunning)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì§„í–‰ ì¤‘</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100%"></div>
                        </div>
                        <div class="text-info">@statusMessage</div>
                        <div class="text-muted small">ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œí•˜ì§€ ë§ˆì„¸ìš”. ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ ì—…ë¡œë“œê°€ ì§„í–‰ë©ë‹ˆë‹¤.</div>

                        <!-- ë‹¤ìŒ ì—…ë¡œë“œ ì˜ˆì • ì‹œê°„ ì¶”ê°€ -->
                        @if (!string.IsNullOrEmpty(nextUploadInfo))
                        {
                            <div class="mt-2 alert alert-info">
                                <small><strong>ë‹¤ìŒ ì—…ë¡œë“œ:</strong> @nextUploadInfo</small>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- ì™„ë£Œ ê²°ê³¼ -->
            @if (!string.IsNullOrEmpty(resultMessage))
            {
                <div class="alert @GetResultAlertClass()">
                    <h5>@GetResultTitle()</h5>
                    <p>@resultMessage</p>
                </div>
            }

        </div>
    </div>
</div>

<!-- CSV ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
@if (showCsvPreview)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h5>
                    <button type="button" class="btn-close" @onclick="() => showCsvPreview = false" disabled="@(isRunning || hasActiveSchedule)"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ì´ @csvPrompts.Count ê°œì˜ í”„ë¡¬í”„íŠ¸ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        @for (int i = 0; i < Math.Min(10, csvPrompts.Count); i++)
                        {
                            <div class="mb-2">
                                <strong>@(i + 1).</strong> @csvPrompts[i]
                            </div>
                        }
                        @if (csvPrompts.Count > 10)
                        {
                            <div class="text-muted">... ì™¸ @(csvPrompts.Count - 10) ê°œ ë”</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showCsvPreview = false" disabled="@(isRunning || hasActiveSchedule)">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
}

// 7. UI í‘œì‹œ
@if (addBackgroundMusic)
{
    <div class="mt-2">
        <div class="mb-2">
            <label class="form-label form-label-sm">ë°°ê²½ìŒì•… íŒŒì¼:</label>
            <InputFile OnChange="HandleMusicFileSelection" accept="audio/*" class="form-control form-control-sm" disabled="@isGenerating" />
            <div class="form-text">ì§€ì› í˜•ì‹: MP3, WAV, M4A, AAC (ìµœëŒ€ 10MB)</div>
            
            @if (!string.IsNullOrEmpty(savedMusicFilePath) && File.Exists(savedMusicFilePath))
            {
                <div class="mt-1 alert alert-success py-1 px-2 small">
                    âœ“ ì €ì¥ë¨: @Path.GetFileName(savedMusicFilePath) (ì„¸ì…˜ ë™ì•ˆ ì¬ì‚¬ìš©)
                </div>
            }
            else if (selectedMusicFile != null)
            {
                <div class="mt-1 text-warning small">
                    íŒŒì¼ ì¤€ë¹„ ì¤‘...
                </div>
            }
        </div>
        <label class="form-label form-label-sm">ìŒëŸ‰: @musicVolume</label>
        <input type="range" class="form-range" min="0.1" max="1.0" step="0.1"
               @bind="musicVolume" disabled="@isGenerating" />
    </div>
}


@code {
    
    // ì˜ìƒ ì†ŒìŠ¤ ì„¤ì •
    private bool isGenerateVideo = true;
    private List<IBrowserFile> localVideoFiles = new List<IBrowserFile>();

    private bool CanStart =>
        !hasActiveSchedule && 
        currentYouTubeAccount != null &&
        !string.IsNullOrWhiteSpace(titleTemplate) &&
        ((isGenerateVideo && csvPrompts.Count > 0) || (!isGenerateVideo && localVideoFiles.Count > 0));

    // ì˜ìƒ ìƒì„± ì„¤ì •
    private int videoCount = 5;
    private int selectedDuration = 5;
    private string selectedAspectRatio = "9:16";
    private List<string> csvPrompts = new List<string>();
    private bool showCsvPreview = false;

    // í›„ì²˜ë¦¬ ì„¤ì •
    private bool enablePostProcessing = true;
    private bool addCaption = true;
    private string captionText = "Runmoa.com";
    private string captionPosition = "random";
    private string captionSize = "random";
    private string captionColor = "random";
    private bool addBackgroundMusic = true;
    private float musicVolume = 0.7f;
    private IBrowserFile? selectedMusicFile = null;

    // YouTube ì„¤ì •
    private YouTubeUploader? youtubeUploader;
    private YouTubeUploader.YouTubeAccountInfo? currentYouTubeAccount;
    private bool isAuthenticating = false;
    private string titleTemplate = "Runmoa #NUMBER";
    private string youtubeDescription = "www.runmoa.com";
    private string youtubeTags = "Runmoa, website, 1min";
    private string youtubePrivacy = "ê³µê°œ";

    // ì—…ë¡œë“œ ë°©ì‹ ì„¤ì •
    private bool isScheduleUpload = true;
    private List<SchedulePreviewItem> schedulePreviewList = new List<SchedulePreviewItem>();

    public class SchedulePreviewItem
    {
        public int Index { get; set; }
        public DateTime ScheduledTime { get; set; }
    }

    // ìŠ¤ì¼€ì¤„ ì„¤ì •
    private float scheduleHours = 2.0f;
    private int minIntervalMinutes = 30;
    private bool randomizeOrder = true;

    // ì‹¤í–‰ ìƒíƒœ
    private bool isRunning = false;
    private bool isCancelled = false;
    private int currentProgress = 0;
    private string statusMessage = "";
    private string currentPromptUsed = "";
    private string resultMessage = "";
    private bool isResultError = false;  // ì—ëŸ¬ ì—¬ë¶€ ì¶”ê°€
    private List<GeneratedVideo> generatedVideos = new List<GeneratedVideo>();

    // ìŠ¤ì¼€ì¤„ ìƒíƒœ ì¶”ì 
    private bool hasActiveSchedule = false;
    private System.Timers.Timer? scheduleStatusTimer;
    private string nextUploadInfo = "";

    private IBrowserFile? selectedMusicFile = null;
    private string? savedMusicFilePath = null;  // ì‘ì€ ìŒì•… íŒŒì¼ë§Œ ì„¸ì…˜ì— ë³´ê´€

    public class GeneratedVideo
    {
        public string FileName { get; set; } = "";
        public string FilePath { get; set; } = "";
        public bool IsScheduled { get; set; } = false;
    }

    private string totalCost => (videoCount * (selectedDuration == 5 ? 0.75m : 1.5m)).ToString("F2");

    private string GetDurationClass(int duration)
    {
        return selectedDuration == duration ? "btn-primary" : "btn-outline-primary";
    }

    private string GetAspectClass(string ratio)
    {
        return selectedAspectRatio == ratio ? "btn-success" : "btn-outline-success";
    }

    protected override async Task OnInitializedAsync()
    {
        await CheckExistingYouTubeAuth();
        UpdateSchedulePreview();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // URL ë§¤ê°œë³€ìˆ˜ í™•ì¸ (YouTube ì¸ì¦ ì²˜ë¦¬)
                var uri = new Uri(await JSRuntime.InvokeAsync<string>("eval", "window.location.href"));
                var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
                
                if (query["auth"] == "success")
                {
                    try
                    {
                        youtubeUploader = new YouTubeUploader();
                        bool authCheck = await youtubeUploader.AuthenticateAsync();
                        
                        if (authCheck)
                        {
                            currentYouTubeAccount = await youtubeUploader.GetCurrentAccountInfoAsync();
                            await JSRuntime.InvokeVoidAsync("alert", "YouTube ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                            StateHasChanged();
                        }
                    }
                    catch (Exception ex)
                    {
                        await JSRuntime.InvokeVoidAsync("alert", $"ì¸ì¦ ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
                    }
                }
                else if (query["auth"] == "failed")
                {
                    await JSRuntime.InvokeVoidAsync("alert", "YouTube ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                else if (query["auth"] == "error")
                {
                    string errorMsg = query["message"] ?? "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
                    await JSRuntime.InvokeVoidAsync("alert", $"ì¸ì¦ ì˜¤ë¥˜: {errorMsg}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
            }
        }
    }

    private async Task CheckExistingYouTubeAuth()
    {
        try
        {
            var config = ConfigManager.GetConfig();
            if (!string.IsNullOrEmpty(config.YouTubeClientId) && !string.IsNullOrEmpty(config.YouTubeClientSecret))
            {
                youtubeUploader = new YouTubeUploader();
                bool authSuccess = await youtubeUploader.AuthenticateAsync();

                if (authSuccess)
                {
                    currentYouTubeAccount = await youtubeUploader.GetCurrentAccountInfoAsync();
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ê¸°ì¡´ YouTube ì¸ì¦ í™•ì¸ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private void SetVideoSource(bool generateVideo)
    {
        isGenerateVideo = generateVideo;
        if (!generateVideo && localVideoFiles.Count > 0)
        {
            videoCount = localVideoFiles.Count;
        }
        OnVideoCountChanged();
    }

    private void SetUploadMode(bool scheduleUpload)
    {
        isScheduleUpload = scheduleUpload;
        if (scheduleUpload)
        {
            UpdateSchedulePreview();
        }
    }

    private void OnVideoCountChanged()
    {
        if (isScheduleUpload)
        {
            UpdateSchedulePreview();
        }
        StateHasChanged();
    }

    private async Task HandleCsvFileSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        try
        {
            const long maxSize = 5 * 1024 * 1024; // 5MB
            if (file.Size > maxSize)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            using var stream = file.OpenReadStream(maxSize);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            csvPrompts = ParseCsvContent(content);

            if (csvPrompts.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì—ì„œ ìœ íš¨í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            else
            {
                OnVideoCountChanged(); // ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {ex.Message}");
            csvPrompts.Clear();
        }
    }

    private List<string> ParseCsvContent(string content)
    {
        var prompts = new List<string>();
        var lines = content.Split('\n', StringSplitOptions.RemoveEmptyEntries);

        // ì²« ë²ˆì§¸ ì¤„ì€ í—¤ë”ë¡œ ê±´ë„ˆë›°ê¸°
        for (int i = 1; i < lines.Length; i++)
        {
            var line = lines[i].Trim();
            if (string.IsNullOrEmpty(line)) continue;

            // ê°„ë‹¨í•œ CSV íŒŒì‹± (ë‘ ë²ˆì§¸ ì»¬ëŸ¼ì´ í”„ë¡¬í”„íŠ¸)
            var columns = line.Split(',');
            if (columns.Length >= 2)
            {
                var prompt = columns[1].Trim().Trim('"');
                if (!string.IsNullOrWhiteSpace(prompt))
                {
                    prompts.Add(prompt);
                }
            }
        }

        return prompts;
    }

    private async Task HandleLocalVideoSelection(InputFileChangeEventArgs e)
    {
        localVideoFiles.Clear();
        localVideoFiles.AddRange(e.GetMultipleFiles(20)); // ìµœëŒ€ 20ê°œ íŒŒì¼

        const long maxSizePerFile = 2L * 1024 * 1024 * 1024; // 2GB
        var invalidFiles = localVideoFiles.Where(f => f.Size > maxSizePerFile).ToList();

        if (invalidFiles.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert",
                $"ë‹¤ìŒ íŒŒì¼ë“¤ì´ 2GBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤:\n{string.Join("\n", invalidFiles.Select(f => f.Name))}");

            localVideoFiles = localVideoFiles.Where(f => f.Size <= maxSizePerFile).ToList();
        }

        // ë¡œì»¬ íŒŒì¼ ê°œìˆ˜ë¡œ videoCount ìë™ ì„¤ì •
        if (!isGenerateVideo)
        {
            videoCount = localVideoFiles.Count;
        }

        OnVideoCountChanged();
        StateHasChanged();
    }

    // 2. HandleMusicFileSelection - ìŒì•… íŒŒì¼ë§Œ ì¦‰ì‹œ ì €ì¥
    private async Task HandleMusicFileSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null)
        {
            selectedMusicFile = null;
            // ê¸°ì¡´ íŒŒì¼ ì‚­ì œ
            if (!string.IsNullOrEmpty(savedMusicFilePath) && File.Exists(savedMusicFilePath))
            {
                try
                {
                    File.Delete(savedMusicFilePath);
                    Console.WriteLine($"=== ê¸°ì¡´ ìŒì•… íŒŒì¼ ì‚­ì œ: {savedMusicFilePath}");
                }
                catch { }
            }
            savedMusicFilePath = null;
            return;
        }
    
        try
        {
            const long maxSize = 10 * 1024 * 1024; // 10MB
            if (file.Size > maxSize)
            {
                await JSRuntime.InvokeVoidAsync("alert", "ìŒì•… íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                selectedMusicFile = null;
                return;
            }
    
            // íŒŒì¼ í˜•ì‹ í™•ì¸
            string[] supportedTypes = { "audio/mpeg", "audio/mp3", "audio/wav", "audio/mp4", "audio/aac" };
            if (!supportedTypes.Contains(file.ContentType.ToLower()) && 
                !file.Name.ToLower().EndsWith(".mp3") && 
                !file.Name.ToLower().EndsWith(".wav") && 
                !file.Name.ToLower().EndsWith(".m4a") && 
                !file.Name.ToLower().EndsWith(".aac"))
            {
                await JSRuntime.InvokeVoidAsync("alert", "ì§€ì›ë˜ì§€ ì•ŠëŠ” ìŒì•… íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
                selectedMusicFile = null;
                return;
            }
    
            selectedMusicFile = file;
            
            // ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ ë¨¼ì € ì‚­ì œ
            if (!string.IsNullOrEmpty(savedMusicFilePath) && File.Exists(savedMusicFilePath))
            {
                try
                {
                    File.Delete(savedMusicFilePath);
                }
                catch { }
            }
            
            // ìƒˆ íŒŒì¼ì„ ì„¸ì…˜ì— ì €ì¥ (ì‘ì€ ìŒì•… íŒŒì¼ë§Œ)
            savedMusicFilePath = await SaveMusicFileToSession(file);
            
            Console.WriteLine($"=== ìŒì•… íŒŒì¼ ì„¸ì…˜ì— ì €ì¥ë¨: {Path.GetFileName(savedMusicFilePath)} ({file.Size / 1024} KB)");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ìŒì•… íŒŒì¼ ì„ íƒ ì˜¤ë¥˜: {ex.Message}");
            selectedMusicFile = null;
            savedMusicFilePath = null;
        }
    
        StateHasChanged();
    }

    // 3. ìŒì•… íŒŒì¼ì„ ë‹¨ì¼ íŒŒì¼ë¡œ ì„¸ì…˜ì— ì €ì¥ (í´ë” ìƒì„± ìµœì†Œí™”)
    private async Task<string> SaveMusicFileToSession(IBrowserFile musicFile)
    {
        try
        {
            // ì„¸ì…˜ ìŒì•… í´ë” (ëª¨ë“  ì„¸ì…˜ ê³µìœ , í•˜ë‚˜ì˜ íŒŒì¼ë§Œ ìœ ì§€)
            string musicDir = Path.Combine(Path.GetTempPath(), "SessionMusic");
            Directory.CreateDirectory(musicDir);
            
            string extension = Path.GetExtension(musicFile.Name).ToLower();
            if (string.IsNullOrEmpty(extension))
            {
                extension = ".mp3";
            }
            
            // ê³ ìœ í•œ íŒŒì¼ëª… ìƒì„± (ì¶©ëŒ ë°©ì§€)
            string musicPath = Path.Combine(musicDir, $"music_{Guid.NewGuid()}{extension}");
            
            using (var fileStream = new FileStream(musicPath, FileMode.Create))
            {
                await musicFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(fileStream);
            }
            
            var fileInfo = new FileInfo(musicPath);
            Console.WriteLine($"=== ìŒì•… ì €ì¥: {musicPath} ({fileInfo.Length / 1024} KB)");
            
            return musicPath;
        }
        catch (Exception ex)
        {
            throw new Exception($"ìŒì•… íŒŒì¼ ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    
    private string FormatFileSize(long bytes)
    {
        if (bytes >= 1024 * 1024 * 1024)
            return $"{bytes / 1024.0 / 1024.0 / 1024.0:F2} GB";
        else if (bytes >= 1024 * 1024)
            return $"{bytes / 1024.0 / 1024.0:F2} MB";
        else if (bytes >= 1024)
            return $"{bytes / 1024.0:F2} KB";
        else
            return $"{bytes} bytes";
    }

    private void ShowCsvPreview()
    {
        showCsvPreview = true;
    }


    // AllInOne.razor - AuthenticateYouTube ë©”ì„œë“œ ìˆ˜ì • ë¶€ë¶„
    private async Task AuthenticateYouTube()
    {
        isAuthenticating = true;
    
        try
        {
            var config = ConfigManager.GetConfig();
            if (string.IsNullOrEmpty(config.YouTubeClientId) || string.IsNullOrEmpty(config.YouTubeClientSecret))
            {
                await JSRuntime.InvokeVoidAsync("alert", "ë¨¼ì € ì„¤ì •ì—ì„œ YouTube API ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
    
            youtubeUploader = new YouTubeUploader();
            
            string currentUrl = await JSRuntime.InvokeAsync<string>("eval", "window.location.origin");
            
            // returnPageë¥¼ "all-in-one"ë¡œ ì§€ì •
            string authUrl = await youtubeUploader.GetAuthorizationUrlAsync(currentUrl, "all-in-one");
            
            // ê°™ì€ íƒ­ì—ì„œ ì¸ì¦ í˜ì´ì§€ë¡œ ì´ë™
            await JSRuntime.InvokeVoidAsync("eval", $"window.location.href = '{authUrl}'");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ì¸ì¦ ì˜¤ë¥˜: {ex.Message}");
        }
        finally
        {
            isAuthenticating = false;
        }
    }


    private async Task SwitchYouTubeAccount()
    {
        try
        {
            if (youtubeUploader != null)
            {
                bool success = await youtubeUploader.SwitchAccountAsync();
                if (success)
                {
                    currentYouTubeAccount = await youtubeUploader.GetCurrentAccountInfoAsync();
                }
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ê³„ì • ì „í™˜ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private string FormatSubscriberCount(ulong count)
    {
        if (count >= 1000000)
            return $"{count / 1000000.0:F1}M";
        else if (count >= 1000)
            return $"{count / 1000.0:F1}K";
        else
            return count.ToString();
    }

    private void UpdateSchedulePreview()
    {
        if (!isScheduleUpload) return;

        schedulePreviewList.Clear();
        DateTime startTime = DateTime.Now.AddMinutes(5);
        DateTime endTime = startTime.AddHours(scheduleHours);

        int totalVideos = isGenerateVideo ? videoCount : localVideoFiles.Count;

        for (int i = 0; i < totalVideos; i++)
        {
            DateTime scheduledTime = CalculateRandomUploadTime(startTime, endTime, i, totalVideos);
            schedulePreviewList.Add(new SchedulePreviewItem
            {
                Index = i + 1,
                ScheduledTime = scheduledTime
            });
        }

        schedulePreviewList = schedulePreviewList.OrderBy(x => x.ScheduledTime).ToList();
        StateHasChanged();
    }

    private async Task StartAllInOne()
    {
        if (!CanStart) return;

        // ê²€ì¦
        if (isGenerateVideo)
        {
            var config = ConfigManager.GetConfig();
            if (string.IsNullOrEmpty(config.ReplicateApiKey))
            {
                await JSRuntime.InvokeVoidAsync("alert", "ë¨¼ì € ì„¤ì •ì—ì„œ Replicate API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (csvPrompts.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "ë¨¼ì € CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
                return;
            }
        }
        else
        {
            if (localVideoFiles.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "ì²˜ë¦¬í•  ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
                return;
            }
        }

        // í›„ì²˜ë¦¬ ì˜µì…˜ ê²€ì¦
        if (enablePostProcessing)
        {
            if (addCaption && string.IsNullOrWhiteSpace(captionText))
            {
                await JSRuntime.InvokeVoidAsync("alert", "ìº¡ì…˜ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            bool ffmpegAvailable = await VideoPostProcessor.IsFFmpegAvailableAsync();
            if (!ffmpegAvailable)
            {
                bool proceed = await JSRuntime.InvokeAsync<bool>("confirm",
                    "FFmpegë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ í›„ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní›„ì²˜ë¦¬ ì—†ì´ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");

                if (!proceed)
                {
                    return;
                }
                enablePostProcessing = false;
            }
        }

        isRunning = true;
        isCancelled = false;
        currentProgress = 0;
        generatedVideos.Clear();
        resultMessage = "";

        try
        {
            int totalVideos = isGenerateVideo ? videoCount : localVideoFiles.Count;
            statusMessage = isGenerateVideo ? "ì˜ìƒ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤..." : "ë¡œì»¬ íŒŒì¼ ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...";
            StateHasChanged();

            // 1ë‹¨ê³„: ì˜ìƒ ìƒì„±/ì²˜ë¦¬
            for (int i = 0; i < totalVideos; i++)
            {
                if (isCancelled) break;

                currentProgress = (i * 80 / totalVideos);
                statusMessage = $"ì˜ìƒ {i + 1}/{totalVideos} {(isGenerateVideo ? "ìƒì„±" : "ì²˜ë¦¬")} ì¤‘...";
                StateHasChanged();

                string videoPath = await GenerateOrProcessVideo(i + 1);

                if (!string.IsNullOrEmpty(videoPath))
                {
                    var generatedVideo = new GeneratedVideo
                    {
                        FileName = Path.GetFileName(videoPath),
                        FilePath = videoPath,
                        IsScheduled = false
                    };
                    generatedVideos.Add(generatedVideo);
                }

                StateHasChanged();
            }

            if (!isCancelled && generatedVideos.Count > 0)
            {
                // 2ë‹¨ê³„: ì—…ë¡œë“œ ì²˜ë¦¬
                currentProgress = 85;
                statusMessage = isScheduleUpload ? "YouTube ìŠ¤ì¼€ì¤„ì— ë“±ë¡ ì¤‘..." : "ì¦‰ì‹œ ì—…ë¡œë“œ ì‹œì‘...";
                StateHasChanged();

                await RegisterToSchedule();

                currentProgress = 100;
                statusMessage = "All-in-One ì™„ë£Œ!";

                if (isScheduleUpload)
                {
                    resultMessage = $"{generatedVideos.Count}ê°œ ì˜ìƒì´ {(isGenerateVideo ? "ìƒì„±ë˜ê³ " : "ì²˜ë¦¬ë˜ê³ ")} YouTube ìŠ¤ì¼€ì¤„ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
                    hasActiveSchedule = true;
                    StartScheduleStatusTracking();
                }
                else
                {
                    resultMessage = $"{generatedVideos.Count}ê°œ ì˜ìƒì´ {(isGenerateVideo ? "ìƒì„±ë˜ê³ " : "ì²˜ë¦¬ë˜ê³ ")} ì¦‰ì‹œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.";
                }
            }
            else if (isCancelled)
            {
                statusMessage = "ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                resultMessage = "ì‚¬ìš©ìì— ì˜í•´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
            else
            {
                statusMessage = "ì²˜ë¦¬ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
                resultMessage = "ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì˜ìƒì´ ì—†ì—ˆìŠµë‹ˆë‹¤.";
                isResultError = true;
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"All-in-One ì‹¤í–‰ ì˜¤ë¥˜: {ex.Message}");
            statusMessage = $"ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
            resultMessage = $"ì˜¤ë¥˜ë¡œ ì¸í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤: {ex.Message}";
            isResultError = true;
        }
        finally
        {
            isRunning = false;
            StateHasChanged();
        }
    }

    private string GetResultAlertClass()
    {
        return isResultError ? "alert-danger" : "alert-success";
    }

    private string GetResultTitle()
    {
        return isResultError ? "ì˜¤ë¥˜ ë°œìƒ" : "All-in-One ì™„ë£Œ!";
    }

    private void StopAllInOne()
    {
        isCancelled = true;
        statusMessage = "ì¤‘ì§€ ì¤‘...";
    }

    private async Task<string> GenerateOrProcessVideo(int videoIndex)
    {
        string selectedPrompt = "";
        string combinedPrompt = "";
        string videoUrl = "";

        try
        {
            if (!isGenerateVideo)
            {
                // ë¡œì»¬ íŒŒì¼ ì²˜ë¦¬ ëª¨ë“œ
                if (videoIndex > localVideoFiles.Count)
                {
                    return "";
                }

                var fileToUpload = localVideoFiles[videoIndex - 1];
                currentPromptUsed = $"ë¡œì»¬ íŒŒì¼: {fileToUpload.Name}";

                // ì‹œìŠ¤í…œ ì„ì‹œ í´ë” ì‚¬ìš©
                string tempDir = Path.GetTempPath();
                string fileName = $"allinone_local_{DateTime.Now:yyyyMMdd_HHmmss}_{videoIndex:D2}.mp4";
                string localPath = Path.Combine(tempDir, fileName);

                // ë¸Œë¼ìš°ì € íŒŒì¼ì„ ì„œë²„ë¡œ ë³µì‚¬
                using (var fileStream = new FileStream(localPath, FileMode.Create))
                {
                    await fileToUpload.OpenReadStream(maxAllowedSize: 2L * 1024 * 1024 * 1024).CopyToAsync(fileStream);
                }

                selectedPrompt = fileToUpload.Name;
                combinedPrompt = currentPromptUsed;

                // í›„ì²˜ë¦¬
                string finalPath = localPath;
                if (enablePostProcessing && (addCaption || addBackgroundMusic))
                {
                    string processedPath = await ProcessVideoGen(localPath, fileToUpload.Name);
                    if (File.Exists(localPath)) File.Delete(localPath);
                    finalPath = processedPath;
                }

                // íˆìŠ¤í† ë¦¬ì— ê¸°ë¡ ì¶”ê°€
                var historyItem = new VideoHistoryManager.VideoHistoryItem
                {
                    Prompt = selectedPrompt,
                    FinalPrompt = combinedPrompt,
                    Duration = 0,
                    AspectRatio = "ë¡œì»¬ íŒŒì¼",
                    VideoUrl = "",
                    IsRandomPrompt = false,
                    FileName = Path.GetFileName(finalPath),
                    IsDownloaded = false,
                    IsUploaded = false,
                    Status = "All-in-One (ë¡œì»¬ íŒŒì¼)"
                };
                VideoHistoryManager.AddHistoryItem(historyItem);

                return finalPath;
            }
            else
            {
                // AI ì˜ìƒ ìƒì„± ëª¨ë“œ
                if (csvPrompts.Count == 0)
                {
                    throw new Exception("CSV í”„ë¡¬í”„íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                }

                // ëœë¤ í”„ë¡¬í”„íŠ¸ ì„ íƒ
                Random random = new Random();
                selectedPrompt = csvPrompts[random.Next(csvPrompts.Count)];
                currentPromptUsed = selectedPrompt.Length > 50 ? selectedPrompt.Substring(0, 50) + "..." : selectedPrompt;

                combinedPrompt = ConfigManager.CombinePrompts(selectedPrompt);

                // API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                var config = ConfigManager.GetConfig();
                var replicateClient = new ReplicateClient(config.ReplicateApiKey);

                var request = new ReplicateClient.VideoGenerationRequest
                {
                    prompt = combinedPrompt,
                    duration = selectedDuration,
                    aspect_ratio = selectedAspectRatio,
                    resolution = "1080p",
                    fps = 24,
                    camera_fixed = true
                };

                // ì˜ìƒ ìƒì„±
                var prediction = await replicateClient.StartVideoGeneration(request);

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ìš© Progress ê°ì²´
                var progress = new Progress<ReplicateClient.ProgressInfo>(progressInfo =>
                {
                    InvokeAsync(() =>
                    {
                        int baseProgress = ((videoIndex - 1) * 80 / videoCount);
                        int videoProgress = Math.Min(60, progressInfo.Percentage * 60 / 100);
                        currentProgress = baseProgress + (videoProgress / videoCount);
                        statusMessage = $"ì˜ìƒ {videoIndex}/{videoCount} - {progressInfo.Status}";
                        StateHasChanged();
                    });
                });

                var result = await replicateClient.WaitForCompletion(prediction.id, progress);

                if (result.output != null)
                {
                    videoUrl = result.output.ToString();

                    // ë‹¤ìš´ë¡œë“œ
                    string fileName = $"allinone_ai_{DateTime.Now:yyyyMMdd_HHmmss}_{videoIndex:D2}.mp4";
                    string localPath = await DownloadVideoForGen(videoUrl, fileName);

                    // í›„ì²˜ë¦¬
                    string finalPath = localPath;
                    if (enablePostProcessing && (addCaption || addBackgroundMusic))
                    {
                        string processedPath = await ProcessVideoGen(localPath, selectedPrompt);
                        if (File.Exists(localPath)) File.Delete(localPath);
                        finalPath = processedPath;
                    }

                    // íˆìŠ¤í† ë¦¬ì— ê¸°ë¡ ì¶”ê°€
                    var historyItem = new VideoHistoryManager.VideoHistoryItem
                    {
                        Prompt = selectedPrompt,
                        FinalPrompt = combinedPrompt,
                        Duration = selectedDuration,
                        AspectRatio = selectedAspectRatio,
                        VideoUrl = videoUrl,
                        IsRandomPrompt = true,
                        FileName = Path.GetFileName(finalPath),
                        IsDownloaded = false,
                        IsUploaded = false,
                        Status = "All-in-One (AI ìƒì„±)"
                    };
                    VideoHistoryManager.AddHistoryItem(historyItem);

                    return finalPath;
                }

                return "";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ì˜ìƒ {videoIndex} ìƒì„±/ì²˜ë¦¬ ì‹¤íŒ¨: {ex.Message}");

            // ì‹¤íŒ¨í•œ ê²½ìš°ì—ë„ íˆìŠ¤í† ë¦¬ì— ê¸°ë¡
            if (!string.IsNullOrEmpty(selectedPrompt))
            {
                var historyItem = new VideoHistoryManager.VideoHistoryItem
                {
                    Prompt = selectedPrompt,
                    FinalPrompt = combinedPrompt,
                    Duration = isGenerateVideo ? selectedDuration : 0,
                    AspectRatio = isGenerateVideo ? selectedAspectRatio : "ë¡œì»¬ íŒŒì¼",
                    VideoUrl = videoUrl,
                    IsRandomPrompt = isGenerateVideo,
                    FileName = $"ì‹¤íŒ¨_{DateTime.Now:HHmmss}",
                    IsDownloaded = false,
                    IsUploaded = false,
                    Status = $"All-in-One ì‹¤íŒ¨: {ex.Message.Substring(0, Math.Min(50, ex.Message.Length))}"
                };
                VideoHistoryManager.AddHistoryItem(historyItem);
            }

            return "";
        }
    }

    // í›„ì²˜ë¦¬ìš© ì˜ìƒ ë‹¤ìš´ë¡œë“œ
    private async Task<string> DownloadVideoForGen(string videoUrl, string fileName)
    {
        try
        {
            using var httpClient = new System.Net.Http.HttpClient();
            httpClient.Timeout = TimeSpan.FromMinutes(10);

            string tempFolder = Path.GetTempPath();
            string safeFileName = $"allinone_{Guid.NewGuid()}.mp4";
            string localPath = Path.Combine(tempFolder, safeFileName);

            byte[] videoBytes = await httpClient.GetByteArrayAsync(videoUrl);
            await File.WriteAllBytesAsync(localPath, videoBytes);

            return localPath;
        }
        catch (Exception ex)
        {
            throw new Exception($"í›„ì²˜ë¦¬ìš© ì˜ìƒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
        }
    }


    // 4. ProcessVideoGenì—ì„œ ë°°ê²½ìŒì•… ì‚¬ìš© (ì˜ìƒ íŒŒì¼ì€ ì¦‰ì‹œ ì‚­ì œ)
    private async Task<string> ProcessVideoGen(string inputPath, string promptText)
    {
        try
        {
            string outputPath = inputPath.Replace(".mp4", "_processed.mp4");
    
            // ëœë¤ ì²˜ë¦¬ ë¡œì§...
            string actualCaptionPosition = captionPosition == "random" ? /* ... */ : captionPosition;
            string actualCaptionSize = captionSize == "random" ? /* ... */ : captionSize;
            string actualCaptionColor = captionColor == "random" ? /* ... */ : captionColor;
    
            var options = new VideoPostProcessor.ProcessingOptions
            {
                InputVideoPath = inputPath,
                OutputVideoPath = outputPath
            };
    
            // ìº¡ì…˜ ì¶”ê°€
            if (addCaption && !string.IsNullOrWhiteSpace(captionText))
            {
                options.CaptionText = captionText;
                options.FontSize = actualCaptionSize;
                options.FontColor = actualCaptionColor;
                options.CaptionPosition = actualCaptionPosition;
            }
    
            // ë°°ê²½ìŒì•… ì¶”ê°€ - ì„¸ì…˜ì— ì €ì¥ëœ íŒŒì¼ ì‚¬ìš©
            if (addBackgroundMusic)
            {
                try
                {
                    string musicPath = "";
                    
                    // ìš°ì„ ìˆœìœ„: ì„¸ì…˜ì— ì €ì¥ëœ íŒŒì¼ > ê¸°ë³¸ ìŒì•…
                    if (!string.IsNullOrEmpty(savedMusicFilePath) && File.Exists(savedMusicFilePath))
                    {
                        musicPath = savedMusicFilePath;
                        Console.WriteLine($"=== ì„¸ì…˜ ìŒì•… ì‚¬ìš©: {Path.GetFileName(musicPath)}");
                    }
                    else
                    {
                        // ê¸°ë³¸ ìŒì•… ì‚¬ìš©
                        musicPath = await VideoPostProcessor.DownloadSampleMusicAsync();
                        Console.WriteLine($"=== ê¸°ë³¸ ìŒì•… ì‚¬ìš©");
                    }
                    
                    if (File.Exists(musicPath))
                    {
                        options.BackgroundMusicPath = musicPath;
                        options.MusicVolume = musicVolume;
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"=== ë°°ê²½ìŒì•… ì¤€ë¹„ ì‹¤íŒ¨: {ex.Message}");
                }
            }
    
            var progress = new Progress<string>(status =>
            {
                InvokeAsync(() =>
                {
                    statusMessage = status;
                    StateHasChanged();
                });
            });
    
            string processedPath = await VideoPostProcessor.ProcessVideoAsync(options, progress);
            
            // â˜… ì¤‘ìš”: ì›ë³¸ ì…ë ¥ íŒŒì¼ ì¦‰ì‹œ ì‚­ì œ (ë””ìŠ¤í¬ ìš©ëŸ‰ ì ˆì•½)
            try
            {
                if (File.Exists(inputPath))
                {
                    File.Delete(inputPath);
                    Console.WriteLine($"=== ì›ë³¸ íŒŒì¼ ì‚­ì œ: {Path.GetFileName(inputPath)}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"=== ì›ë³¸ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: {ex.Message}");
            }
            
            return processedPath;
        }
        catch (Exception ex)
        {
            throw new Exception($"ì˜ìƒ í›„ì²˜ë¦¬ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    // 5. ê°œë³„ ì˜ìƒ ì²˜ë¦¬ í›„ ì¦‰ì‹œ ì •ë¦¬ (AllInOne/VideoGenerator ê³µí†µ)
    private async Task ProcessIndividualVideoGen(string videoPath, int videoIndex, string originalPrompt, string combinedPrompt)
    {
        try
        {
            Console.WriteLine($"=== ì˜ìƒ {videoIndex} ì²˜ë¦¬ ì‹œì‘");
            
            // ì²˜ë¦¬ ì „ ë©”ëª¨ë¦¬ ì •ë¦¬
            GC.Collect();
            GC.WaitForPendingFinalizers();
            
            string finalVideoPath = videoPath;
            
            // í›„ì²˜ë¦¬ ìˆ˜í–‰
            if (enablePostProcessing && (addCaption || addBackgroundMusic))
            {
                string processedPath = await ProcessVideoGen(videoPath, originalPrompt);
                // ProcessVideoGen ë‚´ë¶€ì—ì„œ ì´ë¯¸ ì›ë³¸ ì‚­ì œë¨
                finalVideoPath = processedPath;
            }
            
            // ë‹¤ìš´ë¡œë“œ/ì—…ë¡œë“œ ì²˜ë¦¬...
            await TriggerBrowserDownloadFromFileGen(finalVideoPath, downloadFileName);
            // ë˜ëŠ” await UploadToYouTube(finalVideoPath);
            
            // â˜… ì¤‘ìš”: ì²˜ë¦¬ ì™„ë£Œëœ íŒŒì¼ë„ ì¦‰ì‹œ ì‚­ì œ
            try
            {
                if (File.Exists(finalVideoPath))
                {
                    File.Delete(finalVideoPath);
                    Console.WriteLine($"=== ì²˜ë¦¬ ì™„ë£Œ íŒŒì¼ ì‚­ì œ: {Path.GetFileName(finalVideoPath)}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"=== íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: {ex.Message}");
            }
            
            // ì²˜ë¦¬ í›„ ë©”ëª¨ë¦¬ ì •ë¦¬
            GC.Collect();
            GC.WaitForPendingFinalizers();
            
            Console.WriteLine($"=== ì˜ìƒ {videoIndex} ì²˜ë¦¬ ì™„ë£Œ ë° ì •ë¦¬");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"=== ì˜ìƒ {videoIndex} ì²˜ë¦¬ ì‹¤íŒ¨: {ex.Message}");
            throw;
        }
    }


    // ì—…ë¡œë“œëœ ìŒì•… íŒŒì¼ì„ ì„ì‹œ ì €ì¥
    private async Task<string> SaveUploadedMusicFileAsync(IBrowserFile musicFile)
    {
        try
        {
            string tempDir = Path.GetTempPath();
            string extension = Path.GetExtension(musicFile.Name).ToLower();
            if (string.IsNullOrEmpty(extension))
            {
                extension = ".mp3";
            }
            
            string musicPath = Path.Combine(tempDir, $"allinone_music_{Guid.NewGuid()}{extension}");
            
            using (var fileStream = new FileStream(musicPath, FileMode.Create))
            {
                await musicFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(fileStream);
            }
            
            return musicPath;
        }
        catch (Exception ex)
        {
            throw new Exception($"ì—…ë¡œë“œëœ ìŒì•… íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private async Task RegisterToSchedule()
    {
        if (isScheduleUpload)
        {
            // ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ
            DateTime startTime = DateTime.Now.AddMinutes(5);
            DateTime endTime = startTime.AddHours(scheduleHours);

            var filesToSchedule = randomizeOrder
                ? generatedVideos.OrderBy(x => Guid.NewGuid()).ToList()
                : generatedVideos.ToList();

            for (int i = 0; i < filesToSchedule.Count; i++)
            {
                DateTime scheduledTime = CalculateRandomUploadTime(startTime, endTime, i, filesToSchedule.Count);

                string title = titleTemplate.Replace("#NUMBER", $"#{i + 1}");

                var uploadItem = new ScheduledUploadItem
                {
                    FileName = filesToSchedule[i].FileName,
                    FilePath = filesToSchedule[i].FilePath,
                    ScheduledTime = scheduledTime,
                    Title = title,
                    Description = youtubeDescription,
                    Tags = youtubeTags,
                    PrivacySetting = youtubePrivacy
                };

                ScheduledUploadService.AddScheduledUpload(uploadItem);
                filesToSchedule[i].IsScheduled = true;
            }
        }
        else
        {
            // ì¦‰ì‹œ ì—…ë¡œë“œ
            await StartImmediateUpload();
        }
    }

    private async Task StartImmediateUpload()
    {
        statusMessage = "ì¦‰ì‹œ ì—…ë¡œë“œ ì‹œì‘...";
        var uploadedUrls = new List<string>();

        for (int i = 0; i < generatedVideos.Count; i++)
        {
            if (isCancelled) break;

            try
            {
                var video = generatedVideos[i];
                string title = titleTemplate.Replace("#NUMBER", $"#{i + 1}");

                statusMessage = $"ì—…ë¡œë“œ ì¤‘... ({i + 1}/{generatedVideos.Count}) {title}";
                StateHasChanged();

                // ì„ì‹œ íŒŒì¼ë¡œ ë³µì‚¬ (YouTube ì—…ë¡œë“œìš©)
                string tempFilePath = Path.GetTempFileName();
                string actualTempPath = Path.ChangeExtension(tempFilePath, ".mp4");
                File.Copy(video.FilePath, actualTempPath, true);

                var uploadInfo = new YouTubeUploader.VideoUploadInfo
                {
                    FilePath = actualTempPath,
                    Title = title,
                    Description = youtubeDescription,
                    Tags = youtubeTags,
                    PrivacyStatus = youtubePrivacy
                };

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ìš© Progress ê°ì²´
                var progress = new Progress<YouTubeUploader.UploadProgressInfo>(progressInfo =>
                {
                    InvokeAsync(() =>
                    {
                        int baseProgress = 85 + (i * 15 / generatedVideos.Count);
                        int uploadProgress = progressInfo.Percentage * 15 / 100 / generatedVideos.Count;
                        currentProgress = Math.Max(currentProgress, baseProgress + uploadProgress);
                        statusMessage = $"ì—…ë¡œë“œ ì¤‘... ({i + 1}/{generatedVideos.Count}) {title} - {progressInfo.Status}";
                        StateHasChanged();
                    });
                });

                string videoUrl = await youtubeUploader.UploadVideoAsync(uploadInfo, progress);
                uploadedUrls.Add(videoUrl);

                video.IsScheduled = true; // ì—…ë¡œë“œ ì™„ë£Œ í‘œì‹œ

                // ì„ì‹œ íŒŒì¼ ì‚­ì œ
                if (File.Exists(actualTempPath))
                {
                    File.Delete(actualTempPath);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ì˜ìƒ {i + 1} ì—…ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
                await JSRuntime.InvokeVoidAsync("alert", $"ì˜ìƒ {i + 1} ì—…ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
            }

            StateHasChanged();
        }

        statusMessage = $"ì¦‰ì‹œ ì—…ë¡œë“œ ì™„ë£Œ! ì„±ê³µ: {uploadedUrls.Count}ê°œ";
    }

    private void StartScheduleStatusTracking()
    {
        // 30ì´ˆë§ˆë‹¤ ìŠ¤ì¼€ì¤„ ìƒíƒœ í™•ì¸
        scheduleStatusTimer = new System.Timers.Timer(30000);
        scheduleStatusTimer.Elapsed += CheckScheduleStatus;
        scheduleStatusTimer.AutoReset = true;
        scheduleStatusTimer.Start();
    }

    private void CheckScheduleStatus(object sender, System.Timers.ElapsedEventArgs e)
    {
        try
        {
            int queueCount = ScheduledUploadService.GetQueueCount();
            var allItems = ScheduledUploadService.GetAllScheduledItems();

            InvokeAsync(() =>
            {
                if (queueCount == 0 && hasActiveSchedule)
                {
                    // ëª¨ë“  ìŠ¤ì¼€ì¤„ ì™„ë£Œ
                    hasActiveSchedule = false;
                    scheduleStatusTimer?.Stop();
                    scheduleStatusTimer?.Dispose();
                    scheduleStatusTimer = null;

                    statusMessage = "ëª¨ë“  ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                    resultMessage = "ëª¨ë“  ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.";
                    nextUploadInfo = "";
                }
                else if (hasActiveSchedule)
                {
                    statusMessage = $"ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì§„í–‰ ì¤‘... (ëŒ€ê¸°: {queueCount}ê°œ)";

                    // ë‹¤ìŒ ì—…ë¡œë“œ ì •ë³´ ìƒì„±
                    var nextUpload = allItems
                        .Where(x => x.Status == "ëŒ€ê¸° ì¤‘")
                        .OrderBy(x => x.ScheduledTime)
                        .FirstOrDefault();

                    if (nextUpload != null)
                    {
                        var timeUntil = nextUpload.ScheduledTime - DateTime.Now;
                        if (timeUntil.TotalMinutes > 0)
                        {
                            string fileName = nextUpload.FileName.Length > 30 
                                ? nextUpload.FileName.Substring(0, 27) + "..."
                                : nextUpload.FileName;

                            if (timeUntil.TotalHours >= 1)
                            {
                                nextUploadInfo = $"{fileName} - {nextUpload.ScheduledTime:MM/dd HH:mm} ({timeUntil.Hours}ì‹œê°„ {timeUntil.Minutes}ë¶„ í›„)";
                            }
                            else
                            {
                                nextUploadInfo = $"{fileName} - {nextUpload.ScheduledTime:MM/dd HH:mm} ({(int)timeUntil.TotalMinutes}ë¶„ í›„)";
                            }
                        }
                        else
                        {
                            nextUploadInfo = $"{nextUpload.FileName} - ê³§ ì—…ë¡œë“œ ì˜ˆì •";
                        }
                    }
                    else
                    {
                        nextUploadInfo = "";
                    }
                }

                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ìŠ¤ì¼€ì¤„ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜: {ex.Message}");
        }
    }

    private DateTime CalculateRandomUploadTime(DateTime startTime, DateTime endTime, int index, int totalCount)
    {
        double totalMinutes = (endTime - startTime).TotalMinutes;
        double segmentMinutes = totalMinutes / totalCount;

        double segmentStart = index * segmentMinutes;
        double segmentEnd = Math.Min((index + 1) * segmentMinutes, totalMinutes);

        Random random = new Random();
        double randomMinutes = segmentStart + (random.NextDouble() * (segmentEnd - segmentStart));

        // ìµœì†Œ ê°„ê²© ì¡°ê±´ (ì „ì²´ ê¸°ê°„ì´ ì¶©ë¶„í•  ë•Œë§Œ)
        if (index > 0 && totalMinutes > (totalCount * minIntervalMinutes))
        {
            var previousTime = startTime.AddMinutes(segmentStart);
            var proposedTime = startTime.AddMinutes(randomMinutes);

            if ((proposedTime - previousTime).TotalMinutes < minIntervalMinutes)
            {
                randomMinutes = segmentStart + minIntervalMinutes;
            }
        }

        // ì „ì²´ ê¸°ê°„ì„ ë„˜ì§€ ì•Šë„ë¡ ì œí•œ
        randomMinutes = Math.Min(randomMinutes, totalMinutes);

        return startTime.AddMinutes(randomMinutes);
    }

    // 6. ì»´í¬ë„ŒíŠ¸ ì¢…ë£Œ ì‹œ ìŒì•… íŒŒì¼ë§Œ ì •ë¦¬
    public void Dispose()
    {
        // ì„¸ì…˜ ìŒì•… íŒŒì¼ ì •ë¦¬
        if (!string.IsNullOrEmpty(savedMusicFilePath) && File.Exists(savedMusicFilePath))
        {
            try
            {
                File.Delete(savedMusicFilePath);
                Console.WriteLine($"=== ì„¸ì…˜ ìŒì•… íŒŒì¼ ì •ë¦¬: {Path.GetFileName(savedMusicFilePath)}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"=== ìŒì•… íŒŒì¼ ì •ë¦¬ ì‹¤íŒ¨: {ex.Message}");
            }
        }
        
        // íƒ€ì´ë¨¸ ì •ë¦¬ (AllInOneì˜ ê²½ìš°)
        scheduleStatusTimer?.Stop();
        scheduleStatusTimer?.Dispose();
    }
}
