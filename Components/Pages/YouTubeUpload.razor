@page "/youtube-upload"
@rendermode InteractiveServer
@using YouTubeShortsWebApp
@using YouTubeShortsWebApp.Services
@inject IJSRuntime JSRuntime
@inject ScheduledUploadService ScheduledUploadService
@inject YouTubeUploadService YouTubeService
@using System.Web

<PageTitle>YouTube ì—…ë¡œë“œ</PageTitle>

<h1>YouTube ì—…ë¡œë“œ</h1>

<div class="container">
    <div class="row">
        <div class="col-md-8">

            <!-- íŒŒì¼ ì„ íƒ ì„¹ì…˜ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>ë¹„ë””ì˜¤ íŒŒì¼ ì„ íƒ</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>ë¹„ë””ì˜¤ íŒŒì¼ë“¤:</strong></label>
                        <InputFile OnChange="HandleMultipleFileSelection" accept="video/*" multiple class="form-control" disabled="@(isUploading || isScheduleRunning)" />
                        <div class="form-text">í•˜ë‚˜ ë˜ëŠ” ì—¬ëŸ¬ ê°œì˜ ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (ê°ê° ìµœëŒ€ 2GB)</div>
                    </div>

                    @if (selectedFiles.Count > 0)
                    {
                        <div class="alert alert-info">
                            <strong>ì„ íƒëœ íŒŒì¼:</strong> @selectedFiles.Count ê°œ
                            <ul class="mb-0 mt-2">
                                @foreach (var file in selectedFiles.Take(5))
                                {
                                    <li>@file.Name (@YouTubeUploadService.FormatFileSize(file.Size))</li>
                                }
                                @if (selectedFiles.Count > 5)
                                {
                                    <li>... ì™¸ @(selectedFiles.Count - 5)ê°œ ë”</li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            </div>

            <!-- YouTube ì¸ì¦ ì„¹ì…˜ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>YouTube ê³„ì • ì—°ë™</h4>
                </div>
                <div class="card-body">
                    @if (YouTubeService.CurrentAccount == null)
                    {
                        <button type="button" class="btn btn-danger" @onclick="AuthenticateYouTube" disabled="@(isAuthenticating || isUploading || isScheduleRunning)">
                            @if (isAuthenticating)
                            {
                                <span>ì¸ì¦ ì¤‘...</span>
                            }
                            else
                            {
                                <span>YouTube ê³„ì • ì—°ë™</span>
                            }
                        </button>
                    }
                    else
                    {
                        <div class="alert alert-success">
                            <strong>ì—°ë™ëœ ê³„ì •:</strong> @YouTubeService.CurrentAccount.ChannelTitle
                            <br />
                            <small>êµ¬ë…ì: @YouTubeUploadService.FormatSubscriberCount(YouTubeService.CurrentAccount.SubscriberCount)ëª…</small>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="SwitchYouTubeAccount" disabled="@(isUploading || isScheduleRunning)">
                            ê³„ì • ì „í™˜
                        </button>
                    }
                </div>
            </div>

            <!-- ì—…ë¡œë“œ ì„¤ì • ì„¹ì…˜ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>ì—…ë¡œë“œ ì„¤ì •</h4>
                </div>
                <div class="card-body">
                    <!-- ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì‚¬ìš© ì²´í¬ë°•ìŠ¤ -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="useRandomUploadInfo" @bind:after="OnRandomUploadInfoChanged" id="useRandomUploadInfo" disabled="@(isUploading || isScheduleRunning)">
                            <label class="form-check-label" for="useRandomUploadInfo">
                                <strong>ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì‚¬ìš© (CSV íŒŒì¼)</strong>
                            </label>
                        </div>
                        <div class="form-text">ì œëª©, ì„¤ëª…, íƒœê·¸ë¥¼ CSV íŒŒì¼ì—ì„œ ëœë¤ìœ¼ë¡œ ì„ íƒí•©ë‹ˆë‹¤.</div>
                    </div>
            
                    @if (useRandomUploadInfo)
                    {
                        <!-- CSV íŒŒì¼ ì—…ë¡œë“œ -->
                        <div class="mb-4">
                            <label class="form-label"><strong>ì—…ë¡œë“œ ì •ë³´ CSV íŒŒì¼:</strong></label>
                            <InputFile OnChange="HandleUploadInfoCsvSelection" accept=".csv" class="form-control" disabled="@(isUploading || isScheduleRunning)" />
                            <div class="form-text">
                                CSV íŒŒì¼ í˜•ì‹: 1ì—´(ë²ˆí˜¸), 2ì—´(ì œëª©), 3ì—´(ì„¤ëª…), 4ì—´(íƒœê·¸)
                                <br />
                                ì˜ˆì‹œ: 1, "ì œëª© ì˜ˆì‹œ", "ì„¤ëª… ì˜ˆì‹œ", "íƒœê·¸1, íƒœê·¸2, íƒœê·¸3"
                            </div>
            
                            @if (uploadInfoCsvList.Count > 0)
                            {
                                <div class="mt-2 alert alert-success">
                                    <strong>ë¡œë“œëœ ì—…ë¡œë“œ ì •ë³´:</strong> @uploadInfoCsvList.Count ê°œ
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="ShowUploadInfoCsvPreview" disabled="@(isUploading || isScheduleRunning)">
                                        ë¯¸ë¦¬ë³´ê¸°
                                    </button>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ì œëª©:</strong></label>
                            <input type="text" class="form-control" @bind="uploadOptions.TitleTemplate" placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" disabled="@(isUploading || isScheduleRunning)" />
                            @if (enableScheduleUpload && selectedFiles.Count > 1)
                            {
                                <div class="form-text">ì—¬ëŸ¬ íŒŒì¼ì˜ ê²½ìš° ìë™ìœ¼ë¡œ ë²ˆí˜¸ê°€ ì¶”ê°€ë©ë‹ˆë‹¤ (ì˜ˆ: ì œëª© #1, ì œëª© #2)</div>
                            }
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>ì„¤ëª…:</strong></label>
                            <textarea class="form-control" rows="4" @bind="uploadOptions.Description" placeholder="ì˜ìƒ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" disabled="@(isUploading || isScheduleRunning)"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>íƒœê·¸:</strong></label>
                            <input type="text" class="form-control" @bind="uploadOptions.Tags" placeholder="íƒœê·¸1, íƒœê·¸2, íƒœê·¸3" disabled="@(isUploading || isScheduleRunning)" />
                            <div class="form-text">ì‰¼í‘œë¡œ êµ¬ë¶„í•´ì„œ ì…ë ¥í•˜ì„¸ìš”</div>
                        </div>
                    }
            
                    <!-- ê³µê°œ ì„¤ì • (í•­ìƒ í‘œì‹œ) -->
                    <div class="mb-3">
                        <label class="form-label"><strong>ê³µê°œ ì„¤ì •:</strong></label>
                        <select class="form-select" @bind="uploadOptions.PrivacySetting" disabled="@(isUploading || isScheduleRunning)">
                            <option value="ë¹„ê³µê°œ">ë¹„ê³µê°œ</option>
                            <option value="ê³µê°œ">ê³µê°œ</option>
                            <option value="ë§í¬ ê³µìœ ">ë§í¬ ê³µìœ </option>
                        </select>
                    </div>
                </div>
            </div>
            

            <!-- ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì„¤ì • ì„¹ì…˜ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="enableScheduleUpload" @bind:after="OnScheduleModeChanged" id="enableScheduleUpload" disabled="@(isUploading || isScheduleRunning)">
                            <label class="form-check-label" for="enableScheduleUpload">
                                <strong>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì‚¬ìš© (ëœë¤ ì‹œê°„ì— ì—…ë¡œë“œ)</strong>
                            </label>
                        </div>
                        <div class="form-text">ì—¬ëŸ¬ íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ì§€ì •ëœ ì‹œê°„ ë™ì•ˆ ëœë¤í•˜ê²Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                    </div>

                    @if (enableScheduleUpload)
                    {
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">ì—…ë¡œë“œ ê¸°ê°„: @scheduleHours ì‹œê°„</label>
                                <input type="range" class="form-range" min="0.5" max="24" step="0.5" @bind="scheduleHours" disabled="@(isUploading || isScheduleRunning)" />
                                <div class="form-text">@scheduleHours ì‹œê°„ ë™ì•ˆ ì—…ë¡œë“œë¥¼ ë¶„ì‚°í•©ë‹ˆë‹¤</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ìµœì†Œ ê°„ê²©: @minIntervalMinutes ë¶„</label>
                                <input type="range" class="form-range" min="2" max="180" @bind="minIntervalMinutes" disabled="@(isUploading || isScheduleRunning)" />
                                <div class="form-text">ì—…ë¡œë“œ ê°„ ìµœì†Œ @minIntervalMinutes ë¶„ ê°„ê²©</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="randomizeOrder" id="randomizeOrder" disabled="@(isUploading || isScheduleRunning)">
                                <label class="form-check-label" for="randomizeOrder">
                                    íŒŒì¼ ì—…ë¡œë“œ ìˆœì„œ ëœë¤í™”
                                </label>
                            </div>
                        </div>

                        @if (scheduleList.Count > 0)
                        {
                            <div class="alert alert-info">
                                <h6>ì˜ˆìƒ ì—…ë¡œë“œ ìŠ¤ì¼€ì¤„:</h6>
                                <ul class="mb-0">
                                    @foreach (var item in scheduleList.Take(3))
                                    {
                                        <li>@item.File.Name -> @item.ScheduledTime.ToString("MM/dd HH:mm")</li>
                                    }
                                    @if (scheduleList.Count > 3)
                                    {
                                        <li>... ì´ @scheduleList.Count ê°œ íŒŒì¼</li>
                                    }
                                </ul>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" @onclick="CreateUploadSchedule" disabled="@(isUploading || isScheduleRunning)">
                                    ìŠ¤ì¼€ì¤„ ë‹¤ì‹œ ìƒì„±
                                </button>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- ìŠ¤ì¼€ì¤„ ìƒíƒœ í™•ì¸ ë²„íŠ¼ -->
            <div class="d-grid gap-2 mb-3">
                <button type="button" class="btn btn-outline-info" @onclick="CheckScheduleStatus" disabled="@(isUploading || isScheduleRunning)">
                    ìŠ¤ì¼€ì¤„ ìƒíƒœ í™•ì¸
                </button>
            </div>

            <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-success btn-lg" @onclick="StartUpload"
                        disabled="@(!CanUpload || isUploading || isScheduleRunning)">
                    @if (isUploading || isScheduleRunning)
                    {
                        @if (enableScheduleUpload)
                        {
                            <span>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì§„í–‰ ì¤‘...</span>
                        }
                        else
                        {
                            <span>ì—…ë¡œë“œ ì¤‘...</span>
                        }
                    }
                    else
                    {
                        @if (enableScheduleUpload)
                        {
                            <span>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì‹œì‘</span>
                        }
                        else
                        {
                            <span>YouTubeì— ì—…ë¡œë“œ</span>
                        }
                    }
                </button>
            </div>

            <!-- ì—…ë¡œë“œ ì§„í–‰ë¥  -->
            @if (isUploading)
            {
                <div class="mt-3">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             style="width: @(uploadProgress)%"></div>
                    </div>
                    <div class="mt-2 text-info">@uploadStatus</div>
                </div>
            }

            <!-- ìŠ¤ì¼€ì¤„ ìƒíƒœ -->
            @if (isScheduleRunning)
            {
                <div class="mt-3">
                    <div class="alert alert-warning">
                        <h6>ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì§„í–‰ ì¤‘</h6>
                        <p>@scheduleStatus</p>
                        <div class="progress">
                            <div class="progress-bar" style="width: @(scheduleProgress)%"></div>
                        </div>
                    </div>
                </div>
            }

            <!-- í™œì„±í™”ëœ ìŠ¤ì¼€ì¤„ ì •ë³´ í‘œì‹œ -->
            @if (!isScheduleRunning && !isUploading && HasActiveSchedules())
            {
                <div class="mt-3">
                    <div class="alert alert-info">
                        <h6>í™œì„±í™”ëœ ìŠ¤ì¼€ì¤„</h6>
                        <p>í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ì—…ë¡œë“œ: @GetScheduleCount()ê°œ</p>

                        @if (!string.IsNullOrEmpty(nextScheduleInfo))
                        {
                            <div class="mt-2">
                                <strong>ë‹¤ìŒ ì—…ë¡œë“œ ì˜ˆì •:</strong><br />
                                @nextScheduleInfo
                            </div>
                        }

                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-info" @onclick="RefreshScheduleInfo">
                                ìƒˆë¡œê³ ì¹¨
                            </button>
                        </div>
                    </div>
                </div>
            }

            <!-- ì—…ë¡œë“œ ê²°ê³¼ -->
            @if (!string.IsNullOrEmpty(uploadResult))
            {
                <div class="mt-3 alert alert-success">
                    <h5>ì—…ë¡œë“œ ì™„ë£Œ!</h5>
                    <p>@uploadResult</p>
                    @if (!string.IsNullOrEmpty(uploadedVideoUrl))
                    {
                        <a href="@uploadedVideoUrl" target="_blank" class="btn btn-primary btn-sm">
                            YouTubeì—ì„œ ë³´ê¸°
                        </a>
                    }
                </div>
            }

            <!-- ì—…ë¡œë“œ ì •ë³´ CSV ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
            @if (showUploadInfoCsvPreview)
            {
                <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">ì—…ë¡œë“œ ì •ë³´ ë¯¸ë¦¬ë³´ê¸°</h5>
                                <button type="button" class="btn-close" @onclick="() => showUploadInfoCsvPreview = false" disabled="@(isUploading || isScheduleRunning)"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>ì´ @uploadInfoCsvList.Count ê°œì˜ ì—…ë¡œë“œ ì •ë³´ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    @for (int i = 0; i < Math.Min(5, uploadInfoCsvList.Count); i++)
                                    {
                                        <div class="card mb-2">
                                            <div class="card-body">
                                                <h6 class="card-title">@(i + 1). @uploadInfoCsvList[i].Title</h6>
                                                <p class="card-text small mb-1"><strong>ì„¤ëª…:</strong> @uploadInfoCsvList[i].Description</p>
                                                <p class="card-text small mb-0"><strong>íƒœê·¸:</strong> @uploadInfoCsvList[i].Tags</p>
                                            </div>
                                        </div>
                                    }
                                    @if (uploadInfoCsvList.Count > 5)
                                    {
                                        <div class="text-muted text-center">... ì™¸ @(uploadInfoCsvList.Count - 5) ê°œ ë”</div>
                                    }
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" @onclick="() => showUploadInfoCsvPreview = false" disabled="@(isUploading || isScheduleRunning)">ë‹«ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
              }

        </div>
    </div>
</div>



<!-- ----------------------code ------------------------ -->
@code {
    // ğŸ”¥ ì„œë¹„ìŠ¤ì˜ Options í´ë˜ìŠ¤ ì‚¬ìš©
    private YouTubeUploadService.UploadOptions uploadOptions = new();

    // íŒŒì¼ ê´€ë ¨
    private List<IBrowserFile> selectedFiles = new List<IBrowserFile>();

    // ì¸ì¦
    private bool isAuthenticating = false;

    // ì—…ë¡œë“œ ìƒíƒœ
    private bool isUploading = false;
    private int uploadProgress = 0;
    private string uploadStatus = "";
    private string uploadResult = "";
    private string uploadedVideoUrl = "";

    // ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ê´€ë ¨
    private bool enableScheduleUpload = false;
    private float scheduleHours = 2.0f;
    private int minIntervalMinutes = 30;
    private bool randomizeOrder = true;
    private bool isScheduleRunning = false;
    private List<ScheduleItem> scheduleList = new List<ScheduleItem>();
    private string scheduleStatus = "";
    private int scheduleProgress = 0;

    // ëœë¤ ì—…ë¡œë“œ ì •ë³´ ê´€ë ¨
    private bool useRandomUploadInfo = false;
    private List<UploadInfoItem> uploadInfoCsvList = new List<UploadInfoItem>();
    private bool showUploadInfoCsvPreview = false;

    // ìŠ¤ì¼€ì¤„ ì •ë³´ ì¶”ì 
    private string nextScheduleInfo = "";
    private System.Timers.Timer? scheduleInfoTimer;
    private List<DateTime> scheduledTimes = new List<DateTime>();

    public class ScheduleItem
    {
        public IBrowserFile File { get; set; } = null!;
        public DateTime ScheduledTime { get; set; }
        public string Title { get; set; } = "";
        public string Status { get; set; } = "ëŒ€ê¸° ì¤‘";
        public string? UploadedUrl { get; set; }
    }

    private bool CanUpload
    {
        get
        {
            // YouTube ì¸ì¦ ì²´í¬
            if (YouTubeService.CurrentAccount == null) return false;
            
            // ğŸ”¥ ì œëª© ì²´í¬: ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì‚¬ìš© ì‹œì—ëŠ” ì²´í¬ ì•ˆ í•¨
            if (!useRandomUploadInfo && string.IsNullOrWhiteSpace(uploadOptions.TitleTemplate))
                return false;
            
            // ğŸ”¥ ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì‚¬ìš© ì‹œ CSV ì²´í¬
            if (useRandomUploadInfo && uploadInfoCsvList.Count == 0)
                return false;
            
            // íŒŒì¼ ì„ íƒ ì²´í¬
            return selectedFiles.Count > 0;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        LoadDefaultSettings();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var uri = new Uri(await JSRuntime.InvokeAsync<string>("eval", "window.location.href"));
                var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
                
                if (query["auth"] == "success")
                {
                    try
                    {
                        bool authCheck = await YouTubeService.CheckExistingAuthAsync();
                        
                        if (authCheck)
                        {
                            await JSRuntime.InvokeVoidAsync("alert", "YouTube ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                            StateHasChanged();
                        }
                    }
                    catch (Exception ex)
                    {
                        await JSRuntime.InvokeVoidAsync("alert", $"ì¸ì¦ ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
                    }
                }
                else if (query["auth"] == "failed")
                {
                    await JSRuntime.InvokeVoidAsync("alert", "YouTube ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                else if (query["auth"] == "error")
                {
                    string errorMsg = query["message"] ?? "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
                    await JSRuntime.InvokeVoidAsync("alert", $"ì¸ì¦ ì˜¤ë¥˜: {errorMsg}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
            }
        }
    }

    private void LoadDefaultSettings()
    {
        uploadOptions.TitleTemplate = "Runmoa";
        uploadOptions.Description = "www.runmoa.com";
        uploadOptions.Tags = "Runmoa, website, 1min";
    }

    private void OnScheduleModeChanged()
    {
        scheduleList.Clear();

        if (selectedFiles.Count > 0)
        {
            CreateUploadSchedule();
        }
    }

    private async Task HandleMultipleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFiles.Clear();
        selectedFiles.AddRange(e.GetMultipleFiles(10));

        const long maxSizePerFile = 2L * 1024 * 1024 * 1024;
        var invalidFiles = selectedFiles.Where(f => f.Size > maxSizePerFile).ToList();

        if (invalidFiles.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert",
                $"ë‹¤ìŒ íŒŒì¼ë“¤ì´ 2GBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤:\n{string.Join("\n", invalidFiles.Select(f => f.Name))}");

            selectedFiles = selectedFiles.Where(f => f.Size <= maxSizePerFile).ToList();
        }

        if (selectedFiles.Count > 0)
        {
            CreateUploadSchedule();
        }

        StateHasChanged();
    }

    private async Task AuthenticateYouTube()
    {
        isAuthenticating = true;
    
        try
        {
            string authUrl = await YouTubeService.GetAuthorizationUrlAsync(JSRuntime, "youtube-upload");
            await JSRuntime.InvokeVoidAsync("eval", $"window.location.href = '{authUrl}'");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ì¸ì¦ ì˜¤ë¥˜: {ex.Message}");
        }
        finally
        {
            isAuthenticating = false;
        }
    }

    private async Task SwitchYouTubeAccount()
    {
        try
        {
            bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", 
                "í˜„ì¬ ê³„ì • ì—°ë™ì„ í•´ì œí•˜ê³  ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            
            if (!confirm) return;
            
            await YouTubeService.SwitchAccountAsync();
            StateHasChanged();
            
            await AuthenticateYouTube();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ê³„ì • ì „í™˜ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    public class UploadInfoItem
    {
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Tags { get; set; } = "";
    }
    
    private void OnRandomUploadInfoChanged()
    {
        if (!useRandomUploadInfo)
        {
            uploadInfoCsvList.Clear();
        }
    }
    
    private async Task HandleUploadInfoCsvSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
    
        try
        {
            const long maxSize = 5 * 1024 * 1024;
            if (file.Size > maxSize)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
    
            using var stream = file.OpenReadStream(maxSize);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();
    
            uploadInfoCsvList = ParseUploadInfoCsv(content);
    
            if (uploadInfoCsvList.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì—ì„œ ìœ íš¨í•œ ì—…ë¡œë“œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            else
            {
                Console.WriteLine($"=== {uploadInfoCsvList.Count}ê°œ ì—…ë¡œë“œ ì •ë³´ ë¡œë“œë¨");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {ex.Message}");
            uploadInfoCsvList.Clear();
        }
    }
    
    private List<UploadInfoItem> ParseUploadInfoCsv(string content)
    {
        var items = new List<UploadInfoItem>();
        var lines = content.Split('\n', StringSplitOptions.RemoveEmptyEntries);
    
        for (int i = 1; i < lines.Length; i++) // ì²« ì¤„ì€ í—¤ë”
        {
            var line = lines[i].Trim();
            if (string.IsNullOrEmpty(line)) continue;
    
            try
            {
                // ğŸ”¥ íƒœê·¸ "#"ì„ ê¸°ì¤€ìœ¼ë¡œ ë¨¼ì € ë¶„ë¦¬
                int tagStartIndex = line.IndexOf('#');
                
                if (tagStartIndex == -1)
                {
                    Console.WriteLine($"CSV ë¼ì¸ {i}: íƒœê·¸(#)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ê±´ë„ˆëœ€");
                    continue;
                }
    
                // íƒœê·¸ ì¶”ì¶œ (# ì´í›„ ì „ì²´)
                string tags = line.Substring(tagStartIndex).Trim();
                
                // íƒœê·¸ ì• ë¶€ë¶„
                string beforeTags = line.Substring(0, tagStartIndex).TrimEnd(',', ' ');
                
                // ğŸ”¥ ê°œì„ ëœ íŒŒì‹±: ì²« ë²ˆì§¸ ì‰¼í‘œì™€ ë§ˆì§€ë§‰ ë”°ì˜´í‘œ ì°¾ê¸°
                // í˜•ì‹: ë²ˆí˜¸,"ì œëª©","ì„¤ëª…",#íƒœê·¸
                
                // ì²« ë²ˆì§¸ ì‰¼í‘œ ì°¾ê¸° (ë²ˆí˜¸ ë‹¤ìŒ)
                int firstComma = beforeTags.IndexOf(',');
                if (firstComma == -1)
                {
                    Console.WriteLine($"CSV ë¼ì¸ {i}: ë²ˆí˜¸ êµ¬ë¶„ ì‰¼í‘œ ì—†ìŒ");
                    continue;
                }
                
                // ë²ˆí˜¸ ì´í›„ ë¶€ë¶„
                string afterNumber = beforeTags.Substring(firstComma + 1).Trim();
                
                // ì œëª© ì‹œì‘ ë”°ì˜´í‘œ ì°¾ê¸°
                int titleStart = afterNumber.IndexOf('"');
                if (titleStart == -1)
                {
                    Console.WriteLine($"CSV ë¼ì¸ {i}: ì œëª© ì‹œì‘ ë”°ì˜´í‘œ ì—†ìŒ");
                    continue;
                }
                
                // ì œëª© ë ë”°ì˜´í‘œ ì°¾ê¸° (ì´ìŠ¤ì¼€ì´í”„ëœ ë”°ì˜´í‘œ ê³ ë ¤)
                int titleEnd = titleStart + 1;
                while (titleEnd < afterNumber.Length)
                {
                    if (afterNumber[titleEnd] == '"')
                    {
                        // ë‹¤ìŒ ë¬¸ìê°€ ë”°ì˜´í‘œë©´ ì´ìŠ¤ì¼€ì´í”„
                        if (titleEnd + 1 < afterNumber.Length && afterNumber[titleEnd + 1] == '"')
                        {
                            titleEnd += 2; // ì´ìŠ¤ì¼€ì´í”„ëœ ë”°ì˜´í‘œ ê±´ë„ˆë›°ê¸°
                            continue;
                        }
                        break; // ì§„ì§œ ë ë”°ì˜´í‘œ
                    }
                    titleEnd++;
                }
                
                if (titleEnd >= afterNumber.Length)
                {
                    Console.WriteLine($"CSV ë¼ì¸ {i}: ì œëª© ë ë”°ì˜´í‘œ ì—†ìŒ");
                    continue;
                }
                
                string title = afterNumber.Substring(titleStart + 1, titleEnd - titleStart - 1)
                    .Replace("\"\"", "\"") // ì´ìŠ¤ì¼€ì´í”„ëœ ë”°ì˜´í‘œ ë³µì›
                    .Trim();
                
                // ì„¤ëª… ì°¾ê¸°
                string afterTitle = afterNumber.Substring(titleEnd + 1).Trim();
                if (afterTitle.StartsWith(","))
                {
                    afterTitle = afterTitle.Substring(1).Trim();
                }
                
                int descStart = afterTitle.IndexOf('"');
                if (descStart == -1)
                {
                    Console.WriteLine($"CSV ë¼ì¸ {i}: ì„¤ëª… ì‹œì‘ ë”°ì˜´í‘œ ì—†ìŒ");
                    continue;
                }
                
                // ì„¤ëª… ë ë”°ì˜´í‘œ ì°¾ê¸°
                int descEnd = descStart + 1;
                while (descEnd < afterTitle.Length)
                {
                    if (afterTitle[descEnd] == '"')
                    {
                        if (descEnd + 1 < afterTitle.Length && afterTitle[descEnd + 1] == '"')
                        {
                            descEnd += 2;
                            continue;
                        }
                        break;
                    }
                    descEnd++;
                }
                
                if (descEnd >= afterTitle.Length)
                {
                    Console.WriteLine($"CSV ë¼ì¸ {i}: ì„¤ëª… ë ë”°ì˜´í‘œ ì—†ìŒ");
                    continue;
                }
                
                string description = afterTitle.Substring(descStart + 1, descEnd - descStart - 1)
                    .Replace("\"\"", "\"")
                    .Trim();
    
                if (!string.IsNullOrWhiteSpace(title))
                {
                    items.Add(new UploadInfoItem
                    {
                        Title = title,
                        Description = description,
                        Tags = tags
                    });
                    
                    Console.WriteLine($"âœ… CSV ë¼ì¸ {i} íŒŒì‹± ì„±ê³µ:");
                    Console.WriteLine($"   ì œëª©: {title}");
                    Console.WriteLine($"   ì„¤ëª…: {(description.Length > 50 ? description.Substring(0, 50) + "..." : description)}");
                    Console.WriteLine($"   íƒœê·¸: {tags}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"âŒ CSV ë¼ì¸ {i} íŒŒì‹± ì˜¤ë¥˜: {ex.Message}");
            }
        }
    
        Console.WriteLine($"=== ì´ {items.Count}ê°œ ì—…ë¡œë“œ ì •ë³´ íŒŒì‹± ì™„ë£Œ");
        return items;
    }
    
    // ğŸ”¥ ìƒˆë¡œìš´ CSV íŒŒì‹± í—¬í¼ ë©”ì„œë“œ (ë”°ì˜´í‘œ ì²˜ë¦¬)
    private List<string> ParseCsvLine(string line)
    {
        var result = new List<string>();
        var current = new System.Text.StringBuilder();
        bool inQuotes = false;
    
        for (int i = 0; i < line.Length; i++)
        {
            char c = line[i];
    
            if (c == '"')
            {
                inQuotes = !inQuotes;
            }
            else if (c == ',' && !inQuotes)
            {
                result.Add(current.ToString());
                current.Clear();
            }
            else
            {
                current.Append(c);
            }
        }
    
        result.Add(current.ToString());
        return result;
    }
    
    private void ShowUploadInfoCsvPreview()
    {
        showUploadInfoCsvPreview = true;
    }

    private async Task StartUpload()
    {
        if (enableScheduleUpload)
        {
            await StartScheduledUpload();
        }
        else
        {
            await StartSingleUpload();
        }
    }

    private async Task StartSingleUpload()
    {
        if (selectedFiles.Count == 0 || YouTubeService.CurrentAccount == null)
            return;
    
        isUploading = true;
        uploadResult = "";
        uploadedVideoUrl = "";
    
        try
        {
            // íŒŒì¼ì„ ì„ì‹œ ê²½ë¡œì— ì €ì¥
            var filePaths = new List<string>();
            
            for (int i = 0; i < selectedFiles.Count; i++)
            {
                var file = selectedFiles[i];
                string tempFilePath = Path.GetTempFileName();
                string actualTempPath = Path.ChangeExtension(tempFilePath, Path.GetExtension(file.Name));
    
                uploadStatus = $"íŒŒì¼ ì¤€ë¹„ ì¤‘... ({i + 1}/{selectedFiles.Count}) {file.Name}";
                uploadProgress = (i * 20 / selectedFiles.Count) + 5;
                StateHasChanged();
    
                using (var fileStream = new FileStream(actualTempPath, FileMode.Create))
                {
                    await file.OpenReadStream(maxAllowedSize: 2L * 1024 * 1024 * 1024).CopyToAsync(fileStream);
                }
                
                filePaths.Add(actualTempPath);
            }
    
            // ğŸ”¥ ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì„¤ì •
            if (useRandomUploadInfo && uploadInfoCsvList.Count > 0)
            {
                uploadOptions.UseRandomInfo = true;
                
                // ê°ê° ë…ë¦½ì ì¸ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
                uploadOptions.RandomTitles = uploadInfoCsvList.Select(item => item.Title).ToList();
                uploadOptions.RandomDescriptions = uploadInfoCsvList.Select(item => item.Description).ToList();
                uploadOptions.RandomTags = uploadInfoCsvList.Select(item => item.Tags).ToList();
                
                Console.WriteLine($"=== ëœë¤ ì—…ë¡œë“œ ì •ë³´ í™œì„±í™”");
                Console.WriteLine($"    ì œëª©: {uploadOptions.RandomTitles.Count}ê°œ");
                Console.WriteLine($"    ì„¤ëª…: {uploadOptions.RandomDescriptions.Count}ê°œ");
                Console.WriteLine($"    íƒœê·¸: {uploadOptions.RandomTags.Count}ê°œ");
            }
            else
            {
                uploadOptions.UseRandomInfo = false;
                uploadOptions.RandomTitles = null;
                uploadOptions.RandomDescriptions = null;
                uploadOptions.RandomTags = null;
            }
    
            // ğŸ”¥ ì„œë¹„ìŠ¤ ì‚¬ìš©í•˜ì—¬ ì—…ë¡œë“œ
            var uploadedUrls = await YouTubeService.UploadMultipleVideosAsync(
                filePaths,
                uploadOptions,
                (current, total, title) => {
                    InvokeAsync(() => {
                        uploadStatus = $"ì—…ë¡œë“œ ì¤‘... ({current}/{total}) {title}";
                        uploadProgress = 20 + (current * 70 / total);
                        StateHasChanged();
                    });
                }
            );
    
            // ì„ì‹œ íŒŒì¼ ì‚­ì œ
            foreach (var filePath in filePaths)
            {
                try
                {
                    if (File.Exists(filePath))
                    {
                        File.Delete(filePath);
                    }
                }
                catch { }
            }
    
            uploadProgress = 100;
            uploadStatus = "ëª¨ë“  ì—…ë¡œë“œ ì™„ë£Œ!";
    
            if (uploadedUrls.Count > 0)
            {
                uploadResult = $"{uploadedUrls.Count}ê°œ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.";
                uploadedVideoUrl = uploadedUrls.First();
            }
            else
            {
                uploadResult = "ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            }
    
            isUploading = false;
        }
        catch (Exception ex)
        {
            uploadStatus = "";
            uploadProgress = 0;
            isUploading = false;
            await JSRuntime.InvokeVoidAsync("alert", $"ì—…ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private async Task StartScheduledUpload()
    {
        if (selectedFiles.Count == 0 || YouTubeService.CurrentAccount == null)
            return;

        try
        {
            if (scheduleList.Count == 0)
            {
                CreateUploadSchedule();
            }

            string schedulePreview = "ì—…ë¡œë“œ ìŠ¤ì¼€ì¤„:\n";
            foreach (var item in scheduleList.Take(3))
            {
                schedulePreview += $"â€¢ {item.File.Name} -> {item.ScheduledTime:MM/dd HH:mm}\n";
            }
            if (scheduleList.Count > 3)
            {
                schedulePreview += $"... ì´ {scheduleList.Count}ê°œ íŒŒì¼";
            }

            bool confirm = await JSRuntime.InvokeAsync<bool>("confirm",
                $"ë‹¤ìŒ ìŠ¤ì¼€ì¤„ë¡œ {scheduleList.Count}ê°œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n{schedulePreview}");

            if (confirm)
            {
                isScheduleRunning = true;
                await ExecuteScheduledUploads();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private void CreateUploadSchedule()
    {
        scheduleList.Clear();
        DateTime startTime = DateTime.Now.AddMinutes(5);
        
        var filesToSchedule = randomizeOrder
            ? selectedFiles.OrderBy(x => Guid.NewGuid()).ToList()
            : selectedFiles.ToList();

        for (int i = 0; i < filesToSchedule.Count; i++)
        {
            // ê°„ë‹¨í•œ ëœë¤ ì‹œê°„ ê³„ì‚°
            double minutesPerFile = (scheduleHours * 60) / filesToSchedule.Count;
            double randomOffset = new Random().NextDouble() * minutesPerFile;
            DateTime scheduledTime = startTime.AddMinutes((i * minutesPerFile) + randomOffset);

            scheduleList.Add(new ScheduleItem
            {
                File = filesToSchedule[i],
                ScheduledTime = scheduledTime,
                Title = filesToSchedule.Count > 1 ? $"{uploadOptions.TitleTemplate} #{i + 1}" : uploadOptions.TitleTemplate,
                Status = "ëŒ€ê¸° ì¤‘"
            });
        }

        scheduleList = scheduleList.OrderBy(x => x.ScheduledTime).ToList();
        StateHasChanged();
    }

    private async Task ExecuteScheduledUploads()
    {
        try
        {
            scheduleStatus = "íŒŒì¼ë“¤ì„ ì„œë²„ì— ì €ì¥í•˜ê³  ìŠ¤ì¼€ì¤„ì— ë“±ë¡ ì¤‘...";
            scheduleProgress = 10;
            StateHasChanged();
    
            var filePaths = new List<string>();
    
            for (int i = 0; i < scheduleList.Count; i++)
            {
                var scheduleItem = scheduleList[i];
    
                scheduleStatus = $"íŒŒì¼ ì¤€ë¹„ ì¤‘... ({i + 1}/{scheduleList.Count}) {scheduleItem.File.Name}";
                scheduleProgress = 10 + (i * 70 / scheduleList.Count);
                StateHasChanged();
    
                string tempDir = Path.Combine(Path.GetTempPath(), "YouTubeScheduledUploads");
                Directory.CreateDirectory(tempDir);
    
                string tempFilePath = Path.Combine(tempDir, $"{DateTime.Now.Ticks}_{scheduleItem.File.Name}");
    
                using (var fileStream = new FileStream(tempFilePath, FileMode.Create))
                {
                    await scheduleItem.File.OpenReadStream(maxAllowedSize: 2L * 1024 * 1024 * 1024).CopyToAsync(fileStream);
                }
    
                filePaths.Add(tempFilePath);
            }
    
            scheduleStatus = "ìŠ¤ì¼€ì¤„ ì„œë¹„ìŠ¤ì— ë“±ë¡ ì¤‘...";
            scheduleProgress = 85;
            StateHasChanged();
    
            DateTime startTime = DateTime.Now.AddMinutes(5);
    
           // ğŸ”¥ ëœë¤ ì—…ë¡œë“œ ì •ë³´ ì„¤ì •
            if (useRandomUploadInfo && uploadInfoCsvList.Count > 0)
            {
                uploadOptions.UseRandomInfo = true;
                
                // ê°ê° ë…ë¦½ì ì¸ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
                uploadOptions.RandomTitles = uploadInfoCsvList.Select(item => item.Title).ToList();
                uploadOptions.RandomDescriptions = uploadInfoCsvList.Select(item => item.Description).ToList();
                uploadOptions.RandomTags = uploadInfoCsvList.Select(item => item.Tags).ToList();
                
                Console.WriteLine($"=== ëœë¤ ì—…ë¡œë“œ ì •ë³´ í™œì„±í™”");
                Console.WriteLine($"    ì œëª©: {uploadOptions.RandomTitles.Count}ê°œ");
                Console.WriteLine($"    ì„¤ëª…: {uploadOptions.RandomDescriptions.Count}ê°œ");
                Console.WriteLine($"    íƒœê·¸: {uploadOptions.RandomTags.Count}ê°œ");
            }
            else
            {
                uploadOptions.UseRandomInfo = false;
                uploadOptions.RandomTitles = null;
                uploadOptions.RandomDescriptions = null;
                uploadOptions.RandomTags = null;
            }
    
            // ìŠ¤ì¼€ì¤„ ë“±ë¡
            YouTubeService.RegisterScheduledUploads(
                filePaths,
                uploadOptions,
                scheduledTimes,      // âœ… Dictionary ì „ë‹¬
                randomizeOrder,
                ScheduledUploadService
            );
    
            scheduleProgress = 100;
            scheduleStatus = $"ìŠ¤ì¼€ì¤„ ë“±ë¡ ì™„ë£Œ! {filePaths.Count}ê°œ íŒŒì¼ì´ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.";
            StateHasChanged();
    
            var firstUpload = scheduleList.OrderBy(x => x.ScheduledTime).First();
            var lastUpload = scheduleList.OrderBy(x => x.ScheduledTime).Last();
    
            await JSRuntime.InvokeVoidAsync("alert",
                $"ìŠ¤ì¼€ì¤„ ì—…ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" +
                $"â€¢ ë“±ë¡ëœ íŒŒì¼: {filePaths.Count}ê°œ\n" +
                $"â€¢ ì²« ë²ˆì§¸ ì—…ë¡œë“œ: {firstUpload.ScheduledTime:MM/dd HH:mm}\n" +
                $"â€¢ ë§ˆì§€ë§‰ ì—…ë¡œë“œ: {lastUpload.ScheduledTime:MM/dd HH:mm}\n\n" +
                $"ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ìœ¼ë¡œ ì—…ë¡œë“œë©ë‹ˆë‹¤.");
    
            isScheduleRunning = false;
            scheduleProgress = 0;
            scheduleStatus = "";
    
            selectedFiles.Clear();
            scheduleList.Clear();
    
            await UpdateNextScheduleInfo();
            StartScheduleTrackingTimer();
    
            StateHasChanged();
        }
        catch (Exception ex)
        {
            scheduleProgress = 0;
            scheduleStatus = "";
            isScheduleRunning = false;
            await JSRuntime.InvokeVoidAsync("alert", $"ìŠ¤ì¼€ì¤„ ë“±ë¡ ì‹¤íŒ¨: {ex.Message}");
            StateHasChanged();
        }
    }

    private bool HasActiveSchedules()
    {
        try
        {
            return ScheduledUploadService.GetQueueCount() > 0;
        }
        catch
        {
            return false;
        }
    }

    private int GetScheduleCount()
    {
        try
        {
            return ScheduledUploadService.GetQueueCount();
        }
        catch
        {
            return 0;
        }
    }

    private async Task RefreshScheduleInfo()
    {
        await UpdateNextScheduleInfo();
        StateHasChanged();
    }

    private void StartScheduleTrackingTimer()
    {
        if (scheduleInfoTimer != null)
        {
            scheduleInfoTimer.Stop();
            scheduleInfoTimer.Dispose();
            scheduleInfoTimer = null;
        }

        scheduleInfoTimer = new System.Timers.Timer(10000);
        scheduleInfoTimer.Elapsed += async (sender, e) =>
        {
            try
            {
                int queueCount = ScheduledUploadService.GetQueueCount();

                await InvokeAsync(async () =>
                {
                    if (queueCount > 0)
                    {
                        await UpdateNextScheduleInfo();
                    }
                    else if (isScheduleRunning)
                    {
                        isScheduleRunning = false;
                        nextScheduleInfo = "";

                        scheduleInfoTimer?.Stop();
                        scheduleInfoTimer?.Dispose();
                        scheduleInfoTimer = null;
                    }

                    StateHasChanged();
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ìŠ¤ì¼€ì¤„ íƒ€ì´ë¨¸ ì˜¤ë¥˜: {ex.Message}");
            }
        };

        scheduleInfoTimer.AutoReset = true;
        scheduleInfoTimer.Start();
    }

    private async Task UpdateNextScheduleInfo()
    {
        try
        {
            var allItems = ScheduledUploadService.GetAllScheduledItems();
            var nextUpload = allItems
                .Where(x => x.Status == "ëŒ€ê¸° ì¤‘")
                .OrderBy(x => x.ScheduledTime)
                .FirstOrDefault();

            if (nextUpload != null)
            {
                var timeUntil = nextUpload.ScheduledTime - DateTime.Now;
                
                if (timeUntil.TotalMinutes > 0)
                {
                    string fileName = nextUpload.FileName.Length > 30 
                        ? nextUpload.FileName.Substring(0, 27) + "..."
                        : nextUpload.FileName;

                    if (timeUntil.TotalHours >= 1)
                    {
                        nextScheduleInfo = $"{fileName}\n{nextUpload.ScheduledTime:MM/dd HH:mm} ({timeUntil.Hours}ì‹œê°„ {timeUntil.Minutes}ë¶„ í›„)";
                    }
                    else if (timeUntil.TotalMinutes >= 1)
                    {
                        nextScheduleInfo = $"{fileName}\n{nextUpload.ScheduledTime:MM/dd HH:mm} ({(int)timeUntil.TotalMinutes}ë¶„ í›„)";
                    }
                    else
                    {
                        nextScheduleInfo = $"{fileName}\nê³§ ì—…ë¡œë“œ ì˜ˆì •";
                    }
                }
                else
                {
                    nextScheduleInfo = $"{nextUpload.FileName}\nì—…ë¡œë“œ ì§„í–‰ ì¤‘";
                }
            }
            else
            {
                nextScheduleInfo = "";
            }
        }
        catch (Exception ex)
        {
            nextScheduleInfo = $"ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: {ex.Message}";
        }
    }

    private async Task CheckScheduleStatus()
    {
        try
        {
            int queueCount = ScheduledUploadService.GetQueueCount();
            var allItems = ScheduledUploadService.GetAllScheduledItems();

            string statusInfo = $"í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ì—…ë¡œë“œ: {queueCount}ê°œ\n\n";

            var recentItems = allItems.OrderBy(x => x.ScheduledTime).Take(5);
            foreach (var item in recentItems)
            {
                statusInfo += $"â€¢ {item.FileName} - {item.Status} ({item.ScheduledTime:MM/dd HH:mm})\n";
            }

            if (allItems.Count > 5)
            {
                statusInfo += $"... ì™¸ {allItems.Count - 5}ê°œ ë”";
            }

            await JSRuntime.InvokeVoidAsync("alert", statusInfo);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    public void Dispose()
    {
        scheduleInfoTimer?.Stop();
        scheduleInfoTimer?.Dispose();
    }
}
