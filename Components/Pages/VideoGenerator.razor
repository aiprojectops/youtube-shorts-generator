@page "/video-generator"
@rendermode InteractiveServer
@using YouTubeShortsWebApp
@using YouTubeShortsWebApp.Services
@using System.Diagnostics
@using System.IO
@inject IJSRuntime JSRuntime
@inject VideoPostProcessingService ProcessingService

<PageTitle>ë¹„ë””ì˜¤ ìƒì„±ê¸°</PageTitle>

<h1>YouTube Shorts ìƒì„±ê¸°</h1>

<div class="container">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3>ë¹„ë””ì˜¤ ìƒì„± ì˜µì…˜</h3>
                </div>
                <div class="card-body">
                    @if (genOptions.IsGenerateVideo && string.IsNullOrEmpty(ConfigManager.GetConfig().ReplicateApiKey))
                    {
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <strong>âš ï¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</strong>
                            <p class="mb-2 mt-2">AI ì˜ìƒ ìƒì„±ì„ ì‚¬ìš©í•˜ë ¤ë©´ Replicate API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                            <div class="d-flex gap-2">
                                <a href="/settings" class="btn btn-sm btn-warning">âš™ï¸ ì„¤ì •í•˜ëŸ¬ ê°€ê¸°</a>
                                <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => genOptions.IsGenerateVideo = false">
                                    ğŸ“ ë¡œì»¬ íŒŒì¼ ëª¨ë“œë¡œ ì „í™˜
                                </button>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <!-- ì˜ìƒ ì†ŒìŠ¤ ì„ íƒ -->
                    <div class="mb-4">
                        <label class="form-label"><strong>ì˜ìƒ ì†ŒìŠ¤:</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoSource" id="generateNewVideo"
                                   @onchange="() => genOptions.IsGenerateVideo = true" checked="@genOptions.IsGenerateVideo" disabled="@isGenerating">
                            <label class="form-check-label" for="generateNewVideo">
                                <strong>AIë¡œ ìƒˆë¡œ ìƒì„±</strong>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoSource" id="useLocalVideo"
                                   @onchange="() => genOptions.IsGenerateVideo = false" checked="@(!genOptions.IsGenerateVideo)" disabled="@isGenerating">
                            <label class="form-check-label" for="useLocalVideo">
                                <strong>ë¡œì»¬ íŒŒì¼ í›„ì²˜ë¦¬ë§Œ</strong>
                            </label>
                        </div>
                    </div>

                    @if (genOptions.IsGenerateVideo)
                    {
                        <!-- AI ìƒì„± ì˜µì…˜ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ìƒì„±í•  ì˜ìƒ ê°œìˆ˜: @genOptions.VideoCount ê°œ</strong></label>
                            <input type="range" class="form-range" min="1" max="5" @bind="genOptions.VideoCount" disabled="@isGenerating" />
                            <div class="text-primary">ì´ ë¹„ìš©: $@totalCost</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><strong>ì˜ìƒ ê¸¸ì´: @genOptions.SelectedDuration ì´ˆ</strong></label>
                            <input type="range" class="form-range" min="2" max="12" step="1" 
                                   value="@genOptions.SelectedDuration" @oninput="OnDurationInput" disabled="@isGenerating" />
                            <small class="text-muted">2ì´ˆ ~ 12ì´ˆ</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><strong>í™”ë©´ ë¹„ìœ¨:</strong></label>
                            <div class="btn-group d-flex" role="group">
                                <button type="button" class="btn @GetAspectClass("9:16")" @onclick='() => genOptions.SelectedAspectRatio = "9:16"' disabled="@isGenerating">
                                    ğŸ“± ì„¸ë¡œ (ì‡¼ì¸ )
                                </button>
                                <button type="button" class="btn @GetAspectClass("16:9")" @onclick='() => genOptions.SelectedAspectRatio = "16:9"' disabled="@isGenerating">
                                    ğŸ–¥ï¸ ê°€ë¡œ
                                </button>
                                <button type="button" class="btn @GetAspectClass("1:1")" @onclick='() => genOptions.SelectedAspectRatio = "1:1"' disabled="@isGenerating">
                                    â¬› ì •ì‚¬ê°í˜•
                                </button>
                            </div>
                        </div>

                        <!-- í”„ë¡¬í”„íŠ¸ CSV -->
                        <div class="mb-3">
                            <label class="form-label"><strong>í”„ë¡¬í”„íŠ¸ CSV íŒŒì¼:</strong></label>
                            <InputFile OnChange="HandleCsvSelection" accept=".csv,.txt" class="form-control" disabled="@isGenerating" />
                            <div class="form-text">ê° ì¤„ë§ˆë‹¤ í•˜ë‚˜ì˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•œ CSV íŒŒì¼</div>
                            
                            @if (genOptions.CsvPrompts.Count > 0)
                            {
                                <div class="alert alert-success mt-2">
                                    âœ… @genOptions.CsvPrompts.Count ê°œ í”„ë¡¬í”„íŠ¸ ë¡œë“œë¨
                                    <button type="button" class="btn btn-sm btn-primary ms-2" @onclick="() => showCsvPreview = true">ë¯¸ë¦¬ë³´ê¸°</button>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- ë¡œì»¬ íŒŒì¼ ì„ íƒ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ë¡œì»¬ ë¹„ë””ì˜¤ íŒŒì¼:</strong></label>
                            <InputFile OnChange="HandleLocalFileSelection" accept="video/*" multiple class="form-control" disabled="@isGenerating" />
                            <div class="form-text">í›„ì²˜ë¦¬í•  ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (ê°ê° ìµœëŒ€ 2GB)</div>

                            @if (genOptions.LocalVideoFiles.Count > 0)
                            {
                                <div class="alert alert-success mt-2">
                                    <strong>ì„ íƒëœ íŒŒì¼:</strong> @genOptions.LocalVideoFiles.Count ê°œ
                                    <ul class="mb-0 mt-2">
                                        @foreach (var file in genOptions.LocalVideoFiles.Take(5))
                                        {
                                            <li>@file.Name (@VideoGenerationService.FormatFileSize(file.Size))</li>
                                        }
                                        @if (genOptions.LocalVideoFiles.Count > 5)
                                        {
                                            <li>... ì™¸ @(genOptions.LocalVideoFiles.Count - 5)ê°œ ë”</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    }

                    <!-- í›„ì²˜ë¦¬ ì˜µì…˜ -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="postOptions.EnablePostProcessing" id="enablePostProcessing" disabled="@isGenerating">
                            <label class="form-check-label" for="enablePostProcessing">
                                <strong>ì˜ìƒ í›„ì²˜ë¦¬ ì‚¬ìš©</strong>
                            </label>
                        </div>
                    </div>

                    @if (postOptions.EnablePostProcessing)
                    {
                        <div class="card mb-3 bg-light">
                            <div class="card-body">
                                <h6>ğŸ¬ í›„ì²˜ë¦¬ ì˜µì…˜</h6>

                                <!-- ìº¡ì…˜ ì¶”ê°€ -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" @bind="postOptions.AddCaption" id="addCaption" disabled="@isGenerating">
                                        <label class="form-check-label" for="addCaption">ìº¡ì…˜ ì¶”ê°€</label>
                                    </div>
                                    
                                    @if (postOptions.AddCaption)
                                    {
                                        <div class="mt-2">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" @bind="postOptions.UseRandomCaption" 
                                                       @bind:after="OnRandomCaptionChanged" id="useRandomCaption" disabled="@isGenerating">
                                                <label class="form-check-label" for="useRandomCaption">
                                                    ëœë¤ ìº¡ì…˜ ì‚¬ìš© (CSV)
                                                </label>
                                            </div>

                                            @if (postOptions.UseRandomCaption)
                                            {
                                                <InputFile OnChange="HandleCaptionCsvSelection" accept=".csv,.txt" class="form-control form-control-sm mb-2" disabled="@isGenerating" />
                                                @if (postOptions.CaptionCsvList.Count > 0)
                                                {
                                                    <div class="alert alert-success">
                                                        âœ… @postOptions.CaptionCsvList.Count ê°œ ìº¡ì…˜ ë¡œë“œë¨
                                                        <button type="button" class="btn btn-sm btn-primary ms-2" @onclick="() => showCaptionCsvPreview = true">ë¯¸ë¦¬ë³´ê¸°</button>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <input type="text" class="form-control form-control-sm mb-2" @bind="postOptions.CaptionText" disabled="@isGenerating"
                                                       placeholder="ìº¡ì…˜ í…ìŠ¤íŠ¸ ì…ë ¥..." />
                                            }

                                            <div class="row mt-2">
                                                <div class="col-md-4">
                                                    <select class="form-select form-select-sm" @bind="postOptions.CaptionPosition" disabled="@isGenerating">
                                                        <option value="top">ìƒë‹¨</option>
                                                        <option value="center">ì¤‘ì•™</option>
                                                        <option value="bottom">í•˜ë‹¨</option>
                                                        <option value="random">ëœë¤</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <select class="form-select form-select-sm" @bind="postOptions.CaptionSize" disabled="@isGenerating">
                                                        <option value="60">ì‘ê²Œ</option>
                                                        <option value="80">ë³´í†µ</option>
                                                        <option value="120">í¬ê²Œ</option>
                                                        <option value="random">ëœë¤</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <select class="form-select form-select-sm" @bind="postOptions.CaptionColor" disabled="@isGenerating">
                                                        <option value="white">í°ìƒ‰</option>
                                                        <option value="yellow">ë…¸ë€ìƒ‰</option>
                                                        <option value="red">ë¹¨ê°„ìƒ‰</option>
                                                        <option value="black">ê²€ì€ìƒ‰</option>
                                                        <option value="random">ëœë¤</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>

                                <!-- ë°°ê²½ìŒì•… ì¶”ê°€ -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" @bind="postOptions.AddBackgroundMusic" id="addMusic" disabled="@isGenerating">
                                        <label class="form-check-label" for="addMusic">ë°°ê²½ìŒì•… ì¶”ê°€</label>
                                    </div>
                                    
                                    @if (postOptions.AddBackgroundMusic)
                                    {
                                        <div class="mt-2">
                                            <InputFile OnChange="HandleMusicFileSelection" accept="audio/*" multiple class="form-control form-control-sm mb-2" disabled="@isGenerating" />
                                            @if (postOptions.SelectedMusicFiles.Count > 0)
                                            {
                                                <div class="alert alert-success">
                                                    âœ… @postOptions.SelectedMusicFiles.Count ê°œ ìŒì•… íŒŒì¼ ì„ íƒë¨
                                                </div>
                                            }
                                            
                                            <label class="form-label">ë³¼ë¥¨: @((int)(postOptions.MusicVolume * 100))%</label>
                                            <input type="range" class="form-range" min="0" max="1" step="0.1" @bind="postOptions.MusicVolume" disabled="@isGenerating" />
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- ìƒì„± ë²„íŠ¼ -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" @onclick="StartVideoGeneration" disabled="@(!CanGenerate || isGenerating)">
                            @if (isGenerating)
                            {
                                <span>ìƒì„± ì¤‘...</span>
                            }
                            else
                            {
                                <span>ì˜ìƒ ìƒì„±í•˜ê¸°</span>
                            }
                        </button>
                    </div>

                    <!-- ì§„í–‰ë¥  í‘œì‹œ -->
                    @if (isGenerating)
                    {
                        <div class="mt-3">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     style="width: @(currentProgress)%"></div>
                            </div>
                            <div class="mt-2 text-info">@statusMessage</div>
                            @if (!string.IsNullOrEmpty(currentPromptUsed))
                            {
                                <div class="mt-1 text-muted small">ì‚¬ìš©ëœ í”„ë¡¬í”„íŠ¸: @currentPromptUsed</div>
                            }
                        </div>
                    }

                    <!-- ê²°ê³¼ í‘œì‹œ -->
                    @if (!string.IsNullOrEmpty(resultMessage))
                    {
                        <div class="alert alert-success mt-3">
                            <p>@resultMessage</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSV ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
@if (showCsvPreview)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h5>
                    <button type="button" class="btn-close" @onclick="() => showCsvPreview = false"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ì´ @genOptions.CsvPrompts.Count ê°œì˜ í”„ë¡¬í”„íŠ¸ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        @for (int i = 0; i < Math.Min(10, genOptions.CsvPrompts.Count); i++)
                        {
                            <div class="mb-2">
                                <strong>@(i + 1).</strong> @genOptions.CsvPrompts[i]
                            </div>
                        }
                        @if (genOptions.CsvPrompts.Count > 10)
                        {
                            <div class="text-muted">... ì™¸ @(genOptions.CsvPrompts.Count - 10) ê°œ ë”</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showCsvPreview = false">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- ìº¡ì…˜ CSV ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
@if (showCaptionCsvPreview)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ìº¡ì…˜ ë¯¸ë¦¬ë³´ê¸°</h5>
                    <button type="button" class="btn-close" @onclick="() => showCaptionCsvPreview = false"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ì´ @postOptions.CaptionCsvList.Count ê°œì˜ ìº¡ì…˜ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        @for (int i = 0; i < Math.Min(10, postOptions.CaptionCsvList.Count); i++)
                        {
                            <div class="mb-2">
                                <strong>@(i + 1).</strong> @postOptions.CaptionCsvList[i]
                            </div>
                        }
                        @if (postOptions.CaptionCsvList.Count > 10)
                        {
                            <div class="text-muted">... ì™¸ @(postOptions.CaptionCsvList.Count - 10) ê°œ ë”</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showCaptionCsvPreview = false">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // ğŸ”¥ í†µí•© ì„œë¹„ìŠ¤ ì‚¬ìš©
    private VideoGenerationService.VideoGenerationOptions genOptions = new();
    private VideoGenerationService.PostProcessingOptions postOptions = new();

    // UI ìƒíƒœ
    private bool isGenerating = false;
    private string resultMessage = "";
    private int currentProgress = 0;
    private string statusMessage = "";
    private string currentPromptUsed = "";
    private bool showCsvPreview = false;
    private bool showCaptionCsvPreview = false;

    private string totalCost => (genOptions.VideoCount * genOptions.SelectedDuration * 0.15m).ToString("F2");

    private bool CanGenerate
    {
        get
        {
            if (genOptions.IsGenerateVideo)
            {
                return genOptions.CsvPrompts.Count > 0 && 
                       !string.IsNullOrEmpty(ConfigManager.GetConfig().ReplicateApiKey);
            }
            else
            {
                return genOptions.LocalVideoFiles.Count > 0;
            }
        }
    }

    private string GetAspectClass(string ratio) => 
        genOptions.SelectedAspectRatio == ratio ? "btn-primary" : "btn-outline-secondary";

    private void OnDurationInput(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            genOptions.SelectedDuration = value;
        }
    }

    private void OnRandomCaptionChanged()
    {
        if (!postOptions.UseRandomCaption)
        {
            postOptions.CaptionCsvList.Clear();
        }
    }

    // CSV íŒŒì¼ ì²˜ë¦¬
    private async Task HandleCsvSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        try
        {
            using var stream = file.OpenReadStream();
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            genOptions.CsvPrompts = content
                .Split('\n')
                .Select(line => line.Trim())
                .Where(line => !string.IsNullOrEmpty(line))
                .ToList();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"CSV íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private async Task HandleCaptionCsvSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        try
        {
            using var stream = file.OpenReadStream();
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            postOptions.CaptionCsvList = content
                .Split('\n')
                .Select(line => line.Trim())
                .Where(line => !string.IsNullOrEmpty(line))
                .ToList();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ìº¡ì…˜ CSV íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private async Task HandleLocalFileSelection(InputFileChangeEventArgs e)
    {
        genOptions.LocalVideoFiles = e.GetMultipleFiles(10).ToList();
        StateHasChanged();
    }

    private async Task HandleMusicFileSelection(InputFileChangeEventArgs e)
    {
        postOptions.SelectedMusicFiles = e.GetMultipleFiles(10).ToList();
        StateHasChanged();
    }

    // ğŸ”¥ ë©”ì¸ ìƒì„± ë¡œì§ - ProcessingService ì‚¬ìš©
    private async Task StartVideoGeneration()
    {
        // ê²€ì¦
        var validation = ProcessingService.ValidateOptions(new VideoPostProcessingService.ProcessingOptions
        {
            GenerationOptions = genOptions,
            PostProcessingOptions = postOptions
        });

        if (!validation.IsValid)
        {
            await JSRuntime.InvokeVoidAsync("alert", validation.ErrorMessage);
            return;
        }

        // í›„ì²˜ë¦¬ í™•ì¸
        if (postOptions.EnablePostProcessing)
        {
            bool proceed = await JSRuntime.InvokeAsync<bool>("confirm", 
                "í›„ì²˜ë¦¬ë¥¼ ì‚¬ìš©í•˜ë©´ ì‹œê°„ì´ ë” ê±¸ë¦½ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (!proceed)
            {
                postOptions.EnablePostProcessing = false;
                return;
            }
        }

        isGenerating = true;
        resultMessage = "";
        currentProgress = 0;

        try
        {
            // ğŸ”¥ í†µí•© ì„œë¹„ìŠ¤ ì‚¬ìš©
            var options = new VideoPostProcessingService.ProcessingOptions
            {
                GenerationOptions = genOptions,
                PostProcessingOptions = postOptions
            };

            var results = await ProcessingService.ProcessVideosAsync(
                options,
                (current, total, status) => {
                    currentProgress = (current * 90 / total);
                    statusMessage = status;
                    currentPromptUsed = status;
                    StateHasChanged();
                }
            );

            // ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
            int successCount = 0;
            foreach (var result in results.Where(r => r.Success))
            {
                string downloadFileName = $"video_{DateTime.Now:yyyyMMdd_HHmmss}_{successCount + 1:D2}.mp4";
                await TriggerBrowserDownload(result.FilePath, downloadFileName);
                successCount++;
            }

            currentProgress = 100;
            resultMessage = $"âœ… ì´ {results.Count}ê°œ ì¤‘ {successCount}ê°œ ì˜ìƒ ìƒì„± ì™„ë£Œ!";
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ì˜ìƒ ìƒì„± ì˜¤ë¥˜: {ex.Message}");
            resultMessage = $"âŒ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task TriggerBrowserDownload(string filePath, string fileName)
    {
        try
        {
            if (!File.Exists(filePath))
            {
                Console.WriteLine($"íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {filePath}");
                return;
            }

            byte[] fileBytes = await File.ReadAllBytesAsync(filePath);
            string base64String = Convert.ToBase64String(fileBytes);
            
            fileBytes = null;
            GC.Collect();
            
            string dataUrl = $"data:video/mp4;base64,{base64String}";
            bool success = await JSRuntime.InvokeAsync<bool>("downloadFile", dataUrl, fileName);
            
            if (!success)
            {
                throw new Exception("ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì‹¤í–‰ ì‹¤íŒ¨");
            }
        }
        catch (OutOfMemoryException)
        {
            await JSRuntime.InvokeVoidAsync("alert", "ë©”ëª¨ë¦¬ ë¶€ì¡±ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: {ex.Message}");
        }
    }
}
