@page "/video-generator"
@rendermode InteractiveServer
@using YouTubeShortsWebApp
@using YouTubeShortsWebApp.Services
@using System.Diagnostics
@using System.IO
@inject IJSRuntime JSRuntime
@inject VideoGenerationService VideoGenService

<PageTitle>ë¹„ë””ì˜¤ ìƒì„±ê¸°</PageTitle>

<h1>YouTube Shorts ìƒì„±ê¸°</h1>

<div class="container">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3>ë¹„ë””ì˜¤ ìƒì„± ì˜µì…˜</h3>
                </div>
                <div class="card-body">
                    @if (genOptions.IsGenerateVideo && string.IsNullOrEmpty(ConfigManager.GetConfig().ReplicateApiKey))
                    {
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <strong>âš ï¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</strong>
                            <p class="mb-2 mt-2">AI ì˜ìƒ ìƒì„±ì„ ì‚¬ìš©í•˜ë ¤ë©´ Replicate API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                            <div class="d-flex gap-2">
                                <a href="/settings" class="btn btn-sm btn-warning">âš™ï¸ ì„¤ì •í•˜ëŸ¬ ê°€ê¸°</a>
                                <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => genOptions.IsGenerateVideo = false">
                                    ğŸ“ ë¡œì»¬ íŒŒì¼ ëª¨ë“œë¡œ ì „í™˜
                                </button>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    <!-- ì˜ìƒ ì†ŒìŠ¤ ì„ íƒ -->
                    <div class="mb-4">
                        <label class="form-label"><strong>ì˜ìƒ ì†ŒìŠ¤:</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoSource" id="generateNewVideo"
                                   @onchange="() => genOptions.IsGenerateVideo = true" checked="@genOptions.IsGenerateVideo" disabled="@isGenerating">
                            <label class="form-check-label" for="generateNewVideo">
                                <strong>ìƒˆë¡œ ìƒì„±</strong> - AIë¡œ ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoSource" id="useLocalFiles"
                                   @onchange="() => genOptions.IsGenerateVideo = false" checked="@(!genOptions.IsGenerateVideo)" disabled="@isGenerating">
                            <label class="form-check-label" for="useLocalFiles">
                                <strong>ë¡œì»¬ íŒŒì¼ ì‚¬ìš©</strong> - ê¸°ì¡´ì— ìˆëŠ” ì˜ìƒ íŒŒì¼ë“¤ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
                            </label>
                        </div>
                    </div>

                    @if (!genOptions.IsGenerateVideo)
                    {
                        <!-- ë¡œì»¬ íŒŒì¼ ì„ íƒ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ë¡œì»¬ ì˜ìƒ íŒŒì¼ë“¤:</strong></label>
                            <InputFile OnChange="HandleLocalVideoSelection" accept="video/*" multiple class="form-control" disabled="@isGenerating" />
                            <div class="form-text">í•˜ë‚˜ ë˜ëŠ” ì—¬ëŸ¬ ê°œì˜ ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (ê°ê° ìµœëŒ€ 2GB)</div>

                            @if (genOptions.LocalVideoFiles.Count > 0)
                            {
                                <div class="mt-2 alert alert-success">
                                    <strong>ì„ íƒëœ íŒŒì¼:</strong> @genOptions.LocalVideoFiles.Count ê°œ
                                    <ul class="mb-0 mt-2">
                                        @foreach (var file in genOptions.LocalVideoFiles.Take(5))
                                        {
                                            <li>@file.Name (@VideoGenerationService.FormatFileSize(file.Size))</li>
                                        }
                                        @if (genOptions.LocalVideoFiles.Count > 5)
                                        {
                                            <li>... ì™¸ @(genOptions.LocalVideoFiles.Count - 5)ê°œ ë”</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    }

                    @if (genOptions.IsGenerateVideo)
                    {
                        <!-- ìƒì„± ê°œìˆ˜ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ìƒì„±í•  ì˜ìƒ ê°œìˆ˜: @genOptions.VideoCount ê°œ</strong></label>
                            <input type="range" class="form-range" min="1" max="5" @bind="genOptions.VideoCount" disabled="@isGenerating" />
                            <div class="text-primary">ì´ ë¹„ìš©: $@totalCost</div>
                        </div>

                        <!-- ì˜ìƒ ê¸¸ì´ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>ì˜ìƒ ê¸¸ì´:</strong></label>
                            <div>
                                <button type="button" class="btn @GetDurationClass(5)" @onclick="() => genOptions.SelectedDuration = 5" disabled="@isGenerating">5ì´ˆ</button>
                                <button type="button" class="btn @GetDurationClass(10)" @onclick="() => genOptions.SelectedDuration = 10" disabled="@isGenerating">10ì´ˆ</button>
                            </div>
                        </div>

                        <!-- í™”ë©´ ë¹„ìœ¨ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>í™”ë©´ ë¹„ìœ¨:</strong></label>
                            <div>
                                <button type="button" class="btn @GetAspectClass("9:16")" @onclick="@(() => genOptions.SelectedAspectRatio = "9:16")" disabled="@isGenerating">9:16 (ìˆí¼)</button>
                                <button type="button" class="btn @GetAspectClass("16:9")" @onclick="@(() => genOptions.SelectedAspectRatio = "16:9")" disabled="@isGenerating">16:9</button>
                                <button type="button" class="btn @GetAspectClass("1:1")" @onclick="@(() => genOptions.SelectedAspectRatio = "1:1")" disabled="@isGenerating">1:1</button>
                            </div>
                        </div>

                        <!-- í”„ë¡¬í”„íŠ¸ ì…ë ¥ ë°©ì‹ ì„ íƒ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>í”„ë¡¬í”„íŠ¸ ì…ë ¥ ë°©ì‹:</strong></label>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="promptMode" id="directInput"
                                           @onchange="() => isRandomPromptMode = false" checked="@(!isRandomPromptMode)" disabled="@isGenerating" />
                                    <label class="form-check-label" for="directInput">
                                        ì§ì ‘ ì…ë ¥
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="promptMode" id="randomPrompt"
                                           @onchange="() => isRandomPromptMode = true" checked="@isRandomPromptMode" disabled="@isGenerating" />
                                    <label class="form-check-label" for="randomPrompt">
                                        ëœë¤ í”„ë¡¬í”„íŠ¸ (CSV íŒŒì¼)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- CSV íŒŒì¼ ì—…ë¡œë“œ -->
                        @if (isRandomPromptMode)
                        {
                            <div class="mb-3">
                                <label class="form-label"><strong>í”„ë¡¬í”„íŠ¸ CSV íŒŒì¼:</strong></label>
                                <InputFile OnChange="HandleCsvFileSelection" accept=".csv" class="form-control" disabled="@isGenerating" />
                                <div class="form-text">CSV íŒŒì¼ í˜•ì‹: ì²« ë²ˆì§¸ ì—´ì€ ë²ˆí˜¸, ë‘ ë²ˆì§¸ ì—´ì€ í”„ë¡¬í”„íŠ¸ ë‚´ìš©</div>

                                @if (genOptions.CsvPrompts.Count > 0)
                                {
                                    <div class="mt-2 alert alert-success">
                                        <strong>ë¡œë“œëœ í”„ë¡¬í”„íŠ¸:</strong> @genOptions.CsvPrompts.Count ê°œ
                                        <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="ShowCsvPreview" disabled="@isGenerating">
                                            ë¯¸ë¦¬ë³´ê¸°
                                        </button>
                                    </div>
                                }
                            </div>
                        }

                        <!-- í”„ë¡¬í”„íŠ¸ ì…ë ¥ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>í”„ë¡¬í”„íŠ¸:</strong></label>
                            @if (isRandomPromptMode)
                            {
                                <textarea class="form-control" rows="4" readonly
                                  placeholder="ëœë¤ í”„ë¡¬í”„íŠ¸ ëª¨ë“œ: CSV íŒŒì¼ì—ì„œ ìë™ìœ¼ë¡œ ì„ íƒë©ë‹ˆë‹¤."></textarea>
                            }
                            else
                            {
                                <textarea class="form-control" rows="4" @bind="userPrompt" disabled="@isGenerating"
                                          placeholder="ì˜ìƒì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            }
                        </div>
                        <!-- í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì„¹ì…˜ ì•„ë˜, "ì˜ìƒ ê°œìˆ˜" ìœ„ì— ì¶”ê°€ -->
                        @if (genOptions.IsGenerateVideo)
                        {
                            <!-- ğŸ”¥ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­) -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <strong>ğŸ“· ì†ŒìŠ¤ ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­):</strong>
                                </label>
                                <InputFile OnChange="HandleSourceImageSelection" accept="image/*" class="form-control" disabled="@isGenerating" />
                                <div class="form-text">
                                    ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜ìƒì´ ìƒì„±ë©ë‹ˆë‹¤. (ìµœëŒ€ 10MB, ì„ íƒì‚¬í•­)
                                </div>
                                
                                @if (genOptions.SourceImageFile != null)
                                {
                                    <div class="mt-2 alert alert-success d-flex justify-content-between align-items-center">
                                        <span>
                                            <strong>âœ… ì„ íƒëœ ì´ë¯¸ì§€:</strong> @genOptions.SourceImageFile.Name 
                                            (@VideoGenerationService.FormatFileSize(genOptions.SourceImageFile.Size))
                                        </span>
                                        <button type="button" class="btn btn-sm btn-danger" @onclick="ClearSourceImage" disabled="@isGenerating">
                                            ì‚­ì œ
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <!-- ë¡œì»¬ íŒŒì¼ ëª¨ë“œ ì•ˆë‚´ -->
                        <div class="mb-3">
                            <div class="alert alert-info">
                                <strong>ë¡œì»¬ íŒŒì¼ ëª¨ë“œ:</strong> ì„ íƒëœ íŒŒì¼ë“¤ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                                ì˜ìƒ ê°œìˆ˜, ê¸¸ì´, í™”ë©´ ë¹„ìœ¨ì€ ì›ë³¸ íŒŒì¼ì— ë”°ë¼ ê²°ì •ë©ë‹ˆë‹¤.
                            </div>
                        </div>
                    }

                    <!-- ì˜ìƒ í›„ì²˜ë¦¬ ì˜µì…˜ -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="postOptions.EnablePostProcessing" id="enablePostProcessing" disabled="@isGenerating">
                            <label class="form-check-label" for="enablePostProcessing">
                                <strong>ì˜ìƒ í›„ì²˜ë¦¬ ì‚¬ìš©</strong>
                            </label>
                        </div>
                    </div>

                    @if (postOptions.EnablePostProcessing)
                    {
                        <div class="card mb-3 bg-light">
                            <div class="card-body">
                                <h6>ğŸ¬ í›„ì²˜ë¦¬ ì˜µì…˜</h6>

                                <!-- ìº¡ì…˜ ì„¤ì • -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" @bind="postOptions.AddCaption" id="addCaption" disabled="@isGenerating">
                                        <label class="form-check-label" for="addCaption">
                                            ìº¡ì…˜ ì¶”ê°€
                                        </label>
                                    </div>
                                    @if (postOptions.AddCaption)
                                    {
                                        <div class="mt-2">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" @bind="postOptions.UseRandomCaption" @bind:after="OnRandomCaptionChanged" id="useRandomCaption" disabled="@isGenerating">
                                                <label class="form-check-label" for="useRandomCaption">
                                                    <strong>ëœë¤ ìº¡ì…˜ (CSV íŒŒì¼)</strong>
                                                </label>
                                            </div>
                                    
                                            @if (postOptions.UseRandomCaption)
                                            {
                                                <div class="mb-2">
                                                    <label class="form-label form-label-sm">ìº¡ì…˜ CSV íŒŒì¼:</label>
                                                    <InputFile OnChange="HandleCaptionCsvSelection" accept=".csv" class="form-control form-control-sm" disabled="@isGenerating" />
                                                    <div class="form-text">CSV í˜•ì‹: ì²« ë²ˆì§¸ ì—´ì€ ë²ˆí˜¸, ë‘ ë²ˆì§¸ ì—´ì€ ìº¡ì…˜ í…ìŠ¤íŠ¸</div>
                                                    
                                                    @if (postOptions.CaptionCsvList.Count > 0)
                                                    {
                                                        <div class="mt-1 alert alert-success py-1 px-2 small">
                                                            âœ“ @postOptions.CaptionCsvList.Count ê°œ ìº¡ì…˜ ë¡œë“œë¨
                                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="ShowCaptionCsvPreview" disabled="@isGenerating">
                                                                ë¯¸ë¦¬ë³´ê¸°
                                                            </button>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <input type="text" class="form-control form-control-sm mb-2" @bind="postOptions.CaptionText" disabled="@isGenerating"
                                                       placeholder="ìº¡ì…˜ í…ìŠ¤íŠ¸ ì…ë ¥..." />
                                            }
                                    
                                            <div class="row mt-2">
                                                <div class="col-md-4">
                                                    <select class="form-select form-select-sm" @bind="postOptions.CaptionPosition" disabled="@isGenerating">
                                                        <option value="top">ìƒë‹¨</option>
                                                        <option value="center">ì¤‘ì•™</option>
                                                        <option value="bottom">í•˜ë‹¨</option>
                                                        <option value="random">ëœë¤</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <select class="form-select form-select-sm" @bind="postOptions.CaptionSize" disabled="@isGenerating">
                                                        <option value="60">ì‘ê²Œ</option>
                                                        <option value="80">ë³´í†µ</option>
                                                        <option value="120">í¬ê²Œ</option>
                                                        <option value="random">ëœë¤</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <select class="form-select form-select-sm" @bind="postOptions.CaptionColor" disabled="@isGenerating">
                                                        <option value="white">í°ìƒ‰</option>
                                                        <option value="yellow">ë…¸ë€ìƒ‰</option>
                                                        <option value="red">ë¹¨ê°„ìƒ‰</option>
                                                        <option value="black">ê²€ì •ìƒ‰</option>
                                                        <option value="random">ëœë¤</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                                     
                                </div>
                                <!-- ë°°ê²½ìŒì•… ì„¤ì • -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" @bind="postOptions.AddBackgroundMusic" id="addBackgroundMusic" disabled="@isGenerating">
                                        <label class="form-check-label" for="addBackgroundMusic">
                                            ë°°ê²½ìŒì•… ì¶”ê°€
                                        </label>
                                    </div>
                                    @if (postOptions.AddBackgroundMusic)
                                    {
                                        <div class="mt-2">
                                            <div class="mb-2">
                                                <label class="form-label form-label-sm">ë°°ê²½ìŒì•… íŒŒì¼ë“¤:</label>
                                                <InputFile OnChange="HandleMusicFileSelection" accept="audio/*" multiple class="form-control form-control-sm" disabled="@isGenerating" />
                                                <div class="form-text">ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥. ì§€ì› í˜•ì‹: MP3, WAV, M4A, AAC (ê° ìµœëŒ€ 10MB)</div>
                                                
                                                @if (postOptions.SelectedMusicFiles.Count > 0)
                                                {
                                                    <div class="mt-1 alert alert-success py-1 px-2 small">
                                                        âœ“ @postOptions.SelectedMusicFiles.Count ê°œ íŒŒì¼ ì„ íƒë¨
                                                        <ul class="mb-0 mt-1">
                                                            @foreach (var file in postOptions.SelectedMusicFiles.Take(3))
                                                            {
                                                                <li>@file.Name (@VideoGenerationService.FormatFileSize(file.Size))</li>
                                                            }
                                                            @if (postOptions.SelectedMusicFiles.Count > 3)
                                                            {
                                                                <li>... ì™¸ @(postOptions.SelectedMusicFiles.Count - 3)ê°œ ë”</li>
                                                            }
                                                        </ul>
                                                    </div>
                                                }
                                            </div>
                                            <label class="form-label form-label-sm">ìŒëŸ‰: @postOptions.MusicVolume</label>
                                            <input type="range" class="form-range" min="0.1" max="1.0" step="0.1"
                                                   @bind="postOptions.MusicVolume" disabled="@isGenerating" />
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- ìƒì„± ë²„íŠ¼ -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" @onclick="StartVideoGeneration" disabled="@isGenerating">
                            @if (isGenerating)
                            {
                                <span>ìƒì„± ì¤‘...</span>
                            }
                            else
                            {
                                <span>ì˜ìƒ ìƒì„±í•˜ê¸°</span>
                            }
                        </button>
                    </div>

                    <!-- ì§„í–‰ë¥  í‘œì‹œ -->
                    @if (isGenerating)
                    {
                        <div class="mt-3">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     style="width: @(currentProgress)%"></div>
                            </div>
                            <div class="mt-2 text-info">@statusMessage</div>
                            @if (!string.IsNullOrEmpty(currentPromptUsed))
                            {
                                <div class="mt-1 text-muted small">ì‚¬ìš©ëœ í”„ë¡¬í”„íŠ¸: @currentPromptUsed</div>
                            }
                        </div>
                    }

                    <!-- ê²°ê³¼ í‘œì‹œ -->
                    @if (!string.IsNullOrEmpty(resultMessage))
                    {
                        <div class="alert alert-success mt-3">
                            <p>@resultMessage</p>
                            @if (!string.IsNullOrEmpty(lastVideoUrl))
                            {
                                <button class="btn btn-primary mt-2" @onclick="DownloadLastVideo">
                                    ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ
                                </button>
                            }
                        </div>
                    }

                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSV ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
@if (showCsvPreview)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h5>
                    <button type="button" class="btn-close" @onclick="() => showCsvPreview = false"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ì´ @genOptions.CsvPrompts.Count ê°œì˜ í”„ë¡¬í”„íŠ¸ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        @for (int i = 0; i < Math.Min(10, genOptions.CsvPrompts.Count); i++)
                        {
                            <div class="mb-2">
                                <strong>@(i + 1).</strong> @genOptions.CsvPrompts[i]
                            </div>
                        }
                        @if (genOptions.CsvPrompts.Count > 10)
                        {
                            <div class="text-muted">... ì™¸ @(genOptions.CsvPrompts.Count - 10) ê°œ ë”</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showCsvPreview = false">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- ìº¡ì…˜ CSV ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
@if (showCaptionCsvPreview)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ìº¡ì…˜ ë¯¸ë¦¬ë³´ê¸°</h5>
                    <button type="button" class="btn-close" @onclick="() => showCaptionCsvPreview = false"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ì´ @postOptions.CaptionCsvList.Count ê°œì˜ ìº¡ì…˜ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        @for (int i = 0; i < Math.Min(10, postOptions.CaptionCsvList.Count); i++)
                        {
                            <div class="mb-2">
                                <strong>@(i + 1).</strong> @postOptions.CaptionCsvList[i]
                            </div>
                        }
                        @if (postOptions.CaptionCsvList.Count > 10)
                        {
                            <div class="text-muted">... ì™¸ @(postOptions.CaptionCsvList.Count - 10) ê°œ ë”</div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showCaptionCsvPreview = false">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    // ğŸ”¥ ì„œë¹„ìŠ¤ì˜ Options í´ë˜ìŠ¤ ì‚¬ìš©
    private VideoGenerationService.VideoGenerationOptions genOptions = new();
    private VideoGenerationService.PostProcessingOptions postOptions = new();

    // UI ìƒíƒœ
    private bool isGenerating = false;
    private string resultMessage = "";
    private int currentProgress = 0;
    private string statusMessage = "";
    private string lastVideoUrl = "";
    private string lastFileName = "";
    private string currentPromptUsed = "";

    // í”„ë¡¬í”„íŠ¸ ê´€ë ¨
    private bool isRandomPromptMode = false;
    private string userPrompt = "";
    private bool showCsvPreview = false;
    private bool showCaptionCsvPreview = false;

    private string totalCost => (genOptions.VideoCount * (genOptions.SelectedDuration == 5 ? 0.75m : 1.5m)).ToString("F2");

    private string GetDurationClass(int duration) => genOptions.SelectedDuration == duration ? "btn-primary" : "btn-outline-primary";
    private string GetAspectClass(string ratio) => genOptions.SelectedAspectRatio == ratio ? "btn-success" : "btn-outline-success";

    private async Task HandleLocalVideoSelection(InputFileChangeEventArgs e)
    {
        genOptions.LocalVideoFiles.Clear();
        genOptions.LocalVideoFiles.AddRange(e.GetMultipleFiles(10));

        const long maxSizePerFile = 2L * 1024 * 1024 * 1024;
        var invalidFiles = genOptions.LocalVideoFiles.Where(f => f.Size > maxSizePerFile).ToList();

        if (invalidFiles.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert",
                $"ë‹¤ìŒ íŒŒì¼ë“¤ì´ 2GBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤:\n{string.Join("\n", invalidFiles.Select(f => f.Name))}");
            genOptions.LocalVideoFiles = genOptions.LocalVideoFiles.Where(f => f.Size <= maxSizePerFile).ToList();
        }

        if (!genOptions.IsGenerateVideo && genOptions.LocalVideoFiles.Count > 0)
        {
            genOptions.VideoCount = genOptions.LocalVideoFiles.Count;
        }

        StateHasChanged();
    }

    private async Task HandleCsvFileSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        try
        {
            const long maxSize = 5 * 1024 * 1024;
            if (file.Size > maxSize)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            using var stream = file.OpenReadStream(maxSize);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            genOptions.CsvPrompts = VideoGenService.ParseCsvContent(content);

            if (genOptions.CsvPrompts.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì—ì„œ ìœ íš¨í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {ex.Message}");
            genOptions.CsvPrompts.Clear();
        }
    }


    // ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬ ì¶”ê°€
    private async Task HandleSourceImageSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
    
        try
        {
            const long maxSize = 10 * 1024 * 1024; // 10MB
            if (file.Size > maxSize)
            {
                await JSRuntime.InvokeVoidAsync("alert", "ì´ë¯¸ì§€ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
    
            string[] supportedTypes = { "image/jpeg", "image/jpg", "image/png", "image/webp" };
            if (!supportedTypes.Contains(file.ContentType.ToLower()))
            {
                await JSRuntime.InvokeVoidAsync("alert", "ì§€ì›ë˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹ì…ë‹ˆë‹¤. JPG, PNG, WEBP íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }
    
            genOptions.SourceImageFile = file;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì˜¤ë¥˜: {ex.Message}");
            genOptions.SourceImageFile = null;
        }
    }
    
    private void ClearSourceImage()
    {
        genOptions.SourceImageFile = null;
        StateHasChanged();
    }
    

    private void ShowCsvPreview()
    {
        showCsvPreview = true;
    }

    private void OnRandomCaptionChanged()
    {
        if (!postOptions.UseRandomCaption)
        {
            postOptions.CaptionCsvList.Clear();
        }
    }
    
    private async Task HandleCaptionCsvSelection(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
    
        try
        {
            const long maxSize = 5 * 1024 * 1024;
            if (file.Size > maxSize)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
    
            using var stream = file.OpenReadStream(maxSize);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();
    
            postOptions.CaptionCsvList = VideoGenService.ParseCsvContent(content);
    
            if (postOptions.CaptionCsvList.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "CSV íŒŒì¼ì—ì„œ ìœ íš¨í•œ ìº¡ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {ex.Message}");
            postOptions.CaptionCsvList.Clear();
        }
    }
    
    private void ShowCaptionCsvPreview()
    {
        showCaptionCsvPreview = true;
    }

    private async Task HandleMusicFileSelection(InputFileChangeEventArgs e)
    {
        postOptions.SelectedMusicFiles.Clear();
        
        var files = e.GetMultipleFiles(10);
        
        try
        {
            const long maxSize = 10 * 1024 * 1024;
            
            foreach (var file in files)
            {
                if (file.Size > maxSize)
                {
                    await JSRuntime.InvokeVoidAsync("alert", $"{file.Name}ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    continue;
                }
    
                string[] supportedTypes = { "audio/mpeg", "audio/mp3", "audio/wav", "audio/mp4", "audio/aac" };
                if (!supportedTypes.Contains(file.ContentType.ToLower()) && 
                    !file.Name.ToLower().EndsWith(".mp3") && 
                    !file.Name.ToLower().EndsWith(".wav") && 
                    !file.Name.ToLower().EndsWith(".m4a") && 
                    !file.Name.ToLower().EndsWith(".aac"))
                {
                    await JSRuntime.InvokeVoidAsync("alert", $"{file.Name}ì€ ì§€ì›ë˜ì§€ ì•ŠëŠ” í˜•ì‹ì…ë‹ˆë‹¤.");
                    continue;
                }
                
                postOptions.SelectedMusicFiles.Add(file);
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"ìŒì•… íŒŒì¼ ì„ íƒ ì˜¤ë¥˜: {ex.Message}");
            postOptions.SelectedMusicFiles.Clear();
        }
    
        StateHasChanged();
    }

    private async Task StartVideoGeneration()
    {
        // ğŸ”¥ API í‚¤ ê²€ì¦ ê°œì„ 
        if (genOptions.IsGenerateVideo)
        {
            var config = ConfigManager.GetConfig();
            if (string.IsNullOrEmpty(config.ReplicateApiKey))
            {
                bool useLocal = await JSRuntime.InvokeAsync<bool>("confirm",
                    "âš ï¸ Replicate API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n" +
                    "AI ì˜ìƒ ìƒì„±ì„ í•˜ë ¤ë©´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n" +
                    "â€¢ [í™•ì¸] â†’ ë¡œì»¬ íŒŒì¼ ì‚¬ìš© ëª¨ë“œë¡œ ì „í™˜\n" +
                    "â€¢ [ì·¨ì†Œ] â†’ ê¸°ë³¸ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™\n\n" +
                    "ë¡œì»¬ íŒŒì¼ ì‚¬ìš© ëª¨ë“œë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                
                if (useLocal)
                {
                    // ë¡œì»¬ íŒŒì¼ ëª¨ë“œë¡œ ì „í™˜
                    genOptions.IsGenerateVideo = false;
                    StateHasChanged();
                    await JSRuntime.InvokeVoidAsync("alert", 
                        "ğŸ“ ë¡œì»¬ íŒŒì¼ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                        "ì´ì œ ì²˜ë¦¬í•  ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                else
                {
                    // ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™
                    await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/settings'");
                    return;
                }
            }
            
            if (isRandomPromptMode && genOptions.CsvPrompts.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "ë¨¼ì € CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
                return;
            }
            else if (!isRandomPromptMode && string.IsNullOrWhiteSpace(userPrompt))
            {
                await JSRuntime.InvokeVoidAsync("alert", "í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            
            // ì§ì ‘ ì…ë ¥ ëª¨ë“œì¼ ë•ŒëŠ” userPromptë¥¼ CsvPromptsì— ì¶”ê°€
            if (!isRandomPromptMode)
            {
                genOptions.CsvPrompts = new List<string> { userPrompt };
            }
        }
        else if (genOptions.LocalVideoFiles.Count == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", 
                "ğŸ“ ì²˜ë¦¬í•  ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!\n\n" +
                "ë¡œì»¬ íŒŒì¼ ì‚¬ìš© ëª¨ë“œì—ì„œëŠ” ì§ì ‘ ì˜ìƒ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }
    
        if (postOptions.EnablePostProcessing && postOptions.AddCaption && postOptions.UseRandomCaption && postOptions.CaptionCsvList.Count == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "ëœë¤ ìº¡ì…˜ì„ ì‚¬ìš©í•˜ë ¤ë©´ ìº¡ì…˜ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
            return;
        }
        
        if (postOptions.EnablePostProcessing)
        {
            if (postOptions.AddCaption && !postOptions.UseRandomCaption && string.IsNullOrWhiteSpace(postOptions.CaptionText))
            {
                await JSRuntime.InvokeVoidAsync("alert", "ìº¡ì…˜ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
        
            bool ffmpegAvailable = await VideoPostProcessor.IsFFmpegAvailableAsync();
            if (!ffmpegAvailable)
            {
                bool proceed = await JSRuntime.InvokeAsync<bool>("confirm",
                    "FFmpegë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ í›„ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní›„ì²˜ë¦¬ ì—†ì´ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                if (!proceed) return;
                postOptions.EnablePostProcessing = false;
            }
        }

        isGenerating = true;
        resultMessage = "";
        lastVideoUrl = "";

        try
        {
            int totalVideos = genOptions.IsGenerateVideo ? genOptions.VideoCount : genOptions.LocalVideoFiles.Count;
            List<string> generatedUrls = new List<string>();

            for (int i = 0; i < totalVideos; i++)
            {
                try
                {
                    currentProgress = (i * 80 / totalVideos) + 10;
                    
                    // ğŸ”¥ ì„œë¹„ìŠ¤ ì‚¬ìš©
                    var result = await VideoGenService.GenerateOrProcessVideoAsync(
                        i + 1,
                        genOptions,
                        postOptions,
                        (status) => {
                            statusMessage = status;
                            currentPromptUsed = status;
                            StateHasChanged();
                        }
                    );

                    if (result.Success)
                    {
                        // ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ
                        string downloadFileName = $"video_{DateTime.Now:yyyyMMdd_HHmmss}_{i + 1:D2}.mp4";
                        await TriggerBrowserDownload(result.VideoPath, downloadFileName);
                        
                        // íˆìŠ¤í† ë¦¬ ì €ì¥
                        var historyItem = VideoGenService.CreateHistoryItem(
                            result, 
                            genOptions, 
                            postOptions.EnablePostProcessing ? "í›„ì²˜ë¦¬ ì™„ë£Œ" : "ì™„ë£Œ"
                        );
                        historyItem.IsDownloaded = true;
                        VideoHistoryManager.AddHistoryItem(historyItem);
                        
                        if (!string.IsNullOrEmpty(result.VideoUrl))
                        {
                            generatedUrls.Add(result.VideoUrl);
                            lastVideoUrl = result.VideoUrl;
                        }
                        
                        // íŒŒì¼ ì‚­ì œ
                        try
                        {
                            if (File.Exists(result.VideoPath))
                            {
                                File.Delete(result.VideoPath);
                            }
                        }
                        catch { }
                    }
                    else
                    {
                        await JSRuntime.InvokeVoidAsync("alert", $"ì˜ìƒ {i + 1} ì²˜ë¦¬ ì‹¤íŒ¨: {result.ErrorMessage}");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"ì˜ìƒ {i + 1} ì²˜ë¦¬ ì‹¤íŒ¨: {ex.Message}");
                    await JSRuntime.InvokeVoidAsync("alert", $"ì˜ìƒ {i + 1} ì²˜ë¦¬ ì‹¤íŒ¨: {ex.Message}");
                }

                StateHasChanged();
            }

            currentProgress = 100;
            statusMessage = "ëª¨ë“  ì˜ìƒ ì²˜ë¦¬ ì™„ë£Œ!";

            string modeText = genOptions.IsGenerateVideo ? (isRandomPromptMode ? " (ëœë¤ í”„ë¡¬í”„íŠ¸)" : " (AI ìƒì„±)") : " (ë¡œì»¬ íŒŒì¼ ì²˜ë¦¬)";
            string processText = postOptions.EnablePostProcessing ? " (í›„ì²˜ë¦¬ í¬í•¨)" : "";

            int successCount = genOptions.IsGenerateVideo ? generatedUrls.Count : genOptions.LocalVideoFiles.Count;
            resultMessage = $"{successCount}ê°œì˜ ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ {(genOptions.IsGenerateVideo ? "ìƒì„±ë˜ê³ " : "ì²˜ë¦¬ë˜ê³ ")} ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!{modeText}{processText}";

            isGenerating = false;
        }
        catch (Exception ex)
        {
            isGenerating = false;
            currentProgress = 0;
            statusMessage = "";
            currentPromptUsed = "";
            await JSRuntime.InvokeVoidAsync("alert", $"ì˜ìƒ ì²˜ë¦¬ ì‹¤íŒ¨: {ex.Message}");
        }
    }

    private async Task TriggerBrowserDownload(string filePath, string fileName)
    {
        try
        {
            var fileInfo = new FileInfo(filePath);
            
            if (fileInfo.Length * 2 > 200 * 1024 * 1024)
            {
                await JSRuntime.InvokeVoidAsync("alert", 
                    "íŒŒì¼ì´ ë„ˆë¬´ ì»¤ì„œ ë©”ëª¨ë¦¬ ì œí•œìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            byte[] fileBytes = await File.ReadAllBytesAsync(filePath);
            string base64String = Convert.ToBase64String(fileBytes);
            
            fileBytes = null;
            GC.Collect();
            
            string dataUrl = $"data:video/mp4;base64,{base64String}";
            bool success = await JSRuntime.InvokeAsync<bool>("downloadFile", dataUrl, fileName);
            
            if (!success)
            {
                throw new Exception("ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì‹¤í–‰ ì‹¤íŒ¨");
            }
        }
        catch (OutOfMemoryException)
        {
            await JSRuntime.InvokeVoidAsync("alert", "ë©”ëª¨ë¦¬ ë¶€ì¡±ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    private async Task DownloadLastVideo()
    {
        if (!string.IsNullOrEmpty(lastVideoUrl))
        {
            string fileName = $"generated_video_{DateTime.Now:yyyyMMdd_HHmmss}.mp4";
            bool success = await JSRuntime.InvokeAsync<bool>("downloadFile", lastVideoUrl, fileName);
        }
    }
}
